<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Creating a Slackbot for Google Analytics reports • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Creating a Slackbot for Google Analytics reports">
<meta property="og:description" content="googleCloudRunner">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.4.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fas fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fas fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fas fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
    <li>
      <a href="../articles/usecase-slackbot-google-analytics.html">Create a Slackbot downloading Google Analytics</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="usecase-slackbot-google-analytics_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Creating a Slackbot for Google Analytics reports</h1>
            
            <h4 class="date">2021-03-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/master/vignettes/usecase-slackbot-google-analytics.Rmd"><code>vignettes/usecase-slackbot-google-analytics.Rmd</code></a></small>
      <div class="hidden name"><code>usecase-slackbot-google-analytics.Rmd</code></div>

    </div>

    
    
<p>This use case will use Cloud Run to create an R API that Slack can interact with.</p>
<p>The application will download some information from Google Analytics and send it to Slack for review. I’m most interested in what new websites are linking to my blog so will fetch that data for the endpoint, but this can be adapted upon for your own needs.</p>
<p>The workflow needed is:</p>
<ol style="list-style-type: decimal">
<li>Create the R script for downloading the GA data</li>
<li>Create a plumber script for wrapping the GA fetch into a webhook</li>
<li>Deploying the plumber API for Cloud Run to generate the webhook URL</li>
<li>Setting up a build trigger to redeploy the R script on each git commit</li>
<li>Creating a Slack App to respond to the Cloud Run webhook</li>
<li>Modifying the R script to get the right format for Slack</li>
<li>Scheduling</li>
</ol>
<div id="create-the-r-script-for-downloading-the-ga-data" class="section level2">
<h2 class="hasAnchor">
<a href="#create-the-r-script-for-downloading-the-ga-data" class="anchor"></a>Create the R script for downloading the GA data</h2>
<p>This will use <code>googleAnalyticsR</code> to get the data. I want to see what sessions came in the last 30 days with a referrer I haven’t seen before in the previous year.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">googleAnalyticsR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">ga_id</span> <span class="op">&lt;-</span> <span class="fl">12345678</span>

<span class="co"># get last years referrer data</span>
<span class="va">two_years</span> <span class="op">&lt;-</span> <span class="fu">google_analytics</span><span class="op">(</span>
  <span class="va">ga_id</span>, 
  date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="fl">365</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, 
  dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"fullReferrer"</span>,<span class="st">"landingPagePath"</span><span class="op">)</span>, 
  metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
  rows_per_call <span class="op">=</span> <span class="fl">50000</span>,
  max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">last30Days</span> <span class="op">&lt;-</span> <span class="va">two_years</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span><span class="op">)</span>
<span class="va">previousDays</span> <span class="op">&lt;-</span> <span class="va">two_years</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span><span class="op">)</span>

<span class="co"># the referrers seen in last30days but not previously</span>
<span class="va">new_refs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">last30Days</span><span class="op">$</span><span class="va">fullReferrer</span><span class="op">)</span>,
                    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">previousDays</span><span class="op">$</span><span class="va">fullReferrer</span><span class="op">)</span><span class="op">)</span>

<span class="va">last_30_new_refs</span> <span class="op">&lt;-</span> <span class="va">last30Days</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fullReferrer</span> <span class="op">%in%</span> <span class="va">new_refs</span><span class="op">)</span></code></pre></div>
</div>
<div id="create-a-plumber-script-for-wrapping-the-ga-fetch" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-plumber-script-for-wrapping-the-ga-fetch" class="anchor"></a>Create a plumber script for wrapping the GA fetch</h2>
<p>Now I’ll put the call behind a plumber API endpoint. The script will assume authentication will come from a local json auth file, that will be in the deployment. To make it a bit more general, the GA viewId will be able to be sent as a parameter, that will work for all GA accounts the auth file has access to.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">googleAnalyticsR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="co"># the function will be called from the endpoints</span>
<span class="va">do_ga</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># get last years referrer data</span>
  <span class="va">two_years</span> <span class="op">&lt;-</span> <span class="fu">google_analytics</span><span class="op">(</span>
    <span class="va">ga_id</span>, 
    date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="fl">365</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, 
    dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"fullReferrer"</span>,<span class="st">"landingPagePath"</span><span class="op">)</span>, 
    metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
    rows_per_call <span class="op">=</span> <span class="fl">50000</span>,
    max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>

  <span class="va">last30Days</span> <span class="op">&lt;-</span> <span class="va">two_years</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span><span class="op">)</span>
  <span class="va">previousDays</span> <span class="op">&lt;-</span> <span class="va">two_years</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span><span class="op">)</span>

  <span class="co"># the referrers seen in last30days but not previously</span>
  <span class="va">new_refs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">last30Days</span><span class="op">$</span><span class="va">fullReferrer</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">previousDays</span><span class="op">$</span><span class="va">fullReferrer</span><span class="op">)</span><span class="op">)</span>

  <span class="va">last_30_new_refs</span> <span class="op">&lt;-</span> <span class="va">last30Days</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fullReferrer</span> <span class="op">%in%</span> <span class="va">new_refs</span><span class="op">)</span>
    
  <span class="va">last_30_new_refs</span>
<span class="op">}</span>

<span class="co">#' @get /</span>
<span class="co">#' @serializer html</span>
<span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="st">"&lt;html&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/html&gt;"</span>
<span class="op">}</span>


<span class="co">#' @get /last-30-days</span>
<span class="co">#' @serializer csv</span>
<span class="kw">function</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># get last years referrer data</span>
  <span class="fu">do_ga</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>To support the plumber API a server file is also created:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu">plumber</span><span class="fu">::</span><span class="fu"><a href="https://www.rplumber.io/reference/plumb.html">plumb</a></span><span class="op">(</span><span class="st">"api.R"</span><span class="op">)</span>
<span class="va">pr</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>host<span class="op">=</span><span class="st">'0.0.0.0'</span>, port<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">'PORT'</span><span class="op">)</span><span class="op">)</span>, swagger<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>And a Dockerfile that needs plumber, googleAnalyticsR and readr</p>
<pre><code>FROM rstudio/plumber
RUN install2.r --error \
    -r 'http://cran.rstudio.com' \
    googleAnalyticsR readr
    
COPY ["./", "./"]
ENTRYPOINT ["Rscript", "server.R"]</code></pre>
<p>The files above are put into a folder “slackbot”</p>
<pre><code>|
|- api.R
|- Dockerfile
|- server.R</code></pre>
</div>
<div id="deploying-the-plumber-api-for-cloud-run" class="section level2">
<h2 class="hasAnchor">
<a href="#deploying-the-plumber-api-for-cloud-run" class="anchor"></a>Deploying the plumber API for Cloud Run</h2>
<p>The app is now deployed to Cloud Run via <code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span><span class="op">(</span><span class="st">"slackbot/"</span><span class="op">)</span>
<span class="co">#ℹ 2021-03-19 10:09:23 &gt; Using existing Dockerfile found in folder</span>
<span class="co">#ℹ 2021-03-19 10:09:23 &gt; Uploading inst/slackbot/ folder for Cloud Run</span>
<span class="co">#ℹ 2021-03-19 10:09:23 &gt; Dockerfile found in  inst/slackbot/</span>
<span class="co">#</span>
<span class="co">#── #Deploy docker build for image:  gcr.io/your-project/slackbot ─────────────────</span>
<span class="co">#</span>
<span class="co">#── #Upload  inst/slackbot/  to  gs://your-bucket/slackbot.tar.gz ───────</span>
<span class="co">#ℹ 2021-03-19 10:09:23 &gt; Uploading slackbot.tar.gz to your-bucket/slackbot.tar.gz</span>
<span class="co">#ℹ 2021-03-19 10:09:23 &gt; File size detected as  789 bytes</span>
<span class="co">#ℹ 2021-03-19 10:09:23 &gt; Google Cloud Storage Source enabled: /workspace/deploy/</span>
<span class="co">#ℹ 2021-03-19 10:09:24 &gt; Cloud Build started - logs: </span>
<span class="co"># https://console.cloud.google.com/cloud-build/builds/0f57a7ae-d64d-4d96-85ec-9e2ad64de52d?project=1080525199262</span>
<span class="co">#ℹ Starting Cloud Build</span>
<span class="co">#→ Status: WORKING  </span>
<span class="co"># ...</span>
<span class="co"># </span>
<span class="co"># ── #&gt; Launching CloudRun image:  gcr.io/your-project/slackbot:6a97870b-038b-4fe3-a3ea-4e5e6876c1aa ──────────────────────</span>
<span class="co"># ... </span>
<span class="co"># ── #&gt; Running at:  https://slackbot-asfkbkdf-ew.a.run.app ───────────────────────────────────────────────────────────────────</span>
<span class="co">#==CloudRunService==</span>
<span class="co">#name:  slackbot </span>
<span class="co">#location:  europe-west1 </span>
<span class="co">#lastModifier:  12345@cloudbuild.gserviceaccount.com </span>
<span class="co">#containers:  gcr.io/your-project/slackbot:6a97870b-038b-4fe3-a3ea-4e5e6876c1aa </span>
<span class="co">#creationTimestamp:  2021-03-19T09:14:48.727922Z </span>
<span class="co">#observedGeneration:  2 </span>
<span class="co">#url:  https://slackbot-asfkbkdf-ew.a.run.app </span></code></pre></div>
<p>It will take a few minutes to first build the Docker image (cup of tea time) then deploy it to Cloud Run. The Docker image building will be quicker the next time it builds due to the <code>kaniko_cache=TRUE</code> default enabling skipping over R library builds in the cache.</p>
<p>Once finished the build should return the Cloud Run URL.</p>
<p>The homepage should work but the Google Analytics endpoint (<code>/last-30days?ga_id=1234567</code>) won’t yet as we haven’t included the authentication file.</p>
</div>
<div id="setting-up-a-build-trigger-to-redeploy-the-r-script-on-each-git-commit" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-up-a-build-trigger-to-redeploy-the-r-script-on-each-git-commit" class="anchor"></a>Setting up a build trigger to redeploy the R script on each git commit</h2>
<p>To make working and updating the API easier, a build trigger will build the Dockerfile and deploy the API upon each git commit.</p>
<p>The project files above are added to a git repository and published on say GitHub, and the GitHub repo is added to Cloud Build as <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudbuild.html#build-triggers">described in the Build Triggers docs</a> - in my case its the googleCloudRunner’s own repo and I put everything in the <code>inst/slackbot</code> folder so that alters the directory in the buildsteps below.</p>
<p>Once the files are on GitHub a build trigger is created which will mimic what <code><a href="../reference/cr_deploy_run.html">cr_deploy_plumber()</a></code> did earlier - it will build the Dockerfile and re-deploy the Cloud Run app. To have more control, we now use <code><a href="../reference/cr_buildstep.html">cr_buildstep()</a></code> templates to make the build ourselves.</p>
<p>If you tried to run the GA endpoint in the logs you can see that the default Client Id for Google Analytics won’t allow non-interactive use - we need to use our own clientId and auth file. These sensitive files are uploaded to <a href="https://console.cloud.google.com/security/secret-manager">Secret Manager</a> so they can be used more securely within builds via <code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="co"># get secret files</span>
  <span class="fu"><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret</a></span><span class="op">(</span><span class="st">"mark-edmondson-gde-clientid"</span>, <span class="st">"client.json"</span>,
                      dir <span class="op">=</span> <span class="st">"inst/slackbot/"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret</a></span><span class="op">(</span><span class="st">"googleanalyticsr-tests"</span>,<span class="st">"auth.json"</span>,
                      dir <span class="op">=</span> <span class="st">"inst/slackbot/"</span><span class="op">)</span>,
  <span class="co"># build with the same name as deployed</span>
  <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span><span class="op">(</span>
    image <span class="op">=</span> <span class="st">"slackbot"</span>,
    kaniko_cache <span class="op">=</span> <span class="cn">TRUE</span>,
    dir <span class="op">=</span> <span class="st">"inst/slackbot/"</span>
  <span class="op">)</span>,
  <span class="co">#deploy the app</span>
  <span class="fu"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span><span class="op">(</span>
    <span class="st">"slackbot"</span>,
    image <span class="op">=</span> <span class="st">"gcr.io/$PROJECT_ID/slackbot:$BUILD_ID"</span>,
    env_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"GAR_CLIENT_JSON=client.json"</span>,
                 <span class="st">"GA_AUTH_FILE=auth.json"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">build_yml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span><span class="va">bs</span><span class="op">)</span>
<span class="va">build_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">build_yml</span><span class="op">)</span>

<span class="co"># setup trigger of build</span>
<span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span><span class="op">)</span>

<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span>
  <span class="va">build_obj</span>, name <span class="op">=</span> <span class="st">"slackbot-trigger"</span>, trigger <span class="op">=</span> <span class="va">repo</span>,
  description <span class="op">=</span> <span class="st">"Deploying the Slackbot example"</span>,
  includedFiles <span class="op">=</span> <span class="st">"inst/slackbot/**"</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="creating-the-slack-webhook-for-the-slack-bot" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-the-slack-webhook-for-the-slack-bot" class="anchor"></a>Creating the Slack webhook for the Slack bot</h2>
<p>I now reference <a href="https://api.slack.com/apps/">Slack’s dev docs</a> on how to create a Webhook URL which is of the form <code>https://hooks.slack.com/services/XXXX6/B0YYYYYY/3rNZZZZZ</code> There is also useful info on the <a href="https://api.slack.com/reference/messaging/payload">formatting of the messaging</a> and you can make test calls with <code>curl</code> and <code><a href="https://httr.r-lib.org/reference/POST.html">httr::POST()</a></code>.</p>
<p>I will use <code><a href="https://httr.r-lib.org/reference/POST.html">httr::POST()</a></code> in the API to pass along the GA data, so now is a good time to test with the Slack format.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span>
<span class="va">slack_url</span> <span class="op">&lt;-</span> <span class="st">"https://hooks.slack.com/services/XXXX6/B0YYYYYY/3rNZZZZZ"</span>

<span class="co"># it works!</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span><span class="va">slack_url</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/verbose.html">verbose</a></span><span class="op">(</span><span class="op">)</span>, body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="st">"Hello World"</span><span class="op">)</span>, encode <span class="op">=</span> <span class="st">"json"</span><span class="op">)</span>

<span class="co"># what does CSV format looks like?</span>
<span class="va">the_body</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"```\n"</span>, 
                <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">"\n"</span>,<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span>,
                <span class="st">"```\n"</span>
          <span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span><span class="va">slack_url</span>, <span class="fu"><a href="https://httr.r-lib.org/reference/verbose.html">verbose</a></span><span class="op">(</span><span class="op">)</span>, body <span class="op">=</span> <span class="va">the_body</span>, encode <span class="op">=</span> <span class="st">"json"</span><span class="op">)</span></code></pre></div>
<p>I played around with what exactly to send to Slack for a data.frame and ended up with the above, which looked like this in Slack:</p>
<p><img src="csv_slack.png"></p>
</div>
<div id="modifying-the-r-script-to-get-the-right-format-for-slack" class="section level2">
<h2 class="hasAnchor">
<a href="#modifying-the-r-script-to-get-the-right-format-for-slack" class="anchor"></a>Modifying the R script to get the right format for Slack</h2>
<p>To call the Slack bot, the API needs to collect the data then make a HTTP GET request above itself to the Slack URL.</p>
<p>The R API is now modified to include this new endpoint:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">googleAnalyticsR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span>

<span class="co"># the function will be called from the endpoints</span>
<span class="va">do_ga</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># get last years referrer data</span>
  <span class="va">two_years</span> <span class="op">&lt;-</span> <span class="fu">google_analytics</span><span class="op">(</span>
    <span class="va">ga_id</span>, 
    date_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="op">(</span><span class="fl">365</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, 
    dimensions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"fullReferrer"</span>,<span class="st">"landingPagePath"</span><span class="op">)</span>, 
    metrics <span class="op">=</span> <span class="st">"sessions"</span>, 
    rows_per_call <span class="op">=</span> <span class="fl">50000</span>,
    max <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>

  <span class="va">last30Days</span> <span class="op">&lt;-</span> <span class="va">two_years</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span><span class="op">)</span>
  <span class="va">previousDays</span> <span class="op">&lt;-</span> <span class="va">two_years</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">30</span><span class="op">)</span>

  <span class="co"># the referrers seen in last30days but not previously</span>
  <span class="va">new_refs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">last30Days</span><span class="op">$</span><span class="va">fullReferrer</span><span class="op">)</span>,
                      <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">previousDays</span><span class="op">$</span><span class="va">fullReferrer</span><span class="op">)</span><span class="op">)</span>

  <span class="va">last_30_new_refs</span> <span class="op">&lt;-</span> <span class="va">last30Days</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fullReferrer</span> <span class="op">%in%</span> <span class="va">new_refs</span><span class="op">)</span>
    
  <span class="va">last_30_new_refs</span>
<span class="op">}</span>

<span class="co">#' @get /</span>
<span class="co">#' @serializer html</span>
<span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="st">"&lt;html&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/html&gt;"</span>
<span class="op">}</span>


<span class="co">#' @get /last-30-days</span>
<span class="co">#' @serializer csv</span>
<span class="kw">function</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># get last years referrer data</span>
  <span class="fu">do_ga</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#' @get /trigger-slack</span>
<span class="co">#' @serializer json</span>
<span class="kw">function</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># get last years referrer data</span>
  <span class="va">last_30_new_refs</span> <span class="op">&lt;-</span> <span class="fu">do_ga</span><span class="op">(</span><span class="va">ga_id</span><span class="op">)</span>
  
  <span class="va">the_body</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"```\n"</span>, 
                 <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>collapse <span class="op">=</span> <span class="st">"\n"</span>,<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">last_30_new_refs</span><span class="op">)</span><span class="op">)</span>,
                <span class="st">"```\n"</span><span class="op">)</span>
                <span class="op">)</span>

  <span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span><span class="va">slack_url</span>, body <span class="op">=</span> <span class="va">the_body</span>, encode <span class="op">=</span> <span class="st">"json"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We also add knitr to help with rendering the output in the Dockerfile (httr is already a depdency for googleAnalyticsR):</p>
<pre><code>FROM rstudio/plumber
RUN install2.r --error \
    -r 'http://cran.rstudio.com' \
    googleAnalyticsR readr knitr
    
COPY ["./", "./"]
ENTRYPOINT ["Rscript", "server.R"]</code></pre>
<p>After making the changes to the Dockerfile and api.R, we commit the changes to redeploy via the Build Trigger</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
