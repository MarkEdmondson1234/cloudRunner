<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Run R code on a schedule • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Run R code on a schedule">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Run R code on a schedule</h1>
            
            <h4 class="date">2021-03-18</h4>
      
      
      <div class="hidden name"><code>usecase-scheduled-r-builds.Rmd</code></div>

    </div>

    
    
<p>Sometimes you just want to have some R code running whilst you get on with something else. In this case you can use <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code> to run your R code even after you have turned your computer off, since its running in the cloud. You can also set it up on a schedule to run periodically.</p>
<p>When running R code, it needs to run in an environment that has the packages and resources it needs. If those are covered by images such as <code>rocker/verse</code> (the tidyverse) then you can commit it straight away. Otherwise you can first make a custom Docker file with the R packages you need in it, and then run your code against that.</p>
<p>Once you have your R code and chosen the Docker image, then you can use <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> to point at your R file and Docker image, set the timeout to what you need (the maximum is 24 hours) and select a schedule if you need it.</p>
<p>An RStudio gadget is also available to help you deploy:</p>
<p><img src="gadget_r.png"></p>
<p>If you want help creating the Docker image, try <a href="https://o2r.info/containerit/"><code>containerit</code></a> to generate your Dockerfile, then use <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> to build it.</p>
<div id="execute-r-scripts-directly-from-cloud-storage" class="section level3">
<h3 class="hasAnchor">
<a href="#execute-r-scripts-directly-from-cloud-storage" class="anchor"></a>Execute R scripts directly from Cloud Storage</h3>
<p>In some cases you may hit character limits of the cloudbuild file in which case you will need to execute the R code from a file. The easiest way to do this is to upload your R code to a Cloud Storage bucket and then supply the <code>gs://</code> URI to <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>:</p>
<p>The below example uses a public bucket and R image, for your use case you would change to your own private one that your Cloud Build service email has access to:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleCloudRunner)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">large_r_job &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="dt">steps =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="st">"gs://mark-edmondson-public-read/schedule.R"</span>, </a>
<a class="sourceLine" id="cb1-6" data-line-number="6">                   <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/googleauthr-verse:latest"</span>)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  )</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(large_r_job)</a></code></pre></div>
</div>
<div id="authentication-within-the-r-script-on-cloud-build" class="section level3">
<h3 class="hasAnchor">
<a href="#authentication-within-the-r-script-on-cloud-build" class="anchor"></a>Authentication within the R script on Cloud Build</h3>
<p>The recommended way to use secrets in build is to use <code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code>, and upload the sensitive authentication file to <a href="https://cloud.google.com/secret-manager">Google Secret Manager</a> before hand.</p>
<p>You can also authenticate without uploading any file, if you can use the default service account. This is usually the case for cloud services such as BigQuery.</p>
<p>The default metadata of the Cloud Build server is the same as <code>googleComputeEngineR</code>, so you can use <code><a href="https://code.markedmondson.me/googleAuthR//reference/gar_gce_auth.html">googleAuthR::gar_gce_auth("default", scopes = "https://www.googleapis.com/auth/cloud-platform")</a></code>.</p>
<p>You can also use the Cloud Build email (the one that looks like <code>{project-number@cloudbuild.gserviceaccount.com}</code>) if its given the right access in Cloud IAM, authentication in your R script will look like <code><a href="https://code.markedmondson.me/googleAuthR//reference/gar_gce_auth.html">googleAuthR::gar_gce_auth("{project-number@cloudbuild.gserviceaccount.com}", scopes = "https://www.googleapis.com/auth/cloud-platform")</a></code></p>
<p>This enables you in the R script to download files from Cloud Storage, for example. A minimal example is shown below:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleCloudStorageR)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleAuthR)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">gar_gce_auth</span>(<span class="st">"default"</span>, <span class="dt">scopes =</span> <span class="st">"https://www.googleapis.com/auth/cloud-platform"</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">## or if using the build email..</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co"># gar_gce_auth("{project-number@cloudbuild.gserviceaccount.com}", </span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#                scopes = "https://www.googleapis.com/auth/cloud-platform")</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="kw">gcs_list_buckets</span>(<span class="st">"my_project"</span>)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">auth_file &lt;-<span class="st"> </span><span class="kw">gcs_get_object</span>(<span class="st">"config.json"</span>, <span class="dt">bucket =</span> <span class="st">"my-bucket"</span>)</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">...do something with the config file...</a></code></pre></div>
<p>This would then be saved to an R script and deployed via the gadget or:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span>(<span class="st">"the_script.R"</span>, <span class="dt">r_image =</span> <span class="st">"gcr.io/gcer-public/googleauthr-verse"</span>)</a></code></pre></div>
<p>…where the docker R image is one with googleCloudStorageR installed.</p>
</div>
<div id="build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage" class="anchor"></a>Build an Rmd on a schedule and host its HTML on Cloud Storage</h2>
<p>Cloud Storage can host public HTML files like a website, which can be accessed via public or private viewers. This can be useful in setting up reporting infrastructure.</p>
<p>A video of the below workflow is <a href="https://www.youtube.com/watch?v=BainmerWVb0">here</a>:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/BainmerWVb0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>The Cloud Build below makes use of Cloud Build artifacts to send the built Rmd files to a public Cloud Storage bucket. The Rmd is built on a schedule to pull in new data from a Google Sheet:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">rmd_build &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="dt">steps =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">      <span class="st">"gsutil"</span>,</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">               <span class="st">"gs://mark-edmondson-public-read/scheduled_rmarkdown.Rmd"</span>,</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">               <span class="st">"scheduled_rmarkdown.Rmd"</span>)),</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">      <span class="st">"gcr.io/gcer-public/render_rmd:master"</span>,</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">      <span class="dt">r =</span> <span class="st">"rmarkdown::render('scheduled_rmarkdown.Rmd',</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="st">               output_file = 'scheduled_rmarkdown_2020.html')"</span>,</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  )),</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  <span class="dt">artifacts =</span> <span class="kw"><a href="../reference/cr_build_yaml_artifact.html">cr_build_yaml_artifact</a></span>(</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">    <span class="st">"scheduled_rmarkdown_2020.html"</span>,</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">    <span class="dt">bucket =</span> <span class="st">"mark-edmondson-public-read"</span>)</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">)</a>
<a class="sourceLine" id="cb4-17" data-line-number="17"></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co"># test the build</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(rmd_build)</a></code></pre></div>
<p>Once the build is tested, we now schedule the Rmd to build each morning, adapting to changes in the source data file.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># schedule the build</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"rmd-demo"</span>, <span class="dt">schedule =</span> <span class="st">"15 5 * * *"</span>,</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">            <span class="dt">httpTarget =</span> <span class="kw"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(built))</a></code></pre></div>
<p>The example Rmd file is built and available on a public Cloud Storage bucket - the above example is available at this <a href="https://storage.googleapis.com/mark-edmondson-public-read/scheduled_rmarkdown.html">link</a></p>
<p><img src="schedule_markdown_hosted_gcs.png"></p>
</div>
<div id="build-and-deploy-rmd-files-to-cloud-run-on-a-schedule" class="section level2">
<h2 class="hasAnchor">
<a href="#build-and-deploy-rmd-files-to-cloud-run-on-a-schedule" class="anchor"></a>Build and deploy Rmd files to Cloud Run on a schedule</h2>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
I have a flexdashboard that shows data from a Google Sheet with ggplotly. What's the best way to host the dashboard somewhere <em>and</em> make it so it shows the latest data? i.e. how should I show dynamic data in an RMarkdown dashboard? Continually reknit? Make a plumber API? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a>
</p>
— Andrew Heiss, PhD (<span class="citation">@andrewheiss</span>) <a href="https://twitter.com/andrewheiss/status/1212408575684943878?ref_src=twsrc%5Etfw">January 1, 2020</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Cloud Run scales from 0 to millions of hits, so can be an option for hosting a website. In particular you may want a private internal website, have R code executing via a plumber API in the same container, or have lots of traffic or data that goes over other free hosting options such as GitHub pages. A nginx server configuration is included to host any HTML you provide via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>.</p>
<p>You may prefer using Cloud Storage public URLs if you don’t need any of Cloud Run’s features, like the previous example.</p>
<p>Coupled to that, a common use case is to render Rmd files and host them on a website like the tweet above. For the above tweet scenario, the Rmd has a setup block that reads from googlesheets via the code below:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="bn">```{r setup, include=FALSE}</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="bn">library(flexdashboard)</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="bn">library(googlesheets4)</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="bn">library(ggplot2)</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="bn">library(plotly)</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="bn">library(dplyr)</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="bn"># for public Googlesheets.  </span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="bn"># If private see https://gargle.r-lib.org/articles/non-interactive-auth.html</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="bn">sheets_deauth()</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="bn"># this is the data that may update each time the Rmd is rendered</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="bn">gm &lt;- sheets_example("gap") %&gt;% read_sheet()</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="bn">gm_agg &lt;- gm %&gt;%</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="bn">  mutate(gdp=gdpPercap*pop) %&gt;%</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="bn">  filter(continent=="Africa") %&gt;%</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="bn">  group_by(year) %&gt;%</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="bn">  summarize(mean(lifeExp), mean(gdp))</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="bn">p &lt;- ggplot(gm, aes(gdpPercap, lifeExp)) + theme_minimal() + scale_x_log10()</span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="bn">```</span></a></code></pre></div>
<p>The build Rmd docker in this case needs all the libraries listed (flexdashboard, googlesheets4 etc.) included in its build - this could be built before hand in another Cloud Build - in this case the libraries are all in <code>gcr.io/gcer-public/render_rmd</code></p>
<p>For this example, the build is not reading from a git repo but the Rmd file is downloaded from a Cloud Storage bucket, that you may have uploaded to manually, via <code>googleCloudStorageR</code> or perhaps copied over from a repo in another Cloud Build on a Build Trigger.</p>
<p>The scheduled build then can be enabled via:</p>
<ol style="list-style-type: decimal">
<li>Uploading your Rmarkdown files to a Cloud Storage bucket</li>
<li>Create a build that will:</li>
</ol>
<ul>
<li>download the Rmd file</li>
<li>render the Rmd creating the HTML files</li>
<li>configure nginx for Cloud Run,</li>
<li>build a Docker image of nginx with your HTML</li>
<li>serve it on Cloud Run.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">r &lt;-<span class="st"> "rmarkdown::render('scheduled_rmarkdown.Rmd', output_file = 'scheduled_rmarkdown.html')"</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">build_rmd &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">      <span class="dt">steps =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">        <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">          <span class="dt">id =</span> <span class="st">"download Rmd template"</span>,</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">          <span class="dt">name =</span> <span class="st">"gsutil"</span>,</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">          <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">                   <span class="st">"gs://mark-edmondson-public-read/scheduled_rmarkdown.Rmd"</span>,</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                   <span class="st">"scheduled_rmarkdown.Rmd"</span>),</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">        ),</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">        <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">          <span class="dt">id=</span><span class="st">"render rmd"</span>,</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">          <span class="dt">r =</span> r,</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">          <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/render_rmd:master"</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">        ),</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">        <span class="kw"><a href="../reference/cr_buildstep_nginx_setup.html">cr_buildstep_nginx_setup</a></span>(<span class="st">"/workspace/"</span>),</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">        <span class="kw"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(<span class="st">"html-on-cloudrun"</span>, <span class="dt">tag =</span> <span class="st">"$BUILD_ID"</span>),</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">        <span class="kw"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span>(<span class="dt">name =</span> <span class="st">"my-html-on-cloudrun"</span>,</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">                         <span class="dt">image =</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">                         <span class="dt">concurrency =</span> <span class="dv">80</span>)</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">        ), </a>
<a class="sourceLine" id="cb7-23" data-line-number="23">    <span class="dt">images =</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">    )</a></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Run a test build to check it works.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(build_rmd)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(b)</a></code></pre></div>
<p>You should see a Cloud Run URL in the logs, like this one: <code>https://my-html-on-cloudrun-ewjogewawq-ew.a.run.app/scheduled_rmarkdown.html</code></p>
<p><img src="rmd-on-cloudrun.png"></p>
<ol start="6" style="list-style-type: decimal">
<li>Schedule the build using cron syntax</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">schedule_me &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(built)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"rmd-on-cloudrun"</span>, <span class="st">"15 8 * * *"</span>, <span class="dt">httpTarget =</span> schedule_me)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#==CloudScheduleJob==</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#name:  projects/project-name/locations/europe-west1/jobs/rmd-on-cloudrun </span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#state:  ENABLED </span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#httpTarget.uri:  https://cloudbuild.googleapis.com/v1/projects/project-name/builds </span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#httpTarget.httpMethod:  POST </span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#userUpdateTime:  2020-01-04T08:34:42Z </span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">#schedule:  15 8 * * * </span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#timezone:  UTC </span></a></code></pre></div>
<div id="do-it-all-in-r-using-cr_deploy_r" class="section level3">
<h3 class="hasAnchor">
<a href="#do-it-all-in-r-using-cr_deploy_r" class="anchor"></a>Do it all in R using cr_deploy_r()</h3>
<p>An alternative if you only wanted to do a scheduled deployment would be to put all steps in an R script (downloading, building and uploading to Cloud Storage via <code>googleCloudStorageR</code>) and use the RStudio gadget or <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code></p>
<p><img src="gadget_r.png"></p>
</div>
</div>
<div id="migrate-an-existing-scheduled-docker-container" class="section level2">
<h2 class="hasAnchor">
<a href="#migrate-an-existing-scheduled-docker-container" class="anchor"></a>Migrate an existing scheduled Docker container</h2>
<p>You may have an existing Docker container containing code, that doesn’t need a public URL.</p>
<p>For example, a self-contained R script with <code>googleAnalyticsR</code> and <code>bigQueryR</code> pre-installed, that downloads data from Google Analytics and uploads it to BigQuery. This may be running on a VM from <code>googleComputeEngineR</code>, Kubernetes or Airflow KubernetesPodOperator.</p>
<p>If you give the cloud build service email the right permissions, then this can all be done on Cloud Build + Cloud Scheduler.</p>
<p>For example, say your existing container is called <code>gcr.io/my-project/my-r-script</code>. A Cloud Build could look simply like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">r_code &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"gcr.io/my-project/my-r-script"</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(r_code)</a></code></pre></div>
<p>You could add other steps if you wanted, such as sending an email when done via <code><a href="../reference/cr_buildstep_mailgun.html">cr_buildstep_mailgun()</a></code> or <code><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">r_code &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"gcr.io/my-project/my-r-script"</span>),</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="kw"><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack</a></span>(<span class="st">"The script run ok"</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(r_code, <span class="st">`</span><span class="dt">_SLACK_WEBHOOK</span><span class="st">`</span> =<span class="st"> "https://your_slack_webhook"</span>)</a></code></pre></div>
<p>To set this up in a schedule, add it to the scheduler like so:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(r_code, <span class="st">`</span><span class="dt">_SLACK_WEBHOOK</span><span class="st">`</span> =<span class="st"> "https://your_slack_webhook"</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">schedule_me &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(built)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"r-code-example"</span>, <span class="st">"15 8 * * *"</span>, <span class="dt">httpTarget =</span> schedule_me)</a></code></pre></div>
</div>
<div id="run-r-code-via-cloud-run" class="section level2">
<h2 class="hasAnchor">
<a href="#run-r-code-via-cloud-run" class="anchor"></a>Run R code via Cloud Run</h2>
<p>Instead of using Cloud Build, you may want to use Cloud Run as the engine running the R code, either because you want to control the code via parametisation of a HTTP request to your R code, or one use case I came across was needing to make requests from a fixed ip address - Cloud Run offers a way to fix the IP of the app.</p>
<p>See the <a href="https://code.markedmondson.me/googleCloudRunner/articles/usecase-r-api-microservices.html">R API Microservices Use Case</a> for more details on creating and deploying an R API using plumber.</p>
<p>R code is triggered using an API package such as plumber to create HTTP endpoints. The scheduler can then use that HTTP endpoint as the mechanism to trigger schedules.</p>
<p>See <code><a href="../reference/cr_run_schedule_http.html">?cr_run_schedule_http</a></code> for examples.</p>
<div id="public-apis" class="section level3">
<h3 class="hasAnchor">
<a href="#public-apis" class="anchor"></a>Public APIs</h3>
<p>For R code that is public you don’t need to worry about authentication, so you can trigger your R code by creating a <code><a href="../reference/HttpTarget.html">?HttpTarget</a></code> object that will carry your endpoint and parameters as set up in your plumber app:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># for unauthenticated apps create a HttpTarget</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">run_me &lt;-<span class="st"> </span><span class="kw"><a href="../reference/HttpTarget.html">HttpTarget</a></span>(</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="dt">uri =</span> <span class="st">"https://public-ewjogewawq-ew.a.run.app/echo?msg=blah"</span>,</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  <span class="dt">http_method =</span> <span class="st">"GET"</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"cloudrun-scheduled"</span>, <span class="dt">schedule =</span> <span class="st">"16 4 * * *"</span>, <span class="dt">httpTarget =</span> run_me)</a></code></pre></div>
</div>
<div id="private-apis" class="section level3">
<h3 class="hasAnchor">
<a href="#private-apis" class="anchor"></a>Private APIs</h3>
<p>For private R APIs, you can use <code><a href="../reference/cr_jwt_create.html">cr_jwt_create()</a></code> and friends to call the API from your local R session, but for Cloud Scheduler to call the API a special new service account is needed with Cloud Run Invoker authentication rights.</p>
<p>When you create an app via <code><a href="../reference/cr_deploy_run.html">cr_deploy_run("my-app", allowUnauthenticated = TRUE)</a></code> a new service account will be created with the rights called “my-app-invoker”. Use that email to tell the scheduler how to call the app:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># for authenticated Cloud Run apps - create with allowUnauthenticated=FALSE</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="kw"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span>(<span class="st">"my-app"</span>, <span class="dt">allowUnauthenticated =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co"># deploying via R will help create a service email called my-app-invoker</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="kw"><a href="../reference/cr_run_email.html">cr_run_email</a></span>(<span class="st">"my-app"</span>)</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt; "my-app-invoker@your-project.iam.gserviceaccount.com"</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co"># schedule the endpoint</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">my_app &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_run_get.html">cr_run_get</a></span>(<span class="st">"my-app"</span>)</a>
<a class="sourceLine" id="cb14-10" data-line-number="10"></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">endpoint &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(my_app<span class="op">$</span>status<span class="op">$</span>url, <span class="st">"/fetch_stuff"</span>)</a>
<a class="sourceLine" id="cb14-12" data-line-number="12"></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">app_sched &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_run_schedule_http.html">cr_run_schedule_http</a></span>(endpoint,</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">                                  <span class="dt">http_method =</span> <span class="st">"GET"</span>,</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">                                  <span class="dt">email =</span> <span class="kw"><a href="../reference/cr_run_email.html">cr_run_email</a></span>(<span class="st">"my-app"</span>))</a>
<a class="sourceLine" id="cb14-16" data-line-number="16"></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"my-app-scheduled-1"</span>,</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">            <span class="dt">schedule =</span> <span class="st">"16 4 * * *"</span>,</a>
<a class="sourceLine" id="cb14-19" data-line-number="19">            <span class="dt">httpTarget =</span> app_sched)</a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage">Build an Rmd on a schedule and host its HTML on Cloud Storage</a></li>
      <li><a href="#build-and-deploy-rmd-files-to-cloud-run-on-a-schedule">Build and deploy Rmd files to Cloud Run on a schedule</a></li>
      <li><a href="#migrate-an-existing-scheduled-docker-container">Migrate an existing scheduled Docker container</a></li>
      <li><a href="#run-r-code-via-cloud-run">Run R code via Cloud Run</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
