<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example Use Cases for googleCloudRunner • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example Use Cases for googleCloudRunner">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fas fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fas fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fas fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fas fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="usecases_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example Use Cases for googleCloudRunner</h1>
            
            <h4 class="date">2021-01-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/master/vignettes/usecases.Rmd"><code>vignettes/usecases.Rmd</code></a></small>
      <div class="hidden name"><code>usecases.Rmd</code></div>

    </div>

    
    
<p>Here will be some example use cases you can use googleCloudRunner for.</p>
<p>Since almost any code can be called and passed via Docker images, there are a lot of potential uses.</p>
<ul>
<li>Scheduling R scripts in the cloud</li>
<li>R APIs to call from anywhere</li>
<li>Triggering R code to run on events, such as BigQuery table updates or GitHub pushes</li>
<li>Checking a package, creating a website, deploying it to GitHub</li>
<li>Running authenticated tests for R packages in private environment</li>
<li>Creating an Rmarkdown powered website using Cloud Run</li>
<li>Integrating R with other language applications</li>
<li>Public and private Docker image creations on triggers</li>
</ul>
<p>Some <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community">community contributed Cloud Build images are listed here</a>, including <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/hugo">hugo</a>, <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/make">make</a>, and <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/tar">tar</a>.</p>
<p>You can use any public Docker image if you know which arguments etc. to send to it, for example the Slack messages are using <a href="https://github.com/technosophos/slack-notify"><code>technosophos/slack-notify</code></a>.</p>
<div id="deploy-a-pkgdown-website-for-your-r-package" class="section level2">
<h2 class="hasAnchor">
<a href="#deploy-a-pkgdown-website-for-your-r-package" class="anchor"></a>Deploy a pkgdown website for your R package</h2>
<p>When creating an R package <a href="https://pkgdown.r-lib.org/">pkgdown</a> is a fantastic resource for creating a package website from your R function’s documentation and vignettes.</p>
<p>This workflow uses Google’s Secret Manager to securely hold your Git ssh login details, then use those details to commit a built website on each Git commit. This means you do not have to build the website locally.</p>
<p>Each commit you make, a background task will build the website with your changes and commit it back to the repo - see example for this website:</p>
<p><img src="pkgdown-commit.png"></p>
<p>A suggested setup workflow to do this is below:</p>
<ol style="list-style-type: decimal">
<li>Go to <a href="https://console.cloud.google.com/cloud-build/triggers">GCP console &gt; Cloud Build &gt; Triggers</a> and link your git repo to Cloud Build.</li>
<li>Create a git ssh key to make commits to your repo. <a href="https://help.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">GitHub has a guide here</a>
</li>
<li>Upload the ssh key secret to <a href="https://cloud.google.com/secret-manager">Google Cloud Secret Manager</a> - you can use this secret for all future builds.</li>
<li>Use <code><a href="../reference/cr_deploy_pkgdown.html">cr_deploy_pkgdown()</a></code> to create a cloudbuild.yml file in your R package’s directory, giving it your secret name from step 2. <code>create_trigger</code> can be <code>file</code> if you want the cloudbuild.yaml to be within your directory, or <code>inline</code> if the build will only be defined in the trigger.</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_pkgdown.html">cr_deploy_pkgdown</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span>,
                  secret <span class="op">=</span> <span class="st">"github-key"</span>,
                  create_trigger <span class="op">=</span> <span class="st">"inline"</span><span class="op">)</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Commit to your git repository</li>
</ol>
<p>The function will then create a build customised for creating and rendering pkgdown websites, and committing the rendered version to your GitHub /docs folder.</p>
<p>The below is an example for <code>googleCloudRunner</code>’s website:</p>
<p><img src="pkgdown-build-trigger.png"></p>
<p>You can customise the deployment further by using <code><a href="../reference/cr_buildstep_pkgdown.html">cr_buildstep_pkgdown()</a></code> in your own custom build files. For instance, you could download other auth keys using <code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code> again, so that your website has working authenticated examples.</p>
</div>
<div id="run-package-tests-and-code-coverage" class="section level2">
<h2 class="hasAnchor">
<a href="#run-package-tests-and-code-coverage" class="anchor"></a>Run package tests and code coverage</h2>
<p>This workflow will run the package tests you have upon each commit to your git repo.</p>
<p>You can also optionally submit those test results to <a href="https://codecov.io">codecov</a> via the excellent <a href="https://covr.r-lib.org/">covr R package</a>, helping you see which code your tests actually test. This is what creates this badge for this package:</p>
<p><a href="https://codecov.io/gh/MarkEdmondson1234/googleCloudRunner"><img src="https://codecov.io/gh/MarkEdmondson1234/googleCloudRunner/branch/master/graph/badge.svg" alt="codecov"></a></p>
<p>If you do not need online authentication for your tests, then this is only a case of deploying the premade default cloudbuild.yml file via <code><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests()</a></code>.</p>
<p>The below assumes you have created tests for your package.</p>
<ol style="list-style-type: decimal">
<li>If you want to use Codecov, <a href="https://docs.codecov.io/reference">generate a Codecov token</a> on its website and link it to your git repository</li>
<li>Create the tests cloudbuild.yml file via <code><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests()</a></code>
</li>
<li>Add and commit the cloudbuild.yml file to your git repository</li>
<li>Go to <a href="https://console.cloud.google.com/cloud-build/triggers">GCP console &gt; Cloud Build &gt; Triggers</a> and link your git repo to Cloud Build.</li>
<li>Create a Build Trigger for your git repository:</li>
</ol>
<ul>
<li>point at the cloudbuild.yml file you committed (e.g. cloudbuild-tests.yml)</li>
<li>Exclude any folders such as the <code>docs/**</code> folder where changes should not trigger a recheck</li>
<li>Add a substitution variable <code>_CODECOV_TOKEN</code> if you are using it</li>
</ul>
<p>The below is an example for <code>googleCloudRunner</code>’s website:</p>
<p><img src="pkgchecks-trigger.png"></p>
<p>The example above also adds other substitution variables to help run some of the examples.</p>
<div id="authenticated-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#authenticated-tests" class="anchor"></a>Authenticated tests</h3>
<p>You can customise the deployment more by using <code><a href="../reference/cr_buildstep_packagetests.html">cr_buildstep_packagetests()</a></code> in your own custom build files.</p>
<p>For <code>googleCloudRunner</code> and API packages in general, an authentication key is needed to run online tests. This authentication key can be encrypted via <a href="https://cloud.google.com/secret-manager">Google Secret Manager</a> by adding a decryption step to your tests via <code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code> - its usually only a case of uploading your auth file:</p>
<p><img src="secret-ui.png"></p>
<p>In that case, the decryption step needs to occur before the tests run, which you can do by supplying <code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code> to <code><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests()</a></code>.</p>
<p>You will also want to use that auth file somehow, in the below example it is placed in an environment argument that your tests use to find the authentication file:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret</a></span><span class="op">(</span><span class="st">"my_secret"</span>, <span class="st">"auth.json"</span><span class="op">)</span>,
  env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NOT_CRAN=true"</span>, <span class="st">"MY_AUTH_FILE=auth.json"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Use the resulting cloudbuild.yml file in the same manner as unauthenticated tests.</p>
</div>
</div>
<div id="run-r-code-on-a-schedule" class="section level2">
<h2 class="hasAnchor">
<a href="#run-r-code-on-a-schedule" class="anchor"></a>Run R code on a schedule</h2>
<p>Sometimes you just want to have some R code running whilst you get on with something else. In this case you can use <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code> to run your R code even after you have turned your computer off, since its running in the cloud. You can also set it up on a schedule to run periodically.</p>
<p>When running R code, it needs to run in an environment that has the packages and resources it needs. If those are covered by images such as <code>rocker/verse</code> (the tidyverse) then you can commit it straight away. Otherwise you can first make a custom Docker file with the R packages you need in it, and then run your code against that.</p>
<p>Once you have your R code and chosen the Docker image, then you can use <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> to point at your R file and Docker image, set the timeout to what you need (the maximum is 24 hours) and select a schedule if you need it.</p>
<p>An RStudio gadget is also available to help you deploy:</p>
<p><img src="gadget_r.png"></p>
<p>If you want help creating the Docker image, try <a href="https://o2r.info/containerit/"><code>containerit</code></a> to generate your Dockerfile, then use <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> to build it.</p>
<div id="execute-r-scripts-directly-from-cloud-storage" class="section level3">
<h3 class="hasAnchor">
<a href="#execute-r-scripts-directly-from-cloud-storage" class="anchor"></a>Execute R scripts directly from Cloud Storage</h3>
<p>In some cases you may hit character limits of the cloudbuild file in which case you will need to execute the R code from a file. The easiest way to do this is to upload your R code to a Cloud Storage bucket and then supply the <code>gs://</code> URI to <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>:</p>
<p>The below example uses a public bucket and R image, for your use case you would change to your own private one that your Cloud Build service email has access to:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">large_r_job</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span><span class="st">"gs://mark-edmondson-public-read/schedule.R"</span>, 
                   name <span class="op">=</span> <span class="st">"gcr.io/gcer-public/googleauthr-verse:latest"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">large_r_job</span><span class="op">)</span></code></pre></div>
</div>
<div id="authentication-within-the-r-script-on-cloud-build" class="section level3">
<h3 class="hasAnchor">
<a href="#authentication-within-the-r-script-on-cloud-build" class="anchor"></a>Authentication within the R script on Cloud Build</h3>
<p>The recommended way to use secrets in build is to use <code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code>, and upload the sensitive authentication file to <a href="https://cloud.google.com/secret-manager">Google Secret Manager</a> before hand.</p>
<p>You can also authenticate without uploading any file, if you can use the default service account. This is usually the case for cloud services such as BigQuery.</p>
<p>The default metadata of the Cloud Build server is the same as <code>googleComputeEngineR</code>, so you can use <code><a href="https://code.markedmondson.me/googleAuthR//reference/gar_gce_auth.html">googleAuthR::gar_gce_auth("default", scopes = "https://www.googleapis.com/auth/cloud-platform")</a></code>.</p>
<p>You can also use the Cloud Build email (the one that looks like <code>{project-number@cloudbuild.gserviceaccount.com}</code>) if its given the right access in Cloud IAM, authentication in your R script will look like <code><a href="https://code.markedmondson.me/googleAuthR//reference/gar_gce_auth.html">googleAuthR::gar_gce_auth("{project-number@cloudbuild.gserviceaccount.com}", scopes = "https://www.googleapis.com/auth/cloud-platform")</a></code></p>
<p>This enables you in the R script to download files from Cloud Storage, for example. A minimal example is shown below:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">library</span>(googleCloudStorageR)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">library</span>(googleAuthR)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw">gar_gce_auth</span>(<span class="st">"default"</span>, <span class="dt">scopes =</span> <span class="st">"https://www.googleapis.com/auth/cloud-platform"</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">## or if using the build email..</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># gar_gce_auth("{project-number@cloudbuild.gserviceaccount.com}", </span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#                scopes = "https://www.googleapis.com/auth/cloud-platform")</span></span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="kw">gcs_list_buckets</span>(<span class="st">"my_project"</span>)</span>
<span id="cb4-10"><a href="#cb4-10"></a>auth_file &lt;-<span class="st"> </span><span class="kw">gcs_get_object</span>(<span class="st">"config.json"</span>, <span class="dt">bucket =</span> <span class="st">"my-bucket"</span>)</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a>...do something with the config file...</span></code></pre></div>
<p>This would then be saved to an R script and deployed via the gadget or:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span><span class="op">(</span><span class="st">"the_script.R"</span>, r_image <span class="op">=</span> <span class="st">"gcr.io/gcer-public/googleauthr-verse"</span><span class="op">)</span></code></pre></div>
<p>…where the docker R image is one with googleCloudStorageR installed.</p>
</div>
</div>
<div id="run-an-r-script-save-results-to-github" class="section level2">
<h2 class="hasAnchor">
<a href="#run-an-r-script-save-results-to-github" class="anchor"></a>Run an R script, save results to GitHub</h2>
<p>This is inspired by this post by Simon Couch on how to <a href="https://blog.simonpcouch.com/blog/r-github-actions-commit/">run R scripts on a schedule with GitHub Actions</a>, giving an alternative with Cloud Build.</p>
<p>The work flow looks to:</p>
<ul>
<li>Run your R code, save the object</li>
<li>Commit that object to GitHub</li>
<li>Run it on a schedule</li>
</ul>
<p>It assumes you have set-up googleCloudRunner via <code><a href="../reference/cr_setup.html">cr_setup()</a></code> for Cloud Builds and Cloud Scheduler, and have saved your git credentials previously to Secret Manager called “github-ssh”.</p>
<div id="create-the-cloudbuild-yaml" class="section level3">
<h3 class="hasAnchor">
<a href="#create-the-cloudbuild-yaml" class="anchor"></a>Create the cloudbuild.yaml</h3>
<p>For this we first need to create build steps that run the R code and commit the results back to a repo.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># can be R file location or in-line code</span>
<span class="va">r_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x &lt;- rnorm(1:10)"</span>,
            <span class="st">"dir.create('data-raw')"</span>,
            <span class="st">"save(x, file = paste0('data-raw/data_', make.names(Sys.time()), '.Rda'))"</span><span class="op">)</span>

<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="co"># assumes you have git credentials saved to Secret Manager</span>
  <span class="fu"><a href="../reference/cr_buildstep_gitsetup.html">cr_buildstep_gitsetup</a></span><span class="op">(</span><span class="st">"github-ssh"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_gitsetup.html">cr_buildstep_git</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"clone"</span>,
                     <span class="st">"git@github.com:$_GITHUB_REPO"</span>,
                     <span class="st">"payload"</span><span class="op">)</span><span class="op">)</span>,
  <span class="co"># run the R code above - could also be a file in the github repo</span>
  <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span><span class="va">r_code</span>, id <span class="op">=</span> <span class="st">"run r code"</span>, dir <span class="op">=</span> <span class="st">"payload"</span><span class="op">)</span>,
  <span class="co"># could put the git commands in one cr_buildstep_bash step for brevity</span>
  <span class="fu"><a href="../reference/cr_buildstep_gitsetup.html">cr_buildstep_git</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"add"</span>,<span class="st">"--all"</span><span class="op">)</span>, dir <span class="op">=</span> <span class="st">"payload"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_gitsetup.html">cr_buildstep_git</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"commit"</span>, <span class="st">"-a"</span>, <span class="st">"-m"</span>, 
                     <span class="st">"Ran R script to add data $BUILD_ID"</span><span class="op">)</span>,
                   dir <span class="op">=</span> <span class="st">"payload"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_gitsetup.html">cr_buildstep_git</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"push"</span>, <span class="st">"git@github.com:$_GITHUB_REPO"</span><span class="op">)</span>, dir <span class="op">=</span> <span class="st">"payload"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># using a substitution var for the GitHub repo to make it more portable</span>
<span class="va">build_yaml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="va">bs</span>,
  substitutions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>`_GITHUB_REPO`<span class="op">=</span><span class="st">"MarkEdmondson1234/r-code-commit-github"</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Debug and test if the script works first by sending to <code><a href="../reference/cr_build.html">cr_build()</a></code> - this pops up the build log in your browser.</p>
<p><img src="r-2-git-build.png"></p>
<p>For example, when doing this I found I had to modify my code to create the data folder in R and clone to “payload” directory.</p>
<p>See some <a href="https://github.com/MarkEdmondson1234/r-code-commit-github/commits/main">commits to my test repo here</a>.</p>
<p><img src="r-2-git-commits.png"></p>
</div>
<div id="schedule-the-build" class="section level3">
<h3 class="hasAnchor">
<a href="#schedule-the-build" class="anchor"></a>Schedule the build</h3>
<p>Now the build needs a schedule. Taking a working YAML configuration, we use that to create the API call for Cloud Scheduler that will run the build periodically:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># your running successful build</span>
<span class="va">build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span><span class="op">(</span><span class="va">build_yaml</span><span class="op">)</span>

<span class="co"># create build API call</span>
<span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span><span class="op">(</span><span class="va">build</span><span class="op">)</span>

<span class="co"># schedule the build</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"r-2-git-demo"</span>, <span class="st">"5 15 * * 0"</span>, httpTarget <span class="op">=</span> <span class="va">schedule_me</span><span class="op">)</span>
<span class="co">#==CloudScheduleJob==</span>
<span class="co">#name:  projects/xxxx/locations/europe-west1/jobs/r-2-git-demo </span>
<span class="co">#state:  ENABLED </span>
<span class="co">#httpTarget.uri:  https://cloudbuild.googleapis.com/v1/projects/xxxx/builds </span>
<span class="co">#httpTarget.httpMethod:  POST </span>
<span class="co">#userUpdateTime:  2021-01-01T07:21:44Z </span>
<span class="co">#schedule:  5 15 * * 0 </span>
<span class="co">#timezone:  Europe/Copenhagen </span></code></pre></div>
</div>
</div>
<div id="create-docker-image-of-a-package-each-commit" class="section level2">
<h2 class="hasAnchor">
<a href="#create-docker-image-of-a-package-each-commit" class="anchor"></a>Create Docker image of a package each commit</h2>
<p>If you just want a one-off Docker image, use <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> or make your own build via <code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code></p>
<p><img src="gadget_docker.png"></p>
<p>If you want the Docker image to rebuild each git commit, then you also need a build trigger. This can be enabled using <code><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger()</a></code></p>
<p>The below example builds this package’s Dockerfile upon each commit, for a Dockerfile located in the <code>cloud_build/</code> folder.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger</a></span><span class="op">(</span><span class="va">repo</span>, <span class="st">"test3"</span>, dir <span class="op">=</span> <span class="st">"cloud_build"</span><span class="op">)</span></code></pre></div>
<div id="kaniko-cache" class="section level3">
<h3 class="hasAnchor">
<a href="#kaniko-cache" class="anchor"></a>Kaniko cache</h3>
<p>A common workflow is to make lots of repeat builds of Docker images as you update the files and libraries within the Dockerfile. If this is a heavy operation it can take 20mins+ to build the image.</p>
<p>If it is a long build, consider using the <a href="https://cloud.google.com/cloud-build/docs/kaniko-cache">kaniko cache</a> option in your Docker builds. This caches each step of the Dockerfile so only those that are new are built, and can considerably speed up Docker build times.</p>
<p>To use, select the <code>kamiko_cache=TRUE</code> option in your builds:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span><span class="op">(</span><span class="st">"my_folder"</span>, kaniko_cache<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="migrate-an-existing-scheduled-docker-container" class="section level2">
<h2 class="hasAnchor">
<a href="#migrate-an-existing-scheduled-docker-container" class="anchor"></a>Migrate an existing scheduled Docker container</h2>
<p>You may have an existing Docker container containing code, that doesn’t need a public URL.</p>
<p>For example, a self-contained R script with <code>googleAnalyticsR</code> and <code>bigQueryR</code> pre-installed, that downloads data from Google Analytics and uploads it to BigQuery. This may be running on a VM from <code>googleComputeEngineR</code>, Kubernetes or Airflow KubernetesPodOperator.</p>
<p>If you give the cloud build service email the right permissions, then this can all be done on Cloud Build + Cloud Scheduler.</p>
<p>For example, say your existing container is called <code>gcr.io/my-project/my-r-script</code>. A Cloud Build could look simply like this:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"gcr.io/my-project/my-r-script"</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">r_code</span><span class="op">)</span></code></pre></div>
<p>You could add other steps if you wanted, such as sending an email when done via <code><a href="../reference/cr_buildstep_mailgun.html">cr_buildstep_mailgun()</a></code> or <code><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"gcr.io/my-project/my-r-script"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack</a></span><span class="op">(</span><span class="st">"The script run ok"</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">r_code</span>, `_SLACK_WEBHOOK` <span class="op">=</span> <span class="st">"https://your_slack_webhook"</span><span class="op">)</span></code></pre></div>
<p>To set this up in a schedule, add it to the scheduler like so:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">built</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">r_code</span>, `_SLACK_WEBHOOK` <span class="op">=</span> <span class="st">"https://your_slack_webhook"</span><span class="op">)</span>
<span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span><span class="op">(</span><span class="va">built</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"r-code-example"</span>, <span class="st">"15 8 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">schedule_me</span><span class="op">)</span></code></pre></div>
</div>
<div id="deploying-shiny-to-cloud-run" class="section level2">
<h2 class="hasAnchor">
<a href="#deploying-shiny-to-cloud-run" class="anchor"></a>Deploying Shiny to Cloud Run</h2>
<p>Due to Shiny’s stateful nature, Cloud Run is not a perfect fit for Shiny but it can be configured to run Shiny apps that scale to 0 (e.g. no cost) up to 80 connections at once to one instance. The one instance is necessary to avoid requests being sent to another Shiny container instance and losing the user session. Shiny also needs to have certain websocket features disabled.</p>
<p>This means you can’t scale to a billion like other Cloud Run apps, and need to keep an eye on the load of the Shiny app (which will depend on your code) to see if 80 connections are too much for the CPU and Memory you assign to the Cloud Run instance. However this should still be a good fit for a lot of data science applications.</p>
<p><img src="max_cpu_mem.png"></p>
<p>A minimal working example has been created by <span class="citation">@randy3k</span> here: <a href="https://github.com/randy3k/shiny-cloudrun-demo" class="uri">https://github.com/randy3k/shiny-cloudrun-demo</a> which can be deployed to Cloud Run via a fork here:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="co"># a repo with the Dockerfile template</span>
<span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/shiny-cloudrun-demo"</span><span class="op">)</span>

<span class="co"># deploy a cloud build trigger so each commit build the image</span>
<span class="fu"><a href="../reference/cr_deploy_docker_trigger.html">cr_deploy_docker_trigger</a></span><span class="op">(</span>
  <span class="va">repo</span>,
  image <span class="op">=</span> <span class="st">"shiny-cloudrun"</span>
<span class="op">)</span>

<span class="co"># deploy to Cloud Run</span>
<span class="fu"><a href="../reference/cr_run.html">cr_run</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"gcr.io/%s/shiny-cloudrun:latest"</span>,<span class="fu"><a href="../reference/cr_project_set.html">cr_project_get</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
       name <span class="op">=</span> <span class="st">"shiny-cloudrun"</span>,
       concurrency <span class="op">=</span> <span class="fl">80</span>,
       max_instances <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>If you need to change the memory for the one instance, you can use <code>cpu</code> and <code>memory</code> arguments in the <code><a href="../reference/cr_buildstep_run.html">cr_buildstep_run()</a></code> and subsequent functions such as <code><a href="../reference/cr_run.html">cr_run()</a></code>. The maximum allowed is 2 CPUs and 2 gibibytes (<code>2Gi</code>):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># deploy to Cloud Run with 2GBs of RAM per instance and 2 CPUs</span>
<span class="fu"><a href="../reference/cr_run.html">cr_run</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"gcr.io/%s/shiny-cloudrun:latest"</span>,<span class="fu"><a href="../reference/cr_project_set.html">cr_project_get</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
       name <span class="op">=</span> <span class="st">"shiny-cloudrun"</span>,
       concurrency <span class="op">=</span> <span class="fl">80</span>,
       max_instances <span class="op">=</span> <span class="fl">1</span>,
       cpu <span class="op">=</span> <span class="fl">2</span>,
       memory <span class="op">=</span> <span class="st">"2Gi"</span><span class="op">)</span></code></pre></div>
<p>Or if you have a local Shiny app in <code>shiny_cloudrun/</code> with the appropriate Dockerfile and Shiny configuration, the full Docker build and deployment pipeline can be carried out with:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># deploy the app version from this folder</span>
<span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span><span class="op">(</span><span class="st">"shiny_cloudrun/"</span>,
              remote <span class="op">=</span> <span class="st">"shiny-cloudrun2"</span>,
              tag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"latest"</span>,<span class="st">"$BUILD_ID"</span><span class="op">)</span>,
              max_instances <span class="op">=</span> <span class="fl">1</span>, <span class="co"># required for shiny</span>
              concurrency <span class="op">=</span> <span class="fl">80</span><span class="op">)</span></code></pre></div>
</div>
<div id="run-private-r-micro-services-on-cloud-run" class="section level2">
<h2 class="hasAnchor">
<a href="#run-private-r-micro-services-on-cloud-run" class="anchor"></a>Run private R micro-services on Cloud Run</h2>
<p>One strategy for running lots of parallel computation is to use an API endpoint, which can be triggered many times simultaneously.</p>
<p>Hosting the computation behind a plumber API and hosted on Cloud Run, you can control what data is worked on via URL parameters, and loop calling the API.</p>
<p>The R computation behind plumber could call other services or compute directly, although keep in mind the 15min timeout for Cloud Run API responses.</p>
<p>A demonstration is shown below:</p>
<div id="creating-the-cloud-run-deployment" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-the-cloud-run-deployment" class="anchor"></a>Creating the Cloud Run deployment</h3>
<p>The demo API queries a BigQuery database and computes a forecast for the time-series it gets back. The data is from the Covid public datasets hosted on BigQuery.</p>
<p>The plumber script below has two endpoints:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/Arithmetic.html">/</a></code> to test its running</li>
<li>
<code>/covid_traffic</code> which is fetched with parameters region and industry to specify what times-series to fetch a forecast for.</li>
</ul>
<p>We will want these to be private (e.g. only authenticated calls) since they contain potentially expensive BigQuery queries.</p>
<div id="plumber-api-script" class="section level4">
<h4 class="hasAnchor">
<a href="#plumber-api-script" class="anchor"></a>plumber API script</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"PORT"</span><span class="op">)</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>PORT <span class="op">=</span> <span class="fl">8000</span><span class="op">)</span>

<span class="co">#auth via BQ_AUTH_FILE environment argument</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">bigQueryR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">xts</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">)</span>

<span class="co">#' @get /</span>
<span class="co">#' @html</span>
<span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="st">"&lt;html&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/html&gt;"</span>
<span class="op">}</span>


<span class="co">#' @get /covid_traffic</span>
<span class="co">#' @param industry the industry to filter results down to e.g "Software"</span>
<span class="co">#' @param region the region to filter results down to e.g "Europe"</span>
<span class="kw">function</span><span class="op">(</span><span class="va">region</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">industry</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>

  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">industry</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Must supply region and industry parameters"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="co"># to handle spaces</span>
  <span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLdecode</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>
  <span class="va">industry</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLdecode</a></span><span class="op">(</span><span class="va">industry</span><span class="op">)</span>

  <span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"SELECT date, industry, percent_of_baseline FROM `bigquery-public-data.covid19_geotab_mobility_impact.commercial_traffic_by_industry`  WHERE region = '%s' order by date LIMIT 1000"</span>, <span class="va">region</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Query: "</span>, <span class="va">sql</span><span class="op">)</span>

  <span class="va">traffic</span> <span class="op">&lt;-</span> <span class="fu">bqr_query</span><span class="op">(</span>
    query <span class="op">=</span> <span class="va">sql</span>,
    datasetId <span class="op">=</span> <span class="st">"covid19_geotab_mobility_impact"</span>,
    useLegacySql <span class="op">=</span> <span class="cn">FALSE</span>,
    maxResults <span class="op">=</span> <span class="fl">10000</span>
  <span class="op">)</span>

  <span class="co"># filter to industry in R this time</span>
  <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">traffic</span><span class="op">[</span><span class="va">traffic</span><span class="op">$</span><span class="va">industry</span> <span class="op">==</span> <span class="va">industry</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"date"</span>,<span class="st">"percent_of_baseline"</span><span class="op">)</span><span class="op">]</span>

  <span class="va">tts</span> <span class="op">&lt;-</span> <span class="fu">xts</span><span class="op">(</span><span class="va">test_data</span><span class="op">$</span><span class="va">percent_of_baseline</span>,
             order.by <span class="op">=</span> <span class="va">test_data</span><span class="op">$</span><span class="va">date</span>,
             frequency <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>

  <span class="co"># replace with long running sophisticated analysis</span>
  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="op">(</span><span class="fu">auto.arima</span><span class="op">(</span><span class="va">tts</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># output a list that can be turned into JSON via jsonlite::toJSON</span>
  <span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">industry</span><span class="op">)</span>,
    x <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">x</span>,
    mean <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">mean</span>,
    lower <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">lower</span>,
    upper <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">upper</span>
  <span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Return: "</span>, <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">o</span>

<span class="op">}</span></code></pre></div>
</div>
<div id="deploy-plumber-api-as-a-private-micro-service" class="section level4">
<h4 class="hasAnchor">
<a href="#deploy-plumber-api-as-a-private-micro-service" class="anchor"></a>Deploy plumber API as a private micro-service</h4>
<p>The first step is to host the plumber API above.</p>
<p>The steps below:</p>
<ul>
<li>Download an authentication file for the script</li>
<li>Build the Docker container for the plumber API</li>
<li>Deploys the plumber API to a private Cloud Run instance</li>
<li>Creates the cloudbuild.yml and writes it to a file in the repo</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret</a></span><span class="op">(</span><span class="st">"my-auth"</span>,
      decrypted <span class="op">=</span> <span class="st">"inst/docker/parallel_cloudrun/plumber/auth.json"</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span><span class="op">(</span><span class="st">"cloudrun_parallel"</span>,
                      dir <span class="op">=</span> <span class="st">"inst/docker/parallel_cloudrun/plumber"</span>,
                      kaniko_cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span><span class="op">(</span><span class="st">"parallel-cloudrun"</span>,
                   image <span class="op">=</span> <span class="st">"gcr.io/$PROJECT_ID/cloudrun_parallel:$BUILD_ID"</span>,
                   allowUnauthenticated <span class="op">=</span> <span class="cn">FALSE</span>,
                   env_vars <span class="op">=</span> <span class="st">"BQ_AUTH_FILE=auth.json,BQ_DEFAULT_PROJECT_ID=$PROJECT_ID"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># make a buildtrigger pointing at above steps</span>
<span class="va">cloudbuild_file</span> <span class="op">&lt;-</span> <span class="st">"inst/docker/parallel_cloudrun/cloudbuild.yml"</span>
<span class="va">by</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span><span class="va">bs</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_build_write.html">cr_build_write</a></span><span class="op">(</span><span class="va">by</span>, file <span class="op">=</span> <span class="va">cloudbuild_file</span><span class="op">)</span></code></pre></div>
</div>
<div id="create-a-build-trigger-so-it-builds-upon-each-git-commit" class="section level4">
<h4 class="hasAnchor">
<a href="#create-a-build-trigger-so-it-builds-upon-each-git-commit" class="anchor"></a>Create a build trigger so it builds upon each git commit</h4>
<p>Now the cloudbuild.yml is available, a build trigger is created so that it will deploy upon each commit to this GitHub:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"MarkEdmondson1234/googleCloudRunner"</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span><span class="va">cloudbuild_file</span>,
                <span class="st">"parallel-cloudrun"</span>,
                trigger <span class="op">=</span> <span class="va">repo</span>,
                includedFiles <span class="op">=</span> <span class="st">"inst/docker/parallel_cloudrun/**"</span><span class="op">)</span></code></pre></div>
<p>The files are then committed to GitHub and the build reviewed in the GCP Console.</p>
<p>Once the builds are done, you should have a plumber API deployed with a URL similar to <code>https://parallel-cloudrun-ewjogewawq-ew.a.run.app/</code></p>
</div>
</div>
<div id="calling-the-private-plumber-api-with-a-jwt" class="section level3">
<h3 class="hasAnchor">
<a href="#calling-the-private-plumber-api-with-a-jwt" class="anchor"></a>Calling the private plumber API with a JWT</h3>
<p>Now the plumber API is up, but to call it with authentication will need a JSON Web Token, or JWT. These are supported via the <code><a href="../reference/cr_jwt_create.html">cr_jwt_create()</a></code> functions:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_run_get.html">cr_run_get</a></span><span class="op">(</span><span class="st">"parallel-cloudrun"</span><span class="op">)</span>

<span class="co"># Interact with the authenticated Cloud Run service</span>
<span class="va">the_url</span> <span class="op">&lt;-</span> <span class="va">cr</span><span class="op">$</span><span class="va">status</span><span class="op">$</span><span class="va">url</span>
<span class="va">jwt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_create</a></span><span class="op">(</span><span class="va">the_url</span><span class="op">)</span>

<span class="co"># needs to be recreated every 60mins</span>
<span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_token</a></span><span class="op">(</span><span class="va">jwt</span>, <span class="va">the_url</span><span class="op">)</span>

<span class="co"># call Cloud Run with token using httr call</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr.r-lib.org/">httr</a></span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_with_httr</a></span><span class="op">(</span>
  <span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="st">"https://parallel-cloudrun-ewjogewawq-ew.a.run.app/"</span><span class="op">)</span>,
  <span class="va">token</span><span class="op">)</span>
<span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></code></pre></div>
<p>The JWT token needs renewing each hour.</p>
<div id="use-your-private-micro-service" class="section level4">
<h4 class="hasAnchor">
<a href="#use-your-private-micro-service" class="anchor"></a>Use your private micro-service</h4>
<p>The above shows you can call the API’s test endpoint, but now we wish to call the API many times with the parameters to filter to the data we want.</p>
<p>This is facilitated by a wrapper function to call our API:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># interact with the API we made</span>
<span class="va">call_api</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">region</span>, <span class="va">industry</span>, <span class="va">token</span><span class="op">)</span><span class="op">{</span>
  <span class="va">api</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span>
    <span class="st">"https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=%s&amp;industry=%s"</span>,
    <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLencode</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLencode</a></span><span class="op">(</span><span class="va">industry</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Request: "</span>, <span class="va">api</span><span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_with_httr</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">api</span><span class="op">)</span>,<span class="va">token</span><span class="op">)</span>

  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">res</span>, as <span class="op">=</span> <span class="st">"text"</span>, encoding <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span>

<span class="op">}</span>

<span class="co"># test call</span>
<span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">call_api</span><span class="op">(</span>region <span class="op">=</span> <span class="st">"Europe"</span>, industry <span class="op">=</span> <span class="st">"Software"</span>, token <span class="op">=</span> <span class="va">token</span><span class="op">)</span></code></pre></div>
<p>Once the test call is complete, you can loop over your data - the parameters for this particular dataset are shown below:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># the variables to loop over</span>
<span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"North America"</span>, <span class="st">"Europe"</span>,<span class="st">"South America"</span>,<span class="st">"Australia"</span><span class="op">)</span>
<span class="va">industry</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Transportation (non-freight)"</span>,
              <span class="st">"Software"</span>,
              <span class="st">"Telecommunications"</span>,
              <span class="st">"Manufacturing"</span>,
              <span class="st">"Real Estate"</span>,
              <span class="st">"Government"</span>,
              <span class="st">"Construction"</span>,
              <span class="st">"Holding Companies &amp; Conglomerates"</span>,
              <span class="st">"Freight &amp; Logistics Services"</span>,
              <span class="st">"Agriculture"</span>,
              <span class="st">"Retail"</span>,
              <span class="st">"Consumer Services"</span>,
              <span class="st">"Hospitality"</span>,
              <span class="st">"Business Services"</span>,
              <span class="st">"Waste Treatment, Environmental Services &amp; Recycling"</span>,
              <span class="st">"Energy &amp; Utilities"</span>,
              <span class="st">"Education"</span>,
              <span class="st">"Insurance"</span>,
              <span class="st">"Media &amp; Internet"</span>,
              <span class="st">"Minerals &amp; Mining"</span>,
              <span class="st">"Healthcare Services &amp; Hospitals"</span>,
              <span class="st">"Organizations"</span>,
              <span class="st">"Finance"</span><span class="op">)</span></code></pre></div>
</div>
<div id="parallel-calling-of-the-api" class="section level4">
<h4 class="hasAnchor">
<a href="#parallel-calling-of-the-api" class="anchor"></a>Parallel calling of the API</h4>
<p>For parallel processing, ideally you don’t want R to block waiting for the HTTP response for each URL you are sending. This is easiest achieved through using <a href="https://jeroen.cran.dev/curl"><code>curl</code></a> and its <a href="https://cran.r-project.org/web/packages/curl/vignettes/intro.html#async_requests"><code>curl_fetch_multi()</code></a> function.</p>
<p>A helper function that takes care of adding multiple URLs to the same curl pool is <code><a href="../reference/cr_jwt_create.html">cr_jwt_with_curl()</a></code> - if you pass it a vector of URL strings to call and the token, it will attempt to call all of them at the same time.</p>
<p>An example calling each possible combination of the industries/regions above is shown below, which utilises <code><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid()</a></code> to create the URL variations.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## curl multi asynch</span>

<span class="co"># function to make the URLs</span>
<span class="va">make_urls</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">regions</span>, <span class="va">industry</span><span class="op">)</span><span class="op">{</span>

  <span class="va">combos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">regions</span>, <span class="va">industry</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=%s&amp;industry=%s"</span>,<span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLencode</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLencode</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>,
                SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span>, USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span>,
         <span class="va">combos</span><span class="op">$</span><span class="va">Var1</span> ,<span class="va">combos</span><span class="op">$</span><span class="va">Var2</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># make all the URLs</span>
<span class="va">all_urls</span> <span class="op">&lt;-</span> <span class="fu">make_urls</span><span class="op">(</span>regions <span class="op">=</span> <span class="va">regions</span>, industry <span class="op">=</span> <span class="va">industry</span><span class="op">)</span>

<span class="co"># calling them</span>
<span class="fu"><a href="../reference/cr_jwt_create.html">cr_jwt_async</a></span><span class="op">(</span><span class="va">all_urls</span>, token <span class="op">=</span> <span class="va">token</span><span class="op">)</span></code></pre></div>
<p>Some example output is shown below - not that some combinations didn’t have data so the API returned a 500 error, but later valid combinations completed and returned the JSON response for the forecast:</p>
<pre><code>&gt; # calling them
&gt; cr_jwt_async(all_urls, token = token)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=North%20America&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=Europe&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=South%20America&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=Australia&amp;industry=Transportation%20(non-freight)
ℹ 2020-09-20 21:58:06 &gt; Calling asynch:  https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=North%20America&amp;industry=Software
ℹ 2020-09-20 21:58:13 &gt; 500 failure for request https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=North%20America&amp;industry=Software
ℹ 2020-09-20 21:58:13 &gt; 500 failure for request https://parallel-cloudrun-ewjogewawq-ew.a.run.app/covid_traffic?region=Australia&amp;industry=Transportation%20(non-freight)
[[1]]
[1] "{\"params\":[\"North America\",\"Transportation (non-freight)\"],\"x\":[100,99,108,104,105,104,105,102,102,108,104,105,104,105,99,98,59,78,78,78,78,100,100,108,106,105,105,105,100,103,109,104,104,105,106,103,102,108,104,104,103,100,96,97,67,64,62,60,59],\"mean\":[64.031,68.3173,71.9691,75.0803,77.731,79.9894,81.9135,83.5527,84.9493,86.1392],\"lower\":[[52.8354,46.9089],[53.6094,45.8236],[55.1655,46.2703],[56.9063,47.2856],[58.6237,48.5089],[60.2322,49.7734],[61.6977,50.9961],[63.0104,52.136],[64.1733,53.1751],[65.1951,54.108]],\"upper\":[[75.2265,81.1531],[83.0251,90.8109],[88.7726,97.6679],[93.2543,102.8751],[96.8384,106.9531],[99.7466,110.2054],[102.1292,112.8308],[104.095,114.9694],[105.7254,116.7235],[107.0833,118.1704]]}"

[[2]]
[1] "{\"params\":[\"South America\",\"Transportation (non-freight)\"],\"x\":[14,13,12,9,13,17,19,15,11,14,15,16,16,14,11,15,19,18,16,16,12,18,21,18,18,12,18,19,18,19,16,15,17,20,21,20,18,24,26,25,18,22,19,17,21,24,20,19,19,23,27,27,24,22,17,24,26,24,20,18,21,24,23,20,26,19,20,17,21,26,23,19,17,27,23,20,21,22,17,26,23,20,18,21,19,18,28,22,18,24,15,21,27,21,21],\"mean\":[19.7145,21.4333,23.6604,24.1475,22.5433,20.6944,20.6384,22.468,24.3021,24.3207],\"lower\":[[15.9943,14.0249],[17.6591,15.6611],[19.8826,17.8828],[20.3669,18.3656],[18.7179,16.6929],[16.7392,14.6454],[16.566,14.4103],[18.3612,16.1872],[20.1922,18.0166],[20.2036,18.0241]],\"upper\":[[23.4346,25.404],[25.2075,27.2054],[27.4381,29.438],[27.928,29.9293],[26.3686,28.3936],[24.6495,26.7433],[24.7107,26.8665],[26.5747,28.7487],[28.412,30.5876],[28.4378,30.6173]]}"

[[3]]
[1] "{\"params\":[\"Europe\",\"Transportation (non-freight)\"],\"x\":[40,52,55,50,52,44,59,55,54,60,63,43,54,49,46,38,64,55,53,51,58,61,42,43,40,54,53,60,63,54,44,43,52,38,53,51,47,53,58,44,54,62,56,59,63,48,62,66,60,68,73,69,71,77,77,63,66],\"mean\":[68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688,68.5688],\"lower\":[[58.5753,53.2851],[58.1036,52.5637],[57.6523,51.8735],[57.2189,51.2107],[56.8015,50.5723],[56.3984,49.9558],[56.0082,49.359],[55.6297,48.7802],[55.2621,48.2179],[54.9043,47.6707]],\"upper\":[[78.5622,83.8525],[79.0339,84.5738],[79.4852,85.2641],[79.9186,85.9269],[80.3361,86.5653],[80.7392,87.1818],[81.1294,87.7786],[81.5078,88.3573],[81.8755,88.9196],[82.2333,89.4668]]}"</code></pre>
</div>
</div>
</div>
<div id="trigger-an-r-function-from-pubsub" class="section level2">
<h2 class="hasAnchor">
<a href="#trigger-an-r-function-from-pubsub" class="anchor"></a>Trigger an R function from pub/sub</h2>
<p>This uses <code>cr_deploy_plumber</code> to deploy an R API that can then be triggered from pub/sub events, such as Cloud logging events or when files get updated in a Cloud Storage bucket. This in turn can trigger other Cloud Builds.</p>
<p>A plumber API that accepts pub/sub messages is facilitated by <code><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub()</a></code></p>
<p><code>api.R</code>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example function echos back pubsub message</span>
<span class="co"># change to do something more interesting with event data</span>
<span class="va">pub</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Echo:"</span>, <span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#' Receive pub/sub message</span>
<span class="co">#' @post /pubsub</span>
<span class="co">#' @param message a pub/sub message</span>
<span class="kw">function</span><span class="op">(</span><span class="va">message</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>
  <span class="fu">googleCloudRunner</span><span class="fu">::</span><span class="fu"><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub</a></span><span class="op">(</span><span class="va">message</span>, <span class="va">pub</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Deploy the R API using an image that has plumber and googleCloudRunner installed. There is one available at <code>gcr.io/gcer-public/googlecloudrunner</code></p>
<p><code>Dockerfile</code>:</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master

COPY [".", "./"]

ENTRYPOINT ["R", "-e", "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"]
CMD ["api.R"]</code></pre>
<p>Put both the Dockerfile and the <code>api.R</code> script in the same folder then deploy it to Cloud Run:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span><span class="op">(</span><span class="st">"the_folder"</span><span class="op">)</span></code></pre></div>
<p>Or use the RStudio gadget:</p>
<p><img src="gadget_plumber.png"></p>
<p>Once built you will have a pub/sub live that will trigger the function you defined. You can test pubsub messages via <code><a href="../reference/cr_pubsub.html">cr_pubsub()</a></code></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test_url</span> <span class="op">&lt;-</span> <span class="st">"http://your-cloudrun-api.com/pubsub"</span>

<span class="fu"><a href="../reference/cr_pubsub.html">cr_pubsub</a></span><span class="op">(</span><span class="va">test_url</span>, <span class="st">"hello"</span><span class="op">)</span>
<span class="co"># [1] "Echo: hello"</span></code></pre></div>
<p>In this case the function only echos, but you can modify the function to call other libraries, functions, operate on data sent in pubsub such as bucket object names, BigQuery tableIds, etc.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># perhaps the function calls another Cloud Build</span>
<span class="va">pub</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">x</span>, source <span class="op">=</span> <span class="va">my_source</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>If you would like to trigger a pub/sub message when a file arrives on Google Cloud Storage, use <code><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_create_pubsub.html">googleCloudStorageR::gcs_create_pubsub()</a></code></p>
</div>
<div id="deploy-a-shiny-app-to-google-kubernetes-engine" class="section level2">
<h2 class="hasAnchor">
<a href="#deploy-a-shiny-app-to-google-kubernetes-engine" class="anchor"></a>Deploy a Shiny app to Google Kubernetes Engine</h2>
<p>If you have a Shiny app and a Google Kubernetes Engine (GKE) instance you can automate deployment of that app upon each git commit.</p>
<p>Each commit the buildsteps need to re-build the Docker container with the Shiny app code and environment, then deploy it to the GKE instance.</p>
<div id="dockerfile" class="section level3">
<h3 class="hasAnchor">
<a href="#dockerfile" class="anchor"></a>Dockerfile</h3>
<p>Assuming you have a shiny app in <code>./shiny/</code> relative to the Dockerfile, then a Dockerfile could look like:</p>
<pre><code>FROM rocker/shiny

# install R package dependencies
RUN apt-get update &amp;&amp; apt-get install -y \
    libssl-dev \
    ## clean up
    &amp;&amp; apt-get clean \
    &amp;&amp; rm -rf /var/lib/apt/lists/ \
    &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rds

## Install packages from CRAN
RUN install2.r --error \
    -r 'http://cran.rstudio.com' \
        remotes \
        shinyjs \
    ## install Github packages
    &amp;&amp; installGithub.r MarkEdmondson1234/googleCloudRunner \
    ## clean up
    &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rds

## assume shiny app is in build folder /shiny
COPY ./shiny/ /srv/shiny-server/my-app/</code></pre>
<p>Depending on how your ingress is setup, this would appear on your Kubernetes cluster at <code>/my-app/</code> - see this blog post on details for <a href="https://code.markedmondson.me/r-on-kubernetes-serverless-shiny-r-apis-and-scheduled-scripts/">setting up R on Kubernetes</a></p>
</div>
<div id="kubernetes-deployment-file" class="section level3">
<h3 class="hasAnchor">
<a href="#kubernetes-deployment-file" class="anchor"></a>Kubernetes deployment file</h3>
<p>You can then also have a deployment file for Kubernetes that will govern its configuration after the new docker image is built. An example deployment file is below:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> extensions/v1beta1</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> shiny-your-app</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> shiny-your-app</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="at">  </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb30-11"><a href="#cb30-11"></a><span class="at">    </span><span class="fu">rollingUpdate</span><span class="kw">:</span></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="at">      </span><span class="fu">maxSurge</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb30-13"><a href="#cb30-13"></a><span class="at">      </span><span class="fu">maxUnavailable</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb30-14"><a href="#cb30-14"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> RollingUpdate</span></span>
<span id="cb30-15"><a href="#cb30-15"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb30-16"><a href="#cb30-16"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb30-17"><a href="#cb30-17"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb30-18"><a href="#cb30-18"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> shiny-your-app</span></span>
<span id="cb30-19"><a href="#cb30-19"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb30-20"><a href="#cb30-20"></a><span class="at">      </span><span class="fu">nodeSelector</span><span class="kw">:</span></span>
<span id="cb30-21"><a href="#cb30-21"></a><span class="at">        </span><span class="fu">cloud.google.com/gke-nodepool</span><span class="kw">:</span><span class="at"> generic-compute-pool</span></span>
<span id="cb30-22"><a href="#cb30-22"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb30-23"><a href="#cb30-23"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlog</span></span>
<span id="cb30-24"><a href="#cb30-24"></a><span class="at">        </span><span class="fu">emptyDir</span><span class="kw">:</span></span>
<span id="cb30-25"><a href="#cb30-25"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb30-26"><a href="#cb30-26"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> shiny-your-app</span></span>
<span id="cb30-27"><a href="#cb30-27"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> gcr.io/your-project/shiny-your-app:latest</span></span>
<span id="cb30-28"><a href="#cb30-28"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb30-29"><a href="#cb30-29"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">3838</span></span>
<span id="cb30-30"><a href="#cb30-30"></a><span class="at">        </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb30-31"><a href="#cb30-31"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> varlog</span></span>
<span id="cb30-32"><a href="#cb30-32"></a><span class="at">          </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /var/log/shiny-server/</span></span></code></pre></div>
</div>
<div id="cloud-build" class="section level3">
<h3 class="hasAnchor">
<a href="#cloud-build" class="anchor"></a>Cloud Build</h3>
<p>Your cloudbuild steps will then build the Dockerfile, then use <code>gcr.io/cloud-builders/gke-deploy</code> to deploy it to the cluster - see this <a href="https://cloud.google.com/cloud-build/docs/deploying-builds/deploy-gke">Google guide on deployment to GKE via Cloud Build</a> for details</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>

<span class="va">bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span><span class="op">(</span><span class="st">"shiny-your-app"</span>,
                      tag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"latest"</span>,<span class="st">"$SHORT_SHA"</span><span class="op">)</span>,
                      kaniko_cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span><span class="st">"gke-deploy"</span>,
               args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"run"</span>,
                        <span class="st">"--filename=deployment-k8s.yml"</span>,
                        <span class="st">"--image=gcr.io/$PROJECT_ID/shiny-your-app:$SHORT_SHA"</span>,
                        <span class="st">"--location=europe-west1-b"</span>,
                        <span class="st">"--cluster=your-k8s-cluster"</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">yaml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>steps <span class="op">=</span> <span class="va">bs</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_build_write.html">cr_build_write</a></span><span class="op">(</span><span class="va">yaml</span>, <span class="st">"build/cloudbuild.yml"</span><span class="op">)</span></code></pre></div>
<p>In this example we write the cloudbuild.yml to a build folder rather than making an inline build trigger deployment. This is setup in a Build Trigger upon GitHub commit with the code below:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">repo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span><span class="op">(</span><span class="st">"your-name/your-repo-with-shiny"</span><span class="op">)</span>

<span class="co"># test build by pushing to git after this trigger made</span>
<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span><span class="op">(</span><span class="st">"build/cloudbuild.yml"</span>,
                name <span class="op">=</span> <span class="st">"deploy-my-shiny-app"</span>,
                trigger <span class="op">=</span> <span class="va">repo</span><span class="op">)</span></code></pre></div>
<p>All together the git repo folder looks like:</p>
<pre><code>|
|- build/
   | - cloudbuild.yml
|- deployment-k8s.yml
|- Dockerfile
|- shiny/
   | - app.R</code></pre>
<p>As you update the code in <code>app.R</code> and push to GitHub, the build trigger builds the Docker image and publishes it to the kubernetes cluster. The docker is built using kaniko cache, which speeds up repeat builds and deployments.</p>
</div>
</div>
<div id="run-r-code-when-a-pubsub-message-is-created-from-a-new-file-in-google-cloud-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#run-r-code-when-a-pubsub-message-is-created-from-a-new-file-in-google-cloud-storage" class="anchor"></a>Run R code when a pub/sub message is created from a new file in Google Cloud Storage</h2>
<p>This is a demo to show how to make use of <a href="https://cloud.google.com/pubsub/docs/overview">Pub/Sub messages</a>. Pub/Sub messages are used throughout the Google Cloud Platform, for this example we will use one for when a new object is created in a Google Cloud Storage bucket.</p>
<p>A video walkthrough of the below is available <a href="https://www.youtube.com/watch?v=MoKHsFr1B88">here</a></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/MoKHsFr1B88" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<div id="the-plumber-api-with-pubsub" class="section level3">
<h3 class="hasAnchor">
<a href="#the-plumber-api-with-pubsub" class="anchor"></a>The plumber API with pub/sub</h3>
<p>The API endpoint in plumber needs an endpoint to recieve Pub/Sub messages, then an R function to process and do what you want with that message. In this case we shall email the file name to an end user. This could be expanded to do some R analysis, or what ever you need.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Send an email via mailgun</span>
<span class="va">send_email</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">message</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"sending email with message: "</span>, <span class="va">message</span><span class="op">)</span>

  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"MAILGUN_URL"</span><span class="op">)</span>,<span class="st">"/messages"</span><span class="op">)</span>,
             <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/authenticate.html">authenticate</a></span><span class="op">(</span><span class="st">"api"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"MAILGUN_KEY"</span><span class="op">)</span><span class="op">)</span>,
             encode <span class="op">=</span> <span class="st">"form"</span>,
             body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
               from<span class="op">=</span><span class="st">"googlecloudrunner@you.me"</span>,
               to<span class="op">=</span><span class="st">"test@you.me"</span>,
               subject<span class="op">=</span><span class="st">"Message from Pub/Sub"</span>,
               text<span class="op">=</span><span class="va">message</span>
             <span class="op">)</span><span class="op">)</span>

  <span class="cn">TRUE</span>
<span class="op">}</span>

<span class="co">#' Recieve pub/sub message</span>
<span class="co">#' @post /pubsub</span>
<span class="co">#' @param message a pub/sub message</span>
<span class="kw">function</span><span class="op">(</span><span class="va">message</span><span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">{</span>

  <span class="va">pub</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="va">o</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Echo:"</span>, <span class="va">o</span><span class="op">)</span>
    <span class="fu">send_email</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"We got this file: "</span>, <span class="va">o</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="fu">googleCloudRunner</span><span class="fu">::</span><span class="fu"><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub</a></span><span class="op">(</span><span class="va">message</span>, <span class="va">pub</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>The above script relies on two environment arguments with the Mailgun keys, which can be set in the Cloud Run interface once a deployment is live. The environment arguments persist inbetween versions so you only need to set this up once.</p>
<p>For this example, the Dockerfile is a standard one with plumber and googleCloudRunner installed - you may need to add your own dependencies:</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master
COPY ["./", "./"]
ENTRYPOINT ["R", "-e", "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"]
CMD ["api.R"]</code></pre>
</div>
<div id="deployment" class="section level3">
<h3 class="hasAnchor">
<a href="#deployment" class="anchor"></a>Deployment</h3>
<p>This can be deployed via the RStudio Addin, or via the code below:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span><span class="op">(</span><span class="st">"folder/with-api/"</span>, 
                  image_name <span class="op">=</span> <span class="st">"gcs-pubsub"</span><span class="op">)</span></code></pre></div>
<p>After the first deployment, go to the web UI and <code>Deploy New Revision</code> - keep everything the same but update the environment arguments. These will persist for future revisions:</p>
<p><img src="cloudrun-environment-args.png"></p>
<p>You can test the Pub/Sub API is working from R with the below code:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/cr_pubsub.html">cr_pubsub</a></span><span class="op">(</span><span class="st">"https://your-cloudendpoint.run.app/pubsub"</span>,
          <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"test_file_from_r"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="setup-pubsub" class="section level3">
<h3 class="hasAnchor">
<a href="#setup-pubsub" class="anchor"></a>Setup Pub/Sub</h3>
<p>To activate Pub/Sub messages from a Google Cloud Storage bucket, use a service account with Cloud Storage Admin rights (note not Cloud Storage Object Admin).</p>
<p>In the Web UI of Pub/Sub set up a Topic:</p>
<p><img src="pubsub-topic.png"></p>
<p>You can only setup cloud storage pub/sub messages to this topic using the API, which can be done using <code>googleCloudStorageR::gce_create_pubsub()</code>:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudStorageR/">googleCloudStorageR</a></span><span class="op">)</span>
<span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_create_pubsub.html">gcs_create_pubsub</a></span><span class="op">(</span><span class="st">"your-topic"</span>, <span class="st">"your-project"</span>, <span class="st">"your-bucket"</span><span class="op">)</span></code></pre></div>
<p>Each topic can have many subscriptions. One of these will push to the Cloud Run URL set up in the previous step:</p>
<p><img src="pubsub-sub.png"></p>
</div>
<div id="add-files-to-google-cloud-storage" class="section level3">
<h3 class="hasAnchor">
<a href="#add-files-to-google-cloud-storage" class="anchor"></a>Add files to Google Cloud Storage</h3>
<p>Now when a new file arrives into the bucket, it will:</p>
<ol style="list-style-type: decimal">
<li>Trigger a Pub/Sub to the Subscription</li>
<li>Pass on to the Pub/Sub Topic</li>
<li>Push to Cloud Run</li>
<li>Execute the plumber R code to send an email</li>
<li>Arrive in your inbox</li>
</ol>
<p>You can test it by uploading files either in the web UI or via</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">googleCloudStorageR</span><span class="fu">::</span><span class="fu"><a href="https://cloudyr.github.io/googleCloudStorageR//reference/gcs_upload.html">gcs_upload</a></span><span class="op">(</span><span class="va">mtcars</span>, bucket <span class="op">=</span> <span class="st">"your-bucket"</span>, 
                                name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"test"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You will need to setup mailgun to stop it appearing in your spam folder, by verifying your domain etc.</p>
</div>
</div>
<div id="build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#build-an-rmd-on-a-schedule-and-host-its-html-on-cloud-storage" class="anchor"></a>Build an Rmd on a schedule and host its HTML on Cloud Storage</h2>
<p>Cloud Storage can host public HTML files like a website, which can be accessed via public or private viewers. This can be useful in setting up reporting infrastructure.</p>
<p>A video of the below workflow is <a href="https://www.youtube.com/watch?v=BainmerWVb0">here</a>:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/BainmerWVb0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
<p>The Cloud Build below makes use of Cloud Build artifacts to send the built Rmd files to a public Cloud Storage bucket. The Rmd is built on a schedule to pull in new data from a Google Sheet:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rmd_build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
      <span class="st">"gsutil"</span>,
      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cp"</span>,
               <span class="st">"gs://mark-edmondson-public-read/scheduled_rmarkdown.Rmd"</span>,
               <span class="st">"scheduled_rmarkdown.Rmd"</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
      <span class="st">"gcr.io/gcer-public/render_rmd:master"</span>,
      r <span class="op">=</span> <span class="st">"rmarkdown::render('scheduled_rmarkdown.Rmd',
               output_file = 'scheduled_rmarkdown_2020.html')"</span>,
  <span class="op">)</span><span class="op">)</span>,
  artifacts <span class="op">=</span> <span class="fu"><a href="../reference/cr_build_yaml_artifact.html">cr_build_yaml_artifact</a></span><span class="op">(</span>
    <span class="st">"scheduled_rmarkdown_2020.html"</span>,
    bucket <span class="op">=</span> <span class="st">"mark-edmondson-public-read"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># test the build</span>
<span class="va">built</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">rmd_build</span><span class="op">)</span></code></pre></div>
<p>Once the build is tested, we now schedule the Rmd to build each morning, adapting to changes in the source data file.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># schedule the build</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"rmd-demo"</span>, schedule <span class="op">=</span> <span class="st">"15 5 * * *"</span>,
            httpTarget <span class="op">=</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span><span class="op">(</span><span class="va">built</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The example Rmd file is built and available on a public Cloud Storage bucket - the above example is available at this <a href="https://storage.googleapis.com/mark-edmondson-public-read/scheduled_rmarkdown.html">link</a></p>
<p><img src="schedule_markdown_hosted_gcs.png"></p>
</div>
<div id="build-and-deploy-rmd-files-to-cloud-run-on-a-schedule" class="section level2">
<h2 class="hasAnchor">
<a href="#build-and-deploy-rmd-files-to-cloud-run-on-a-schedule" class="anchor"></a>Build and deploy Rmd files to Cloud Run on a schedule</h2>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
I have a flexdashboard that shows data from a Google Sheet with ggplotly. What's the best way to host the dashboard somewhere <em>and</em> make it so it shows the latest data? i.e. how should I show dynamic data in an RMarkdown dashboard? Continually reknit? Make a plumber API? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a>
</p>
— Andrew Heiss, PhD (<span class="citation">@andrewheiss</span>) <a href="https://twitter.com/andrewheiss/status/1212408575684943878?ref_src=twsrc%5Etfw">January 1, 2020</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Cloud Run scales from 0 to millions of hits, so can be an option for hosting a website. In particular you may want a private internal website, have R code executing via a plumber API in the same container, or have lots of traffic or data that goes over other free hosting options such as GitHub pages. A nginx server configuration is included to host any HTML you provide via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>.</p>
<p>You may prefer using Cloud Storage public URLs if you don’t need any of Cloud Run’s features, like the previous example.</p>
<p>Coupled to that, a common use case is to render Rmd files and host them on a website like the tweet above. For the above tweet scenario, the Rmd has a setup block that reads from googlesheets via the code below:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb42-1"><a href="#cb42-1"></a><span class="bn">```{r setup, include=FALSE}</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="bn">library(flexdashboard)</span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="bn">library(googlesheets4)</span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="bn">library(ggplot2)</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="bn">library(plotly)</span></span>
<span id="cb42-6"><a href="#cb42-6"></a><span class="bn">library(dplyr)</span></span>
<span id="cb42-7"><a href="#cb42-7"></a></span>
<span id="cb42-8"><a href="#cb42-8"></a><span class="bn"># for public Googlesheets.  </span></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="bn"># If private see https://gargle.r-lib.org/articles/non-interactive-auth.html</span></span>
<span id="cb42-10"><a href="#cb42-10"></a><span class="bn">sheets_deauth()</span></span>
<span id="cb42-11"><a href="#cb42-11"></a></span>
<span id="cb42-12"><a href="#cb42-12"></a><span class="bn"># this is the data that may update each time the Rmd is rendered</span></span>
<span id="cb42-13"><a href="#cb42-13"></a><span class="bn">gm &lt;- sheets_example("gap") %&gt;% read_sheet()</span></span>
<span id="cb42-14"><a href="#cb42-14"></a></span>
<span id="cb42-15"><a href="#cb42-15"></a><span class="bn">gm_agg &lt;- gm %&gt;%</span></span>
<span id="cb42-16"><a href="#cb42-16"></a><span class="bn">  mutate(gdp=gdpPercap*pop) %&gt;%</span></span>
<span id="cb42-17"><a href="#cb42-17"></a><span class="bn">  filter(continent=="Africa") %&gt;%</span></span>
<span id="cb42-18"><a href="#cb42-18"></a><span class="bn">  group_by(year) %&gt;%</span></span>
<span id="cb42-19"><a href="#cb42-19"></a><span class="bn">  summarize(mean(lifeExp), mean(gdp))</span></span>
<span id="cb42-20"><a href="#cb42-20"></a></span>
<span id="cb42-21"><a href="#cb42-21"></a><span class="bn">p &lt;- ggplot(gm, aes(gdpPercap, lifeExp)) + theme_minimal() + scale_x_log10()</span></span>
<span id="cb42-22"><a href="#cb42-22"></a><span class="bn">```</span></span></code></pre></div>
<p>The build Rmd docker in this case needs all the libraries listed (flexdashboard, googlesheets4 etc.) included in its build - this could be built before hand in another Cloud Build - in this case the libraries are all in <code>gcr.io/gcer-public/render_rmd</code></p>
<p>For this example, the build is not reading from a git repo but the Rmd file is downloaded from a Cloud Storage bucket, that you may have uploaded to manually, via <code>googleCloudStorageR</code> or perhaps copied over from a repo in another Cloud Build on a Build Trigger.</p>
<p>The scheduled build then can be enabled via:</p>
<ol style="list-style-type: decimal">
<li>Uploading your Rmarkdown files to a Cloud Storage bucket</li>
<li>Create a build that will:</li>
</ol>
<ul>
<li>download the Rmd file</li>
<li>render the Rmd creating the HTML files</li>
<li>configure nginx for Cloud Run,</li>
<li>build a Docker image of nginx with your HTML</li>
<li>serve it on Cloud Run.</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r</span> <span class="op">&lt;-</span> <span class="st">"rmarkdown::render('scheduled_rmarkdown.Rmd', output_file = 'scheduled_rmarkdown.html')"</span>

<span class="va">build_rmd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
      steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
        <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
          id <span class="op">=</span> <span class="st">"download Rmd template"</span>,
          name <span class="op">=</span> <span class="st">"gsutil"</span>,
          args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cp"</span>,
                   <span class="st">"gs://mark-edmondson-public-read/scheduled_rmarkdown.Rmd"</span>,
                   <span class="st">"scheduled_rmarkdown.Rmd"</span><span class="op">)</span>,
        <span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
          id<span class="op">=</span><span class="st">"render rmd"</span>,
          r <span class="op">=</span> <span class="va">r</span>,
          name <span class="op">=</span> <span class="st">"gcr.io/gcer-public/render_rmd:master"</span>
        <span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_nginx_setup.html">cr_buildstep_nginx_setup</a></span><span class="op">(</span><span class="st">"/workspace/"</span><span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span><span class="op">(</span><span class="st">"html-on-cloudrun"</span>, tag <span class="op">=</span> <span class="st">"$BUILD_ID"</span><span class="op">)</span>,
        <span class="fu"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"my-html-on-cloudrun"</span>,
                         image <span class="op">=</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,
                         concurrency <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>
        <span class="op">)</span>, 
    images <span class="op">=</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,
    <span class="op">)</span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Run a test build to check it works.</li>
</ol>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">build_rmd</span><span class="op">)</span>
<span class="va">built</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></code></pre></div>
<p>You should see a Cloud Run URL in the logs, like this one: <code>https://my-html-on-cloudrun-ewjogewawq-ew.a.run.app/scheduled_rmarkdown.html</code></p>
<p><img src="rmd-on-cloudrun.png"></p>
<ol start="6" style="list-style-type: decimal">
<li>Schedule the build using cron syntax</li>
</ol>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span><span class="op">(</span><span class="va">built</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"rmd-on-cloudrun"</span>, <span class="st">"15 8 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">schedule_me</span><span class="op">)</span>
<span class="co">#==CloudScheduleJob==</span>
<span class="co">#name:  projects/project-name/locations/europe-west1/jobs/rmd-on-cloudrun </span>
<span class="co">#state:  ENABLED </span>
<span class="co">#httpTarget.uri:  https://cloudbuild.googleapis.com/v1/projects/project-name/builds </span>
<span class="co">#httpTarget.httpMethod:  POST </span>
<span class="co">#userUpdateTime:  2020-01-04T08:34:42Z </span>
<span class="co">#schedule:  15 8 * * * </span>
<span class="co">#timezone:  UTC </span></code></pre></div>
<div id="do-it-all-in-r-using-cr_deploy_r" class="section level3">
<h3 class="hasAnchor">
<a href="#do-it-all-in-r-using-cr_deploy_r" class="anchor"></a>Do it all in R using cr_deploy_r()</h3>
<p>An alternative if you only wanted to do a scheduled deployment would be to put all steps in an R script (downloading, building and uploading to Cloud Storage via <code>googleCloudStorageR</code>) and use the RStudio gadget or <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code></p>
<p><img src="gadget_r.png"></p>
</div>
</div>
<div id="polygot-cloud-builds---integrating-r-code-with-other-languages" class="section level2">
<h2 class="hasAnchor">
<a href="#polygot-cloud-builds---integrating-r-code-with-other-languages" class="anchor"></a>Polygot Cloud Builds - integrating R code with other languages</h2>
<p>Since Docker containers can hold any language within them, they offer a universal UI to combine languages. This offers opportunities to extend other languages with R features, and give other languages access to R code without needing to know R.</p>
<p>An example below uses:</p>
<ul>
<li>
<code>gcloud</code> - <a href="https://cloud.google.com/sdk/gcloud/">Google’s Cloud command line tool</a> to access Google’s key management store and download an authentication file, and pushes to BigQuery</li>
<li>
<code>gago</code> - <a href="https://github.com/MarkEdmondson1234/gago">A Go package for fast downloads of Google Analytics data</a>
</li>
<li>
<code>R</code> - R code to create an Rmd file that will hold interactive forecasts of the Google Analytics data via <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>
</li>
<li>
<code>nginx</code> - serve up the Rmd files rendered into HTML and hosted on Cloud Run via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>
</li>
</ul>
<p>And will perform downloading unsampled data from Google Analytics, creating a statistical report of the data and then uploading the raw data to BigQuery for further analysis.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://code.markedmondson.me/googleCloudRunner/">googleCloudRunner</a></span><span class="op">)</span>
<span class="va">polygot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span><span class="op">(</span>
  steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"download encrypted auth file"</span>,
      name <span class="op">=</span> <span class="st">"gsutil"</span>,
      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cp"</span>,
               <span class="st">"gs://marks-bucket-of-stuff/auth.json.enc"</span>,
               <span class="st">"/workspace/auth.json.enc"</span><span class="op">)</span>,
    <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"decrypt file"</span>,
      cipher <span class="op">=</span> <span class="st">"/workspace/auth.json.enc"</span>,
      plain <span class="op">=</span> <span class="st">"/workspace/auth.json"</span>,
      keyring <span class="op">=</span> <span class="st">"my-keyring"</span>,
      key <span class="op">=</span> <span class="st">"ga_auth"</span>
    <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"download google analytics"</span>,
      name <span class="op">=</span> <span class="st">"gcr.io/gcer-public/gago:master"</span>,
      env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"GAGO_AUTH=/workspace/auth.json"</span><span class="op">)</span>,
      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"reports"</span>,
               <span class="st">"--view=81416156"</span>,
               <span class="st">"--dims=ga:date,ga:medium"</span>,
               <span class="st">"--mets=ga:sessions"</span>,
               <span class="st">"--start=2014-01-01"</span>,
               <span class="st">"--end=2019-11-30"</span>,
               <span class="st">"--antisample"</span>,
               <span class="st">"--max=-1"</span>,
               <span class="st">"-o=google_analytics.csv"</span><span class="op">)</span>,
      dir <span class="op">=</span> <span class="st">"build"</span>
    <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"download Rmd template"</span>,
      name <span class="op">=</span> <span class="st">"gsutil"</span>,
      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cp"</span>,
               <span class="st">"gs://mark-edmondson-public-read/polygot.Rmd"</span>,
               <span class="st">"/workspace/build/polygot.Rmd"</span><span class="op">)</span>
    <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span><span class="op">(</span>
      id<span class="op">=</span><span class="st">"render rmd"</span>,
      r <span class="op">=</span> <span class="st">"lapply(list.files('.', pattern = '.Rmd', full.names = TRUE),
             rmarkdown::render, output_format = 'html_document')"</span>,
      name <span class="op">=</span> <span class="st">"gcr.io/gcer-public/packagetools:latest"</span>,
      dir <span class="op">=</span> <span class="st">"build"</span>
      <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep_bash.html">cr_buildstep_bash</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"setup nginx"</span>,
      bash_script <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"docker"</span>, <span class="st">"nginx"</span>, <span class="st">"setup.bash"</span>,
                                package <span class="op">=</span> <span class="st">"googleCloudRunner"</span><span class="op">)</span>,
      dir <span class="op">=</span> <span class="st">"build"</span>
      <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span><span class="op">(</span>
      <span class="co"># change to your own container registry</span>
      image <span class="op">=</span> <span class="st">"gcr.io/gcer-public/polygot_demo"</span>,
      tag <span class="op">=</span> <span class="st">"latest"</span>,
      dir <span class="op">=</span> <span class="st">"build"</span>
      <span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span><span class="op">(</span>
      name <span class="op">=</span> <span class="st">"polygot-demo"</span>,
      image <span class="op">=</span> <span class="st">"gcr.io/gcer-public/polygot_demo"</span>,
      concurrency <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span><span class="op">(</span>
      id <span class="op">=</span> <span class="st">"load BigQuery"</span>,
      name <span class="op">=</span> <span class="st">"gcr.io/google.com/cloudsdktool/cloud-sdk:alpine"</span>,
      entrypoint <span class="op">=</span> <span class="st">"bq"</span>,
      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"--location=EU"</span>,
               <span class="st">"load"</span>,
               <span class="st">"--autodetect"</span>,
               <span class="st">"--source_format=CSV"</span>,
               <span class="st">"test_EU.polygot"</span>,
               <span class="st">"google_analytics.csv"</span>
               <span class="op">)</span>,
      dir <span class="op">=</span> <span class="st">"build"</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="co"># build the polygot cloud build steps</span>
<span class="va">build</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span><span class="op">(</span><span class="va">polygot</span><span class="op">)</span>
<span class="va">built</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span><span class="op">(</span><span class="va">build</span><span class="op">)</span></code></pre></div>
<p>An example of the demo output is on this Cloud Run instance URL: <code>https://polygot-demo-ewjogewawq-ew.a.run.app/polygot.html</code></p>
<p><img src="polygot-html.png"></p>
<p>It also uploads the data to a BigQuery table:</p>
<p><img src="polygot-bq-load.png"></p>
<p>This constructed cloud build can also be used outside of R, by writing out the Cloud Build file via <code><a href="../reference/cr_build_write.html">cr_build_write()</a></code></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># write out to cloudbuild.yaml for other languages</span>
<span class="fu"><a href="../reference/cr_build_write.html">cr_build_write</a></span><span class="op">(</span><span class="va">polygot</span><span class="op">)</span>
<span class="co"># 2019-12-28 19:15:50&gt; Writing to cloudbuild.yaml</span></code></pre></div>
<p>This can then be scheduled as described in Cloud Scheduler section on <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudscheduler.html">scheduled cloud builds</a>.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schedule_me</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span><span class="op">(</span><span class="va">built</span><span class="op">)</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span><span class="op">(</span><span class="st">"polygot-example"</span>, <span class="st">"15 8 * * *"</span>, httpTarget <span class="op">=</span> <span class="va">schedule_me</span><span class="op">)</span></code></pre></div>
<p>An example of the cloudbuild.yaml is on GitHub <a href="https://raw.githubusercontent.com/MarkEdmondson1234/googleCloudRunner/master/inst/polygot/cloudbuild.yaml">here</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
