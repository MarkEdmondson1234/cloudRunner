<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example Use Cases for googleCloudRunner â€¢ googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example Use Cases for googleCloudRunner">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.9004</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Example Use Cases for googleCloudRunner</h1>
            
            <h4 class="date">2020-01-03</h4>
      
      
      <div class="hidden name"><code>usecases.Rmd</code></div>

    </div>

    
    
<p>Here will be some example use cases you can use googleCloudRunner for.</p>
<p>Since almost any code can be called and passed via Docker images, there are a lot of potential uses.</p>
<ul>
<li>Scheduling R scripts in the cloud</li>
<li>R APIs to call from anywhere</li>
<li>Triggering R code to run on events, such as BigQuery table updates or GitHub pushes</li>
<li>Checking a package, creating a website, deploying it to GitHub</li>
<li>Running authenticated tests for R packages in private environment</li>
<li>Creating an Rmarkdown powered website using Cloud Run</li>
<li>Integrating R with other language applications</li>
<li>Public and private Docker image creations on triggers</li>
</ul>
<p>Some <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community">community contributed Cloud Build images are listed here</a>, including <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/hugo">hugo</a>, <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/make">make</a>, and <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/tar">tar</a>.</p>
<div id="create-docker-image-of-a-package-each-commit" class="section level2">
<h2 class="hasAnchor">
<a href="#create-docker-image-of-a-package-each-commit" class="anchor"></a>Create Docker image of a package each commit</h2>
<p>If you just want a one-off Docker image, use <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> or make your own build via <code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code></p>
<p>If you want the Docker image to rebuild each git commit, this is what is used to deploy this package to <code>gcr.io/gcer-public/googlecloudrunner</code> - in this case the Dockerfile in the root of the repo is built. Simply place the Dockerfile in the root of your repo, and then create a Build Trigger with similar settings:</p>
<p><img src="build_dockerfile.png"></p>
</div>
<div id="trigger-an-r-function-from-pubsub" class="section level2">
<h2 class="hasAnchor">
<a href="#trigger-an-r-function-from-pubsub" class="anchor"></a>Trigger an R function from pubsub</h2>
<p>This uses <code>cr_deploy_plumber</code> to deploy an R API that can then be triggered from pub/sub events, such as Cloud logging events or when files get updated in a Cloud Storage bucket. This in turn can trigger other Cloud Builds.</p>
<p>A plumber API that accepts pub/sub messages is facilitated by <code><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub()</a></code></p>
<p><code>api.R</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># example function echos back pubsub message</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co"># change to do something more interesting with event data</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">pub &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Echo:"</span>, x)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#' Recieve pub/sub message</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#' @post /pubsub</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#' @param message a pub/sub message</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="cf">function</span>(<span class="dt">message=</span><span class="ot">NULL</span>){</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  googleCloudRunner<span class="op">::</span><span class="kw"><a href="https://code.markedmondson.me/googleCloudRunner/reference/cr_plumber_pubsub.html">cr_plumber_pubsub</a></span>(message, pub)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">}</a></code></pre></div>
<p>Deploy the R API using an image that has plumber and googleCloudRunner installed. There is one available at <code>gcr.io/gcer-public/googlecloudrunner</code></p>
<p><code>Dockerfile</code>:</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master

COPY [".", "./"]

ENTRYPOINT ["R", "-e", "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"]
CMD ["api.R"]</code></pre>
<p>Put both the Dockerfile and the <code>api.R</code> script in the same folder then deploy it to Cloud Run:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span>(<span class="st">"the_folder"</span>)</a></code></pre></div>
<p>Once built you will have a pub/sub live that will trigger the function you defined. You can test pubsub messages via <code><a href="../reference/cr_pubsub.html">cr_pubsub()</a></code></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">test_url &lt;-<span class="st"> "http://your-cloudrun-api.com/pubsub"</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw"><a href="../reference/cr_pubsub.html">cr_pubsub</a></span>(test_url, <span class="st">"hello"</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co"># [1] "Echo: hello"</span></a></code></pre></div>
<p>In this case the function only echos, but you can modify the function to call other libraries, functions, operate on data sent in pubsub such as bucket object names, BigQuery tableIds, etc.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># perhaps the function calls another Cloud Build</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">pub &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(x, <span class="dt">source =</span> my_source)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">}</a></code></pre></div>
</div>
<div id="build-an-rmd-to-html-each-git-commit-and-host-it-on-cloud-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#build-an-rmd-to-html-each-git-commit-and-host-it-on-cloud-storage" class="anchor"></a>Build an Rmd to HTML each git commit and host it on Cloud Storage</h2>
<p>Cloud Storage can host public HTML files like a website, which can be accessed via public or private viewers. This can be useful in setting up reporting infrastructure.</p>
<p>The Cloud Build below makes use of Cloud Build artifacts to send the built Rmd files to a public Cloud Storage bucket. When an Rmd file is committed to git, this is rebuilt.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">r &lt;-<span class="st"> "rmarkdown::render('scheduled_rmarkdown.Rmd', output_file = 'scheduled_rmarkdown.html')"</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">rmd_build &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="dt">steps =</span> <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">      <span class="dt">id=</span><span class="st">"render rmd"</span>,</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">      <span class="dt">r =</span> r,</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">      <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/packagetools:master"</span>,</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">      <span class="dt">dir =</span> <span class="st">"inst/scheduled_rmarkdown/"</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    ),</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">  <span class="dt">artifacts =</span> <span class="kw"><a href="../reference/cr_build_yaml_artifact.html">cr_build_yaml_artifact</a></span>(</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">                 <span class="st">"inst/scheduled_rmarkdown/scheduled_rmarkdown.html"</span>, </a>
<a class="sourceLine" id="cb6-12" data-line-number="12">                 <span class="dt">bucket =</span> <span class="st">"mark-edmondson-public-read"</span>)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">  )</a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="co"># write out build to submit with repo</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="kw"><a href="../reference/cr_build_write.html">cr_build_write</a></span>(rmd_build, <span class="dt">file =</span> <span class="st">"inst/cloudbuild/cloudbuild_rmd.yml"</span>)</a></code></pre></div>
<p>The Rmd will build upon each commit</p>
</div>
<div id="build-and-deploy-rmd-files-to-cloud-run-every-git-commit" class="section level2">
<h2 class="hasAnchor">
<a href="#build-and-deploy-rmd-files-to-cloud-run-every-git-commit" class="anchor"></a>Build and deploy Rmd files to Cloud Run every Git commit</h2>
<p>Cloud Run scales from 0 to millions of hits, so can be an option for hosting a website. In particular you may want a private internal website, or have lots of traffic or data that goes over other free hosting options such as GitHub pages. A nginx server configuration is included to host any HTML you provide via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>.</p>
<p>Coupled to that, a common use case is to render Rmd files and host them on a website.</p>
<p>This can be achieved using <code><a href="../reference/cr_deploy_git_html.html">cr_deploy_git_html()</a></code> which will upon your chosen git event trigger run R code on your markdown files that should create HTML pages, and then deploy those to Cloud Run.</p>
<ol style="list-style-type: decimal">
<li>Mirror your GitHub/Bitbucket repo to Cloud Repositories</li>
<li>Put your markdown files in a directory within your Git repo</li>
<li>Run the below code to setup a build trigger that will render and deploy the markdown files each commit:</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">your_repo &lt;-<span class="st"> "MarkEdmondson1234/googleCloudRunner"</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">markdown_folder &lt;-<span class="st">  "vignettes"</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw"><a href="../reference/cr_deploy_git_html.html">cr_deploy_git_html</a></span>(your_repo, <span class="dt">rmd_folder =</span> markdown_folder)</a></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>If you want to customise how your markdown is rendered (perhaps using pkgdown to render your package website), supply that code in <code>edit_r</code> argument:</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">your_repo &lt;-<span class="st"> "MarkEdmondson1234/googleCloudRunner"</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">r &lt;-<span class="st"> "devtools::install(); pkgdown::build_site()"</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw"><a href="../reference/cr_deploy_git_html.html">cr_deploy_git_html</a></span>(your_repo, </a>
<a class="sourceLine" id="cb8-4" data-line-number="4">                   <span class="dt">image =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(your_repo, <span class="st">"-pkgdown"</span>), </a>
<a class="sourceLine" id="cb8-5" data-line-number="5">                   <span class="dt">rmd_folder =</span> <span class="st">"."</span>, <span class="dt">edit_r =</span> r)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">                   </a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="kw"><a href="../reference/cr_run_get.html">cr_run_get</a></span>(<span class="st">"markedmondson1234-googlecloudrunner-pkgdown"</span>)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#==CloudRunService==</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#name:  markedmondson1234-googlecloudrunner-pkgdown </span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#location:  europe-west1 </span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#lastModifier:  1080525199262@cloudbuild.gserviceaccount.com </span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#containers:  gcr.io/mark-edmondson-gde/markedmondson1234/googlecloudrunner-pkgdown:20d3e18 </span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#creationTimestamp:  2019-12-26T19:24:10.789691Z </span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#observedGeneration:  1 </span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#url:  https://markedmondson1234-googlecloudrunner-pkgdown-ewjogewawq-ew.a.run.app </span></a></code></pre></div>
</div>
<div id="polygot-cloud-builds---integrating-r-code-with-other-languages" class="section level2">
<h2 class="hasAnchor">
<a href="#polygot-cloud-builds---integrating-r-code-with-other-languages" class="anchor"></a>Polygot Cloud Builds - integrating R code with other languages</h2>
<p>Since Docker containers can hold any language within them, they offer a universal UI to combine languages. This offers opportunities to extend other languages with R features, and give other languages access to R code without needing to know R.</p>
<p>An example below uses:</p>
<ul>
<li>
<code>gcloud</code> - <a href="https://cloud.google.com/sdk/gcloud/">Googleâ€™s Cloud command line tool</a> to access Googleâ€™s key management store and download an authentication file</li>
<li>
<code>gago</code> - <a href="https://github.com/MarkEdmondson1234/gago">A Go package for fast downloads of Google Analytics data</a>
</li>
<li>
<code>R</code> - R code to create an Rmd file that will hold interactive forecasts of the Google Analytics data via <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>
</li>
<li>
<code>nginx</code> - serve up the Rmd files rendered into HTML and hosted on Cloud Run via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleCloudRunner)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">polygot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="dt">steps =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">      <span class="dt">id =</span> <span class="st">"download encrypted auth file"</span>,</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">      <span class="dt">name =</span> <span class="st">"gsutil"</span>,</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">               <span class="st">"gs://marks-bucket-of-stuff/auth.json.enc"</span>,</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">               <span class="st">"/workspace/auth.json.enc"</span>),</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">    ),</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">    <span class="kw"><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt</a></span>(</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">      <span class="dt">id =</span> <span class="st">"decrypt file"</span>,</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">      <span class="dt">cipher =</span> <span class="st">"/workspace/auth.json.enc"</span>,</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">      <span class="dt">plain =</span> <span class="st">"/workspace/auth.json"</span>,</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">      <span class="dt">keyring =</span> <span class="st">"my-keyring"</span>,</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">      <span class="dt">key =</span> <span class="st">"ga_auth"</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17">    ),</a>
<a class="sourceLine" id="cb9-18" data-line-number="18">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">      <span class="dt">id =</span> <span class="st">"download google analytics"</span>,</a>
<a class="sourceLine" id="cb9-20" data-line-number="20">      <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/gago:master"</span>,</a>
<a class="sourceLine" id="cb9-21" data-line-number="21">      <span class="dt">env =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"GAGO_AUTH=/workspace/auth.json"</span>),</a>
<a class="sourceLine" id="cb9-22" data-line-number="22">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"reports"</span>,</a>
<a class="sourceLine" id="cb9-23" data-line-number="23">               <span class="st">"--view=81416156"</span>,</a>
<a class="sourceLine" id="cb9-24" data-line-number="24">               <span class="st">"--dims=ga:date,ga:medium"</span>,</a>
<a class="sourceLine" id="cb9-25" data-line-number="25">               <span class="st">"--mets=ga:sessions"</span>,</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">               <span class="st">"--start=2014-01-01"</span>,</a>
<a class="sourceLine" id="cb9-27" data-line-number="27">               <span class="st">"--end=2019-11-30"</span>,</a>
<a class="sourceLine" id="cb9-28" data-line-number="28">               <span class="st">"--antisample"</span>,</a>
<a class="sourceLine" id="cb9-29" data-line-number="29">               <span class="st">"--max=-1"</span>,</a>
<a class="sourceLine" id="cb9-30" data-line-number="30">               <span class="st">"-o=google_analytics.csv"</span>),</a>
<a class="sourceLine" id="cb9-31" data-line-number="31">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb9-32" data-line-number="32">    ),</a>
<a class="sourceLine" id="cb9-33" data-line-number="33">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb9-34" data-line-number="34">      <span class="dt">id =</span> <span class="st">"download Rmd template"</span>,</a>
<a class="sourceLine" id="cb9-35" data-line-number="35">      <span class="dt">name =</span> <span class="st">"gsutil"</span>,</a>
<a class="sourceLine" id="cb9-36" data-line-number="36">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,</a>
<a class="sourceLine" id="cb9-37" data-line-number="37">               <span class="st">"gs://mark-edmondson-public-read/polygot.Rmd"</span>,</a>
<a class="sourceLine" id="cb9-38" data-line-number="38">               <span class="st">"/workspace/build/polygot.Rmd"</span>)</a>
<a class="sourceLine" id="cb9-39" data-line-number="39">    ),</a>
<a class="sourceLine" id="cb9-40" data-line-number="40">    <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(</a>
<a class="sourceLine" id="cb9-41" data-line-number="41">      <span class="dt">id=</span><span class="st">"render rmd"</span>,</a>
<a class="sourceLine" id="cb9-42" data-line-number="42">      <span class="dt">r =</span> <span class="st">"lapply(list.files('.', pattern = '.Rmd', full.names = TRUE),</span></a>
<a class="sourceLine" id="cb9-43" data-line-number="43"><span class="st">             rmarkdown::render, output_format = 'html_document')"</span>,</a>
<a class="sourceLine" id="cb9-44" data-line-number="44">      <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/packagetools:master"</span>,</a>
<a class="sourceLine" id="cb9-45" data-line-number="45">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb9-46" data-line-number="46">      ),</a>
<a class="sourceLine" id="cb9-47" data-line-number="47">    <span class="kw"><a href="../reference/cr_buildstep_bash.html">cr_buildstep_bash</a></span>(</a>
<a class="sourceLine" id="cb9-48" data-line-number="48">      <span class="dt">id =</span> <span class="st">"setup nginx"</span>,</a>
<a class="sourceLine" id="cb9-49" data-line-number="49">      <span class="dt">bash_script =</span> <span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"docker"</span>, <span class="st">"nginx"</span>, <span class="st">"setup.bash"</span>,</a>
<a class="sourceLine" id="cb9-50" data-line-number="50">                                <span class="dt">package =</span> <span class="st">"googleCloudRunner"</span>),</a>
<a class="sourceLine" id="cb9-51" data-line-number="51">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb9-52" data-line-number="52">      ),</a>
<a class="sourceLine" id="cb9-53" data-line-number="53">    <span class="kw"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(</a>
<a class="sourceLine" id="cb9-54" data-line-number="54">      <span class="co"># change to your own container registry</span></a>
<a class="sourceLine" id="cb9-55" data-line-number="55">      <span class="dt">image =</span> <span class="st">"gcr.io/gcer-public/polygot_demo"</span>,</a>
<a class="sourceLine" id="cb9-56" data-line-number="56">      <span class="dt">tag =</span> <span class="st">"latest"</span>,</a>
<a class="sourceLine" id="cb9-57" data-line-number="57">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb9-58" data-line-number="58">      ),</a>
<a class="sourceLine" id="cb9-59" data-line-number="59">    <span class="kw"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span>(</a>
<a class="sourceLine" id="cb9-60" data-line-number="60">      <span class="dt">name =</span> <span class="st">"polygot-demo"</span>,</a>
<a class="sourceLine" id="cb9-61" data-line-number="61">      <span class="dt">image =</span> <span class="st">"gcr.io/gcer-public/polygot_demo"</span>,</a>
<a class="sourceLine" id="cb9-62" data-line-number="62">      <span class="dt">concurrency =</span> <span class="dv">80</span>)</a>
<a class="sourceLine" id="cb9-63" data-line-number="63">  )</a>
<a class="sourceLine" id="cb9-64" data-line-number="64">)</a>
<a class="sourceLine" id="cb9-65" data-line-number="65"></a>
<a class="sourceLine" id="cb9-66" data-line-number="66"><span class="co"># build the polygot cloud build steps</span></a>
<a class="sourceLine" id="cb9-67" data-line-number="67">build &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(polygot)</a>
<a class="sourceLine" id="cb9-68" data-line-number="68">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(build)</a></code></pre></div>
<p>An example of the demo output is on this Cloud Run instance URL: <code>https://polygot-demo-ewjogewawq-ew.a.run.app/polygot.html</code></p>
<p>This constructed cloud build can also be used outside of R, by writing out the Cloud Build file via <code><a href="../reference/cr_build_write.html">cr_build_write()</a></code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># write out to cloudbuild.yaml for other languages</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw"><a href="../reference/cr_build_write.html">cr_build_write</a></span>(polygot)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co"># 2019-12-28 19:15:50&gt; Writing to cloudbuild.yaml</span></a></code></pre></div>
<p>This can also be scheduled as described in Cloud Scheduler section on <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudscheduler.html">scheduled cloud builds</a>.</p>
<p>An example of that cloudbuild.yaml is on GitHub <a href="https://raw.githubusercontent.com/MarkEdmondson1234/googleCloudRunner/master/inst/polygot/cloudbuild.yaml">here</a>.</p>
</div>
<div id="scheduled-update-of-an-rmarkdown-dashboard-from-google-sheets" class="section level2">
<h2 class="hasAnchor">
<a href="#scheduled-update-of-an-rmarkdown-dashboard-from-google-sheets" class="anchor"></a>Scheduled update of an RMarkdown dashboard from Google Sheets</h2>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
I have a flexdashboard that shows data from a Google Sheet with ggplotly. What's the best way to host the dashboard somewhere <em>and</em> make it so it shows the latest data? i.e.Â how should I show dynamic data in an RMarkdown dashboard? Continually reknit? Make a plumber API? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a>
</p>
â€” Andrew Heiss, PhD (<span class="citation">@andrewheiss</span>) <a href="https://twitter.com/andrewheiss/status/1212408575684943878?ref_src=twsrc%5Etfw">January 1, 2020</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>This tweet came up as I was looking for use cases. A solution may be to:</p>
<ul>
<li>Create a Docker image to knit the Rmd</li>
<li>Knit the Rmd dashboard using flexdashboard</li>
<li>Host the HTML on Cloud Run</li>
<li>Set up a schedule for the new data in googlesheets</li>
</ul>
<p>The solution below assumes that the source is available on a public GitHub, but other sources could be also used such as private repos or Cloud Storage.</p>
<p>For the example below, this repo is used with the source files in <code>inst/scheduled_rmarkdown</code></p>
<div id="rmd-dashboard" class="section level3">
<h3 class="hasAnchor">
<a href="#rmd-dashboard" class="anchor"></a>Rmd dashboard</h3>
<p>The Rmd can run R code downloading the data within it in its setup block - this should mean little changes are needed from the local version.</p>
<div id="authentication-in-rmd" class="section level4">
<h4 class="hasAnchor">
<a href="#authentication-in-rmd" class="anchor"></a>Authentication in Rmd</h4>
<p>One modification could be if you need to read from a private Googlesheet. See <a href="https://gargle.r-lib.org/articles/non-interactive-auth.html">gargleâ€™s guide on what is necessary for non-interactive auth</a>, which could be adding the Cloud Build auth email as a user to the sheet, or setting up decryption of a token via <code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code></p>
<p>For the example, a public Google Sheets URL is assumed and auth is avoided by using <code>googlesheets4::sheets_deauth()</code> within the Rmd file.</p>
</div>
</div>
<div id="docker-image" class="section level3">
<h3 class="hasAnchor">
<a href="#docker-image" class="anchor"></a>Docker image</h3>
<p>For the Rmd these packages were loaded:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(flexdashboard)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googlesheets4)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(plotly)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a></code></pre></div>
<p>The R image rendering the Rmd needs these libraries and dependencies installed.</p>
<p>This was done using <code>containerit</code>, feeding in the Rmd file to autodetect the dependencies:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">d &lt;-<span class="st"> </span>containerit<span class="op">::</span><span class="kw">dockerfile</span>(<span class="st">"inst/scheduled_rmarkdown/scheduled_rmarkdown.Rmd"</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">containerit<span class="op">::</span><span class="kw">write</span>(d, <span class="st">"inst/scheduled_rmarkdown/Dockerfile"</span>)</a></code></pre></div>
<p>In this case since some tidyverse packages were used, the <code>FROM</code> was change to start from <code>rocker/verse</code> to speed up the build.</p>
<p>This dockerfile was then built into an image that will be used to render the Rmd during build steps. This builds all the libraries from source and places them in a docker R image you can use for future buildsteps - in this case called <code>gcr.io/my-project/scheduled_rmarkdown:latest</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleCloudRunner)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span>(<span class="st">"inst/scheduled_rmarkdown/"</span>, <span class="dt">tag =</span> <span class="st">"latest"</span>, <span class="dt">timeout =</span> <span class="dv">1200</span>)</a></code></pre></div>
<p>If there a lot of libraries it may take a while (&gt;20 mins) to build, you can cancel out of the R session awaiting the build and just follow the online logs if you wish.</p>
<p>Once built, you do not need to build it again unless you want to update the R library versions.</p>
</div>
<div id="create-the-cloud-build-for-scheduling" class="section level3">
<h3 class="hasAnchor">
<a href="#create-the-cloud-build-for-scheduling" class="anchor"></a>Create the Cloud Build for scheduling</h3>
<p>Since we are using a Git repo and are hosting on Cloud Run, <code><a href="../reference/cr_deploy_git_html.html">cr_deploy_git_html()</a></code> could be used to automate render the Rmd and hosting the HTML via nginx on Cloud Run.</p>
<p>This will make another Docker image that hosts the HTML and deploy it to Cloud Run, and it will also setup a build trigger to rebuild the image if the Rmd changes in future commits.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_git_html.html">cr_deploy_git_html</a></span>(<span class="st">"MarkEdmondson1234/googleCloudRunner"</span>,</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">                   <span class="dt">image =</span> <span class="st">"scheduled-rmarkdown-cloudrun"</span>,</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">                   <span class="dt">rmd_folder =</span> <span class="st">"inst/scheduled_rmarkdown/"</span>,</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">                   <span class="dt">r_image =</span> <span class="st">"gcr.io/my-project/scheduled_rmarkdown:latest"</span>)</a></code></pre></div>
<p>However, since we want to schedule the Cloud Build that renders the Rmd, we will construct our own build using the buildstep templates:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">run_image &lt;-<span class="st"> "scheduled-rmarkdown-cloudrun"</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">rmd_folder &lt;-<span class="st"> "inst/scheduled_rmarkdown/"</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">r_image &lt;-<span class="st"> "gcr.io/mark-edmondson-gde/scheduled_rmarkdown:latest"</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">r &lt;-<span class="st"> "rmarkdown::render('scheduled_rmarkdown.Rmd')"</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co"># script to setup nginx </span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">bash_script &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"docker"</span>, <span class="st">"nginx"</span>, <span class="st">"setup.bash"</span>,</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">                           <span class="dt">package =</span> <span class="st">"googleCloudRunner"</span>)</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">repo_name &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"github_markedmondson1234_googlecloudrunner"</span>)</a>
<a class="sourceLine" id="cb15-12" data-line-number="12"></a>
<a class="sourceLine" id="cb15-13" data-line-number="13">repo_source &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_source.html">cr_build_source</a></span>(<span class="kw"><a href="../reference/RepoSource.html">RepoSource</a></span>(repo_name,</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">                          <span class="dt">branchName =</span> <span class="st">".*"</span>,</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">                          <span class="dt">projectId =</span> <span class="kw"><a href="../reference/cr_project_set.html">cr_project_get</a></span>()))</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">                          </a>
<a class="sourceLine" id="cb15-17" data-line-number="17">build_me &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb15-18" data-line-number="18">      <span class="dt">steps =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">          <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(r,</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">                  <span class="dt">name =</span> r_image,</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">                  <span class="dt">dir =</span> <span class="st">"inst/scheduled_rmarkdown/"</span>,</a>
<a class="sourceLine" id="cb15-22" data-line-number="22">                  <span class="dt">id=</span><span class="st">"render rmd"</span>),</a>
<a class="sourceLine" id="cb15-23" data-line-number="23">          <span class="kw"><a href="../reference/cr_buildstep_bash.html">cr_buildstep_bash</a></span>(bash_script,</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">                            <span class="dt">dir =</span> <span class="st">"inst/scheduled_rmarkdown/"</span>, </a>
<a class="sourceLine" id="cb15-25" data-line-number="25">                            <span class="dt">id =</span> <span class="st">"setup nginx"</span>),</a>
<a class="sourceLine" id="cb15-26" data-line-number="26">          <span class="kw"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(run_image,</a>
<a class="sourceLine" id="cb15-27" data-line-number="27">                              <span class="dt">tag =</span> <span class="st">"latest"</span>,</a>
<a class="sourceLine" id="cb15-28" data-line-number="28">                              <span class="dt">dir =</span> <span class="st">"inst/scheduled_rmarkdown/"</span>),</a>
<a class="sourceLine" id="cb15-29" data-line-number="29">          <span class="kw"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span>(<span class="dt">name =</span> <span class="st">"scheduled-rmd"</span>,</a>
<a class="sourceLine" id="cb15-30" data-line-number="30">                  <span class="dt">image =</span> <span class="st">"gcr.io/mark-edmondson-gde/scheduled-rmarkdown-cloudrun:latest"</span>,</a>
<a class="sourceLine" id="cb15-31" data-line-number="31">                  <span class="dt">concurrency =</span> <span class="dv">80</span>)</a>
<a class="sourceLine" id="cb15-32" data-line-number="32">          )</a>
<a class="sourceLine" id="cb15-33" data-line-number="33">    )</a>
<a class="sourceLine" id="cb15-34" data-line-number="34">    </a>
<a class="sourceLine" id="cb15-35" data-line-number="35"></a>
<a class="sourceLine" id="cb15-36" data-line-number="36"><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(build_me, <span class="dt">source =</span> repo_source)</a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#create-docker-image-of-a-package-each-commit">Create Docker image of a package each commit</a></li>
      <li><a href="#trigger-an-r-function-from-pubsub">Trigger an R function from pubsub</a></li>
      <li><a href="#build-an-rmd-to-html-each-git-commit-and-host-it-on-cloud-storage">Build an Rmd to HTML each git commit and host it on Cloud Storage</a></li>
      <li><a href="#build-and-deploy-rmd-files-to-cloud-run-every-git-commit">Build and deploy Rmd files to Cloud Run every Git commit</a></li>
      <li><a href="#polygot-cloud-builds---integrating-r-code-with-other-languages">Polygot Cloud Builds - integrating R code with other languages</a></li>
      <li><a href="#scheduled-update-of-an-rmarkdown-dashboard-from-google-sheets">Scheduled update of an RMarkdown dashboard from Google Sheets</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
