<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examples using googleCloudRunner for serverless R â€¢ googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Examples using googleCloudRunner for serverless R">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.9003</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Examples using googleCloudRunner for serverless R</h1>
            
      
      
      <div class="hidden name"><code>usecases.Rmd</code></div>

    </div>

    
    
<p>Here will be some example use cases you can use googleCloudRunner for.</p>
<p>Since almost any code can be called and passed via Docker images, there is a lot of potential uses.</p>
<ul>
<li>Scheduling R scripts in the cloud</li>
<li>R APIs to call from anywhere</li>
<li>Triggering R code to run on events, such as BigQuery table updates or GitHub pushes</li>
<li>Checking a package, creating a website, deploying it to GitHub</li>
<li>Running authenticated tests for R packages in private environment</li>
<li>Creating an Rmarkdown powered website using Cloud Run</li>
<li>Integrating R with other language applications</li>
<li>Public and private Docker image creations on triggers</li>
</ul>
<div id="connecting-to-github" class="section level2">
<h2 class="hasAnchor">
<a href="#connecting-to-github" class="anchor"></a>Connecting to GitHub</h2>
<p>Connect via the <a href="https://cloud.google.com/source-repositories/docs/mirroring-a-github-repository">Source Repository mirroring service</a>.</p>
<p>Once your repo is connected, you can operate on R packages on GitHub via:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># this repo mirrored on Google Source repos</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">my_repo &lt;-<span class="st"> </span><span class="kw"><a href="../reference/Source.html">Source</a></span>(</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="dt">repoSource=</span><span class="kw"><a href="../reference/RepoSource.html">RepoSource</a></span>(<span class="st">"github_markedmondson1234_googlecloudrunner"</span>,</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">                        <span class="dt">branchName=</span><span class="st">"master"</span>))</a></code></pre></div>
<p>You can create a GitHub build trigger using <code><a href="../reference/GitHubEventsConfig.html">GitHubEventsConfig()</a></code> - this will by default trigger builds when you push to any GitHub branch.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">cloudbuild &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"cloudbuild/cloudbuild.yaml"</span>,</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">                           <span class="dt">package =</span> <span class="st">"googleCloudRunner"</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">bb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(cloudbuild, <span class="dt">projectId =</span> <span class="st">"test-project"</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">github &lt;-<span class="st"> </span><span class="kw"><a href="../reference/GitHubEventsConfig.html">GitHubEventsConfig</a></span>(<span class="st">"MarkEdmondson1234/googleCloudRunner"</span>, <span class="dt">branch =</span> <span class="st">"master"</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span>(<span class="st">"trig1"</span>, <span class="dt">trigger =</span> github, <span class="dt">build =</span> bb)</a></code></pre></div>
</div>
<div id="create-docker-image-of-a-package" class="section level2">
<h2 class="hasAnchor">
<a href="#create-docker-image-of-a-package" class="anchor"></a>Create Docker image of a package</h2>
<p>This is what is used to deploy this package as a Docker image to the public <code>googleComputeEngineR</code> docker image project, <code>gcr.io/gcer-public</code></p>
<p>This builds a Docker image of the Dockerfile in the root directory of the GitHub repo, which is then <a href="https://cloud.google.com/source-repositories/docs/mirroring-a-github-repository">mirrored to Google Source Repositories</a> via the GitHub app.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">my_image &lt;-<span class="st"> "gcr.io/my-project/my-image"</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># this repo mirrored on Google Source repos</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">my_repo &lt;-<span class="st"> </span><span class="kw"><a href="../reference/RepoSource.html">RepoSource</a></span>(<span class="st">"MarkEdmondson1234/googleCloudRunner"</span>,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">                      <span class="dt">branchName=</span><span class="st">"master"</span>)<span class="er">)</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">                        </a>
<a class="sourceLine" id="cb3-7" data-line-number="7">docker_yaml &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(<span class="dt">steps =</span> <span class="kw"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(my_image))</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">built_docker &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(docker_yaml, <span class="dt">source =</span> my_repo)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co"># make a build trigger so it builds on each push to master</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span>(<span class="st">"build-docker"</span>, <span class="dt">trigger =</span> my_repo, <span class="dt">build =</span> built_docker)</a></code></pre></div>
</div>
<div id="trigger-an-r-function-from-pubsub" class="section level2">
<h2 class="hasAnchor">
<a href="#trigger-an-r-function-from-pubsub" class="anchor"></a>Trigger an R function from pubsub</h2>
<p>This uses <code>cr_deploy_run</code> to deploy an R API that can then be triggered from pub/sub events, such as Cloud logging events or when files get updated in a Cloud Storage bucket. This in turn can trigger other Cloud Builds.</p>
<p>A plumber API that accepts pub/sub messages is facilitated by <code><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub()</a></code></p>
<p><code>api.R</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># example function echos back pubsub message</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># change to do something more interesting with event data</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">pub &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Echo:"</span>, x)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#' Recieve pub/sub message</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#' @post /pubsub</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#' @param message a pub/sub message</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="cf">function</span>(<span class="dt">message=</span><span class="ot">NULL</span>){</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">  googleCloudRunner<span class="op">::</span><span class="kw"><a href="https://code.markedmondson.me/googleCloudRunner/reference/cr_plumber_pubsub.html">cr_plumber_pubsub</a></span>(message, pub)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">}</a></code></pre></div>
<p>Deploy the R API using an image that has plumber and googleCloudRunner installed. There is one available at <code>gcr.io/gcer-public/googlecloudrunner</code></p>
<p><code>Dockerfile</code>:</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master

COPY [".", "./"]

ENTRYPOINT ["R", "-e", "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"]
CMD ["api.R"]</code></pre>
<p>Put both the Dockerfile and the <code>api.R</code> script in the same folder then deploy it to Cloud Run:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_plumber.html">cr_deploy_run</a></span>(<span class="st">"the_folder"</span>)</a></code></pre></div>
<p>Once built you will have a pub/sub live that will trigger the function you defined. You can test pubsub messages via <code><a href="../reference/cr_pubsub.html">cr_pubsub()</a></code></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">test_url &lt;-<span class="st"> "http://your-cloudrun-api.com/pubsub"</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw"><a href="../reference/cr_pubsub.html">cr_pubsub</a></span>(test_url, <span class="st">"hello"</span>)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co"># [1] "Echo: hello"</span></a></code></pre></div>
<p>In this case the function only echos, but you can modify the function to call other libraries, functions, operate on data sent in pubsub such as bucket object names, BigQuery tableIds, etc.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># perhaps the function calls another Cloud Build</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">pub &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(x, <span class="dt">source =</span> my_source)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">}</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#connecting-to-github">Connecting to GitHub</a></li>
      <li><a href="#create-docker-image-of-a-package">Create Docker image of a package</a></li>
      <li><a href="#trigger-an-r-function-from-pubsub">Trigger an R function from pubsub</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
