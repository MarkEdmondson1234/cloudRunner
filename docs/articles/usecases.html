<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example Use Cases for googleCloudRunner • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example Use Cases for googleCloudRunner">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Example Use Cases for googleCloudRunner</h1>
            
            <h4 class="date">2020-02-14</h4>
      
      
      <div class="hidden name"><code>usecases.Rmd</code></div>

    </div>

    
    
<p>Here will be some example use cases you can use googleCloudRunner for.</p>
<p>Since almost any code can be called and passed via Docker images, there are a lot of potential uses.</p>
<ul>
<li>Scheduling R scripts in the cloud</li>
<li>R APIs to call from anywhere</li>
<li>Triggering R code to run on events, such as BigQuery table updates or GitHub pushes</li>
<li>Checking a package, creating a website, deploying it to GitHub</li>
<li>Running authenticated tests for R packages in private environment</li>
<li>Creating an Rmarkdown powered website using Cloud Run</li>
<li>Integrating R with other language applications</li>
<li>Public and private Docker image creations on triggers</li>
</ul>
<p>Some <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community">community contributed Cloud Build images are listed here</a>, including <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/hugo">hugo</a>, <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/make">make</a>, and <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/tar">tar</a>.</p>
<p>You can use any public Docker image if you know which arguments etc. to send to it, for example the Slack messages are using <a href="https://github.com/technosophos/slack-notify"><code>technosophos/slack-notify</code></a>.</p>
<div id="deploy-a-pkgdown-website-for-your-r-package" class="section level2">
<h2 class="hasAnchor">
<a href="#deploy-a-pkgdown-website-for-your-r-package" class="anchor"></a>Deploy a pkgdown website for your R package</h2>
<p>When creating an R package <a href="https://pkgdown.r-lib.org/">pkgdown</a> is a fantastic resource for creating a package website from your R function’s documentation and vignettes.</p>
<p>This workflow uses Google’s Key Management Store to securely hold your Git ssh login details, then use those details to commit a built website on each Git commit. This means you do not have to build the website locally.</p>
<p>Each commit you make, a background task will build the website with your changes and commit it back to the repo - see example for this website:</p>
<p><img src="pkgdown-commit.png"></p>
<p>A suggested setup workflow to do this is below:</p>
<ol style="list-style-type: decimal">
<li>Encrypt your git SSH key with gcloud <a href="https://cloud.google.com/cloud-build/docs/securing-builds/use-encrypted-secrets-credentials">using these instructions</a>, noting your keyring and key for the next steps.<br>
</li>
<li>This will create an encrypted file - add it to your R package’s directory.</li>
<li>Use <code><a href="../reference/cr_deploy_pkgdown.html">cr_deploy_pkgdown()</a></code> to create a cloudbuild.yml file in your R package’s directory, giving it your decryption details from step 1.</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_pkgdown.html">cr_deploy_pkgdown</a></span>(<span class="dt">keyring =</span> <span class="st">"your-keyring"</span>, <span class="dt">key =</span> <span class="st">"github-key"</span>)</a></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Add and commit the cloudbuild.yml file to your git repository</li>
<li>Go to <a href="https://console.cloud.google.com/cloud-build/triggers">GCP console &gt; Cloud Build &gt; Triggers</a> and link your git repo to Cloud Build.</li>
<li>Create a Build Trigger for your git repository:</li>
</ol>
<ul>
<li>point at the cloudbuild.yml file you commited (e.g. cloudbuild-pkgdown.yml)</li>
<li>Make sure to exclude the <code>docs/**</code> folder in the build trigger else the trigger will retrigger when the website is built and pushed to the repo!</li>
<li>You may also want to exclude other folders such as tests/**</li>
<li>Add a substitution variable <code>_GITHUB_REPO</code> with your Git address you want to push to e.g. MarkEdmondson1234/googleCloudRunner</li>
</ul>
<p>The below is an example for <code>googleCloudRunner</code>’s website:</p>
<p><img src="pkgdown-build-trigger.png"></p>
<p>The example above also adds other substitution variables to help run some of the examples.</p>
<p>You can customise the deployment more by using <code><a href="../reference/cr_buildstep_pkgdown.html">cr_buildstep_pkgdown()</a></code> in your own custom build files. For instance, you could download other auth keys using <code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code> again, so that your website has working authenticated examples.</p>
</div>
<div id="run-package-tests-and-code-coverage" class="section level2">
<h2 class="hasAnchor">
<a href="#run-package-tests-and-code-coverage" class="anchor"></a>Run package tests and code coverage</h2>
<p>This workflow will run the package tests you have upon each commit to your git repo.</p>
<p>You can also optionally submit those test results to <a href="https://codecov.io">codecov</a> via the excellent <a href="https://covr.r-lib.org/">covr R package</a>, helping you see which code your tests actually test. This is what creates this badge for this package:</p>
<p><a href="https://codecov.io/gh/MarkEdmondson1234/googleCloudRunner"><img src="https://codecov.io/gh/MarkEdmondson1234/googleCloudRunner/branch/master/graph/badge.svg" alt="codecov"></a></p>
<p>If you do not need online authentication for your tests, then this is only a case of deploying the premade default cloudbuild.yml file via <code><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests()</a></code>.</p>
<p>The below assumes you have created tests for your package.</p>
<ol style="list-style-type: decimal">
<li>If you want to use Codecov, <a href="https://docs.codecov.io/reference">generate a Codecov token</a> on its website and link it to your git repository</li>
<li>Create the tests cloudbuild.yml file via <code><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests()</a></code>
</li>
<li>Add and commit the cloudbuild.yml file to your git repository</li>
<li>Go to <a href="https://console.cloud.google.com/cloud-build/triggers">GCP console &gt; Cloud Build &gt; Triggers</a> and link your git repo to Cloud Build.</li>
<li>Create a Build Trigger for your git repository:</li>
</ol>
<ul>
<li>point at the cloudbuild.yml file you commited (e.g. cloudbuild-tests.yml)</li>
<li>Exclude any folders such as the <code>docs/**</code> folder where changes should not trigger a recheck</li>
<li>Add a substitution variable <code>_CODECOV_TOKEN</code> if you are using it</li>
</ul>
<p>The below is an example for <code>googleCloudRunner</code>’s website:</p>
<p><img src="pkgchecks-trigger.png"></p>
<p>The example above also adds other substitution variables to help run some of the examples.</p>
<div id="authenticated-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#authenticated-tests" class="anchor"></a>Authenticated tests</h3>
<p>You can customise the deployment more by using <code><a href="../reference/cr_buildstep_packagetests.html">cr_buildstep_packagetests()</a></code> in your own custom build files.</p>
<p>For <code>googleCloudRunner</code> and API packages in general, an authentication key is needed to run online tests. This authentication key can be encrypted via <code>gcloud</code> and added to <a href="https://cloud.google.com/kms">Google Cloud KMS</a> by adding a decryption step to your tests via <code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code>.</p>
<p>In that case, the decryption step needs to occur before the tests run, which you can do by supplying <code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code> to <code><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests()</a></code>.</p>
<p>You will also want to use that auth file somehow, in the below example it is placed in an environment argument that your tests use to find the authentication file:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_packagetests.html">cr_deploy_packagetests</a></span>(</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="dt">steps =</span> <span class="kw"><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt</a></span>(<span class="st">"auth.json.enc"</span>, <span class="st">"auth.json"</span>,</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">                               <span class="dt">keyring =</span> <span class="st">"my-keyring"</span>, <span class="dt">key =</span> <span class="st">"my-key"</span>),</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="dt">env =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"NOT_CRAN=true"</span>, <span class="st">"MY_AUTH_FILE=auth.json"</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">)</a></code></pre></div>
<p>Use the resulting cloudbuild.yml file in the same manner as unauthenticated tests.</p>
</div>
</div>
<div id="create-docker-image-of-a-package-each-commit" class="section level2">
<h2 class="hasAnchor">
<a href="#create-docker-image-of-a-package-each-commit" class="anchor"></a>Create Docker image of a package each commit</h2>
<p>If you just want a one-off Docker image, use <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> or make your own build via <code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code></p>
<p><img src="gadget_docker.png"></p>
<p>If you want the Docker image to rebuild each git commit, this is what is used to deploy this package to <code>gcr.io/gcer-public/googlecloudrunner</code> - in this case the Dockerfile in the root of the repo is built. Simply place the Dockerfile in the root of your repo, and then create a Build Trigger with similar settings:</p>
<p><img src="build_dockerfile.png"></p>
</div>
<div id="migrate-an-existing-scheduled-docker-container" class="section level2">
<h2 class="hasAnchor">
<a href="#migrate-an-existing-scheduled-docker-container" class="anchor"></a>Migrate an existing scheduled Docker container</h2>
<p>You may have an existing Docker container containing code, that doesn’t need a public URL.</p>
<p>For example, a self-contained R script with <code>googleAnalyticsR</code> and <code>bigQueryR</code> pre-installed, that downloads data from Google Analytics and uploads it to BigQuery. This may be running on a VM from <code>googleComputeEngineR</code>, Kubernetes or Airflow KubernetesPodOperator.</p>
<p>If you give the cloud build service email the right permissions, then this can all be done on Cloud Build + Cloud Scheduler.</p>
<p>For example, say your existing container is called <code>gcr.io/my-project/my-r-script</code>. A Cloud Build could look simply like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">r_code &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"gcr.io/my-project/my-r-script"</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">build &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(r_code)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(build)</a></code></pre></div>
<p>You could add other steps if you wanted, such as sending an email when done via <code><a href="../reference/cr_buildstep_mailgun.html">cr_buildstep_mailgun()</a></code> or <code><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">r_code &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"gcr.io/my-project/my-r-script"</span>),</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw"><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack</a></span>(<span class="st">"The script run ok"</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">build &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(r_code, <span class="st">`</span><span class="dt">_SLACK_WEBHOOK</span><span class="st">`</span> =<span class="st"> "https://your_slack_webhook"</span>)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(build)</a></code></pre></div>
<p>To set this up in a schedule, add it to the scheduler like so:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">schedule_me &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(built)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"r-code-example"</span>, <span class="st">"15 8 * * *"</span>, <span class="dt">httpTarget =</span> schedule_me)</a></code></pre></div>
</div>
<div id="trigger-an-r-function-from-pubsub" class="section level2">
<h2 class="hasAnchor">
<a href="#trigger-an-r-function-from-pubsub" class="anchor"></a>Trigger an R function from pubsub</h2>
<p>This uses <code>cr_deploy_plumber</code> to deploy an R API that can then be triggered from pub/sub events, such as Cloud logging events or when files get updated in a Cloud Storage bucket. This in turn can trigger other Cloud Builds.</p>
<p>A plumber API that accepts pub/sub messages is facilitated by <code><a href="../reference/cr_plumber_pubsub.html">cr_plumber_pubsub()</a></code></p>
<p><code>api.R</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># example function echos back pubsub message</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># change to do something more interesting with event data</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">pub &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Echo:"</span>, x)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#' Recieve pub/sub message</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#' @post /pubsub</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#' @param message a pub/sub message</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="cf">function</span>(<span class="dt">message=</span><span class="ot">NULL</span>){</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">  googleCloudRunner<span class="op">::</span><span class="kw"><a href="https://code.markedmondson.me/googleCloudRunner/reference/cr_plumber_pubsub.html">cr_plumber_pubsub</a></span>(message, pub)</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">}</a></code></pre></div>
<p>Deploy the R API using an image that has plumber and googleCloudRunner installed. There is one available at <code>gcr.io/gcer-public/googlecloudrunner</code></p>
<p><code>Dockerfile</code>:</p>
<pre><code>FROM gcr.io/gcer-public/googlecloudrunner:master

COPY [".", "./"]

ENTRYPOINT ["R", "-e", "pr &lt;- plumber::plumb(commandArgs()[4]); pr$run(host='0.0.0.0', port=as.numeric(Sys.getenv('PORT')))"]
CMD ["api.R"]</code></pre>
<p>Put both the Dockerfile and the <code>api.R</code> script in the same folder then deploy it to Cloud Run:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_run.html">cr_deploy_plumber</a></span>(<span class="st">"the_folder"</span>)</a></code></pre></div>
<p>Or use the RStudio gadget:</p>
<p><img src="gadget_plumber.png"></p>
<p>Once built you will have a pub/sub live that will trigger the function you defined. You can test pubsub messages via <code><a href="../reference/cr_pubsub.html">cr_pubsub()</a></code></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">test_url &lt;-<span class="st"> "http://your-cloudrun-api.com/pubsub"</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw"><a href="../reference/cr_pubsub.html">cr_pubsub</a></span>(test_url, <span class="st">"hello"</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># [1] "Echo: hello"</span></a></code></pre></div>
<p>In this case the function only echos, but you can modify the function to call other libraries, functions, operate on data sent in pubsub such as bucket object names, BigQuery tableIds, etc.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># perhaps the function calls another Cloud Build</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">pub &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(x, <span class="dt">source =</span> my_source)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">}</a></code></pre></div>
</div>
<div id="build-an-rmd-each-git-commit-and-host-its-html-on-cloud-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#build-an-rmd-each-git-commit-and-host-its-html-on-cloud-storage" class="anchor"></a>Build an Rmd each git commit and host its HTML on Cloud Storage</h2>
<p>Cloud Storage can host public HTML files like a website, which can be accessed via public or private viewers. This can be useful in setting up reporting infrastructure.</p>
<p>The Cloud Build below makes use of Cloud Build artifacts to send the built Rmd files to a public Cloud Storage bucket. When an Rmd file is committed to git, this is rebuilt.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">r &lt;-<span class="st"> "rmarkdown::render('scheduled_rmarkdown.Rmd', output_file = 'scheduled_rmarkdown.html')"</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">rmd_build &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="dt">steps =</span> <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">      <span class="dt">id=</span><span class="st">"render rmd"</span>,</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">      <span class="dt">r =</span> r,</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">      <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/render_rmd:master"</span>,</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">      <span class="dt">dir =</span> <span class="st">"inst/scheduled_rmarkdown/"</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">    ),</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  <span class="dt">artifacts =</span> <span class="kw"><a href="../reference/cr_build_yaml_artifact.html">cr_build_yaml_artifact</a></span>(</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">                 <span class="st">"inst/scheduled_rmarkdown/scheduled_rmarkdown.html"</span>, </a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                 <span class="dt">bucket =</span> <span class="st">"mark-edmondson-public-read"</span>)</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">  )</a>
<a class="sourceLine" id="cb11-14" data-line-number="14"></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co"># write out build to submit with repo</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="kw"><a href="../reference/cr_build_write.html">cr_build_write</a></span>(rmd_build, <span class="dt">file =</span> <span class="st">"inst/cloudbuild/cloudbuild_rmd.yml"</span>)</a></code></pre></div>
<p>The Rmd will build upon each commit, adapting to changes in the Rmd file.</p>
<p>The example Rmd file is build and available on a public Cloud Storage bucket - the above example is available at this <a href="https://storage.googleapis.com/mark-edmondson-public-read/scheduled_rmarkdown.html">link</a></p>
<p><img src="schedule_markdown_hosted_gcs.png"></p>
<p>The two buildtriggers then build the Dockerfile to render the image (with all the necessary R libraries installed) and a build trigger to run the actual build upon each commit</p>
<p><img src="render_rmd_buildtriggers.png"></p>
<p>An example of the rendering Rmd build trigger in the web UI is below:</p>
<p><img src="render_rmd_trigger.png"></p>
</div>
<div id="build-and-deploy-rmd-files-to-cloud-run-on-a-schedule" class="section level2">
<h2 class="hasAnchor">
<a href="#build-and-deploy-rmd-files-to-cloud-run-on-a-schedule" class="anchor"></a>Build and deploy Rmd files to Cloud Run on a schedule</h2>
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
I have a flexdashboard that shows data from a Google Sheet with ggplotly. What's the best way to host the dashboard somewhere <em>and</em> make it so it shows the latest data? i.e. how should I show dynamic data in an RMarkdown dashboard? Continually reknit? Make a plumber API? <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a>
</p>
— Andrew Heiss, PhD (<span class="citation">@andrewheiss</span>) <a href="https://twitter.com/andrewheiss/status/1212408575684943878?ref_src=twsrc%5Etfw">January 1, 2020</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Cloud Run scales from 0 to millions of hits, so can be an option for hosting a website. In particular you may want a private internal website, have R code executing via a plumber API in the same container, or have lots of traffic or data that goes over other free hosting options such as GitHub pages. A nginx server configuration is included to host any HTML you provide via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>.</p>
<p>You may prefer using Cloud Storage public URLs if you don’t need any of Cloud Run’s features, like the previous example.</p>
<p>Coupled to that, a common use case is to render Rmd files and host them on a website like the tweet above. For the above tweet scenario, the Rmd has a setup block that reads from googlesheets via the code below:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="bn">```{r setup, include=FALSE}</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="bn">library(flexdashboard)</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="bn">library(googlesheets4)</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="bn">library(ggplot2)</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="bn">library(plotly)</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="bn">library(dplyr)</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="bn"># for public Googlesheets.  </span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="bn"># If private see https://gargle.r-lib.org/articles/non-interactive-auth.html</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="bn">sheets_deauth()</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="bn"># this is the data that may update each time the Rmd is rendered</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="bn">gm &lt;- sheets_example("gap") %&gt;% read_sheet()</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="bn">gm_agg &lt;- gm %&gt;%</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="bn">  mutate(gdp=gdpPercap*pop) %&gt;%</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="bn">  filter(continent=="Africa") %&gt;%</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="bn">  group_by(year) %&gt;%</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="bn">  summarize(mean(lifeExp), mean(gdp))</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="bn">p &lt;- ggplot(gm, aes(gdpPercap, lifeExp)) + theme_minimal() + scale_x_log10()</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="bn">```</span></a></code></pre></div>
<p>The build Rmd docker in this case needs all the libraries listed (flexdashboard, googlesheets4 etc.) included in its build - this could be built before hand in another Cloud Build - in this case the libraries are all in <code>gcr.io/gcer-public/render_rmd</code></p>
<p>For this example, the build is not reading from a git repo but the Rmd file is downloaded from a Cloud Storage bucket, that you may have uploaded to manually, via <code>googleCloudStorageR</code> or perhaps copied over from a repo in another Cloud Build on a Build Trigger.</p>
<p>The scheduled build then can be enabled via:</p>
<ol style="list-style-type: decimal">
<li>Uploading your Rmarkdown files to a Cloud Storage bucket</li>
<li>Create a build that will:</li>
</ol>
<ul>
<li>download the Rmd file</li>
<li>render the Rmd creating the HTML files</li>
<li>configure nginx for Cloud Run,</li>
<li>build a Docker image of nginx with your HTML</li>
<li>serve it on Cloud Run.</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">r &lt;-<span class="st"> "rmarkdown::render('scheduled_rmarkdown.Rmd', output_file = 'scheduled_rmarkdown.html')"</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">build_rmd &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">      <span class="dt">steps =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">        <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">          <span class="dt">id =</span> <span class="st">"download Rmd template"</span>,</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">          <span class="dt">name =</span> <span class="st">"gsutil"</span>,</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">          <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">                   <span class="st">"gs://mark-edmondson-public-read/scheduled_rmarkdown.Rmd"</span>,</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">                   <span class="st">"scheduled_rmarkdown.Rmd"</span>),</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">        ),</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">        <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">          <span class="dt">id=</span><span class="st">"render rmd"</span>,</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">          <span class="dt">r =</span> r,</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">          <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/render_rmd:master"</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">        ),</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">        <span class="kw"><a href="../reference/cr_buildstep_nginx_setup.html">cr_buildstep_nginx_setup</a></span>(<span class="st">"/workspace/"</span>),</a>
<a class="sourceLine" id="cb13-18" data-line-number="18">        <span class="kw"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(<span class="st">"html-on-cloudrun"</span>, <span class="dt">tag =</span> <span class="st">"$BUILD_ID"</span>),</a>
<a class="sourceLine" id="cb13-19" data-line-number="19">        <span class="kw"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span>(<span class="dt">name =</span> <span class="st">"my-html-on-cloudrun"</span>,</a>
<a class="sourceLine" id="cb13-20" data-line-number="20">                         <span class="dt">image =</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,</a>
<a class="sourceLine" id="cb13-21" data-line-number="21">                         <span class="dt">concurrency =</span> <span class="dv">80</span>)</a>
<a class="sourceLine" id="cb13-22" data-line-number="22">        ), </a>
<a class="sourceLine" id="cb13-23" data-line-number="23">    <span class="dt">images =</span> <span class="st">"gcr.io/mark-edmondson-gde/html-on-cloudrun:$BUILD_ID"</span>,</a>
<a class="sourceLine" id="cb13-24" data-line-number="24">    )</a></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Run a test build to check it works.</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(build_rmd)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(b)</a></code></pre></div>
<p>You should see a Cloud Run URL in the logs, like this one: <code>https://my-html-on-cloudrun-ewjogewawq-ew.a.run.app/scheduled_rmarkdown.html</code></p>
<p><img src="rmd-on-cloudrun.png"></p>
<ol start="6" style="list-style-type: decimal">
<li>Schedule the build using cron syntax</li>
</ol>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">schedule_me &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(built)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"rmd-on-cloudrun"</span>, <span class="st">"15 8 * * *"</span>, <span class="dt">httpTarget =</span> schedule_me)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co">#==CloudScheduleJob==</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co">#name:  projects/project-name/locations/europe-west1/jobs/rmd-on-cloudrun </span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#state:  ENABLED </span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#httpTarget.uri:  https://cloudbuild.googleapis.com/v1/projects/project-name/builds </span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#httpTarget.httpMethod:  POST </span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#userUpdateTime:  2020-01-04T08:34:42Z </span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#schedule:  15 8 * * * </span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#timezone:  UTC </span></a></code></pre></div>
<div id="do-it-all-in-r-using-cr_deploy_r" class="section level3">
<h3 class="hasAnchor">
<a href="#do-it-all-in-r-using-cr_deploy_r" class="anchor"></a>Do it all in R using cr_deploy_r()</h3>
<p>An alternative if you only wanted to do a scheduled deployment would be to put all steps in an R script (downloading, building and uploading to Cloud Storage via <code>googleCloudStorageR</code>) and use the RStudio gadget or <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code></p>
<p><img src="gadget_r.png"></p>
</div>
</div>
<div id="polygot-cloud-builds---integrating-r-code-with-other-languages" class="section level2">
<h2 class="hasAnchor">
<a href="#polygot-cloud-builds---integrating-r-code-with-other-languages" class="anchor"></a>Polygot Cloud Builds - integrating R code with other languages</h2>
<p>Since Docker containers can hold any language within them, they offer a universal UI to combine languages. This offers opportunities to extend other languages with R features, and give other languages access to R code without needing to know R.</p>
<p>An example below uses:</p>
<ul>
<li>
<code>gcloud</code> - <a href="https://cloud.google.com/sdk/gcloud/">Google’s Cloud command line tool</a> to access Google’s key management store and download an authentication file, and pushes to BigQuery</li>
<li>
<code>gago</code> - <a href="https://github.com/MarkEdmondson1234/gago">A Go package for fast downloads of Google Analytics data</a>
</li>
<li>
<code>R</code> - R code to create an Rmd file that will hold interactive forecasts of the Google Analytics data via <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>
</li>
<li>
<code>nginx</code> - serve up the Rmd files rendered into HTML and hosted on Cloud Run via <code><a href="../reference/cr_deploy_run.html">cr_deploy_html()</a></code>
</li>
</ul>
<p>And will perform downloading unsampled data from Google Analytics, creating a statistical report of the data and then uploading the raw data to BigQuery for further analysis.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleCloudRunner)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">polygot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  <span class="dt">steps =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">      <span class="dt">id =</span> <span class="st">"download encrypted auth file"</span>,</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">      <span class="dt">name =</span> <span class="st">"gsutil"</span>,</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">               <span class="st">"gs://marks-bucket-of-stuff/auth.json.enc"</span>,</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">               <span class="st">"/workspace/auth.json.enc"</span>),</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">    ),</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">    <span class="kw"><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt</a></span>(</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">      <span class="dt">id =</span> <span class="st">"decrypt file"</span>,</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">      <span class="dt">cipher =</span> <span class="st">"/workspace/auth.json.enc"</span>,</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">      <span class="dt">plain =</span> <span class="st">"/workspace/auth.json"</span>,</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">      <span class="dt">keyring =</span> <span class="st">"my-keyring"</span>,</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">      <span class="dt">key =</span> <span class="st">"ga_auth"</span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    ),</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">      <span class="dt">id =</span> <span class="st">"download google analytics"</span>,</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">      <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/gago:master"</span>,</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">      <span class="dt">env =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"GAGO_AUTH=/workspace/auth.json"</span>),</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"reports"</span>,</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">               <span class="st">"--view=81416156"</span>,</a>
<a class="sourceLine" id="cb16-24" data-line-number="24">               <span class="st">"--dims=ga:date,ga:medium"</span>,</a>
<a class="sourceLine" id="cb16-25" data-line-number="25">               <span class="st">"--mets=ga:sessions"</span>,</a>
<a class="sourceLine" id="cb16-26" data-line-number="26">               <span class="st">"--start=2014-01-01"</span>,</a>
<a class="sourceLine" id="cb16-27" data-line-number="27">               <span class="st">"--end=2019-11-30"</span>,</a>
<a class="sourceLine" id="cb16-28" data-line-number="28">               <span class="st">"--antisample"</span>,</a>
<a class="sourceLine" id="cb16-29" data-line-number="29">               <span class="st">"--max=-1"</span>,</a>
<a class="sourceLine" id="cb16-30" data-line-number="30">               <span class="st">"-o=google_analytics.csv"</span>),</a>
<a class="sourceLine" id="cb16-31" data-line-number="31">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb16-32" data-line-number="32">    ),</a>
<a class="sourceLine" id="cb16-33" data-line-number="33">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb16-34" data-line-number="34">      <span class="dt">id =</span> <span class="st">"download Rmd template"</span>,</a>
<a class="sourceLine" id="cb16-35" data-line-number="35">      <span class="dt">name =</span> <span class="st">"gsutil"</span>,</a>
<a class="sourceLine" id="cb16-36" data-line-number="36">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,</a>
<a class="sourceLine" id="cb16-37" data-line-number="37">               <span class="st">"gs://mark-edmondson-public-read/polygot.Rmd"</span>,</a>
<a class="sourceLine" id="cb16-38" data-line-number="38">               <span class="st">"/workspace/build/polygot.Rmd"</span>)</a>
<a class="sourceLine" id="cb16-39" data-line-number="39">    ),</a>
<a class="sourceLine" id="cb16-40" data-line-number="40">    <span class="kw"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(</a>
<a class="sourceLine" id="cb16-41" data-line-number="41">      <span class="dt">id=</span><span class="st">"render rmd"</span>,</a>
<a class="sourceLine" id="cb16-42" data-line-number="42">      <span class="dt">r =</span> <span class="st">"lapply(list.files('.', pattern = '.Rmd', full.names = TRUE),</span></a>
<a class="sourceLine" id="cb16-43" data-line-number="43"><span class="st">             rmarkdown::render, output_format = 'html_document')"</span>,</a>
<a class="sourceLine" id="cb16-44" data-line-number="44">      <span class="dt">name =</span> <span class="st">"gcr.io/gcer-public/packagetools:master"</span>,</a>
<a class="sourceLine" id="cb16-45" data-line-number="45">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb16-46" data-line-number="46">      ),</a>
<a class="sourceLine" id="cb16-47" data-line-number="47">    <span class="kw"><a href="../reference/cr_buildstep_bash.html">cr_buildstep_bash</a></span>(</a>
<a class="sourceLine" id="cb16-48" data-line-number="48">      <span class="dt">id =</span> <span class="st">"setup nginx"</span>,</a>
<a class="sourceLine" id="cb16-49" data-line-number="49">      <span class="dt">bash_script =</span> <span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"docker"</span>, <span class="st">"nginx"</span>, <span class="st">"setup.bash"</span>,</a>
<a class="sourceLine" id="cb16-50" data-line-number="50">                                <span class="dt">package =</span> <span class="st">"googleCloudRunner"</span>),</a>
<a class="sourceLine" id="cb16-51" data-line-number="51">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb16-52" data-line-number="52">      ),</a>
<a class="sourceLine" id="cb16-53" data-line-number="53">    <span class="kw"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(</a>
<a class="sourceLine" id="cb16-54" data-line-number="54">      <span class="co"># change to your own container registry</span></a>
<a class="sourceLine" id="cb16-55" data-line-number="55">      <span class="dt">image =</span> <span class="st">"gcr.io/gcer-public/polygot_demo"</span>,</a>
<a class="sourceLine" id="cb16-56" data-line-number="56">      <span class="dt">tag =</span> <span class="st">"latest"</span>,</a>
<a class="sourceLine" id="cb16-57" data-line-number="57">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb16-58" data-line-number="58">      ),</a>
<a class="sourceLine" id="cb16-59" data-line-number="59">    <span class="kw"><a href="../reference/cr_buildstep_run.html">cr_buildstep_run</a></span>(</a>
<a class="sourceLine" id="cb16-60" data-line-number="60">      <span class="dt">name =</span> <span class="st">"polygot-demo"</span>,</a>
<a class="sourceLine" id="cb16-61" data-line-number="61">      <span class="dt">image =</span> <span class="st">"gcr.io/gcer-public/polygot_demo"</span>,</a>
<a class="sourceLine" id="cb16-62" data-line-number="62">      <span class="dt">concurrency =</span> <span class="dv">80</span>),</a>
<a class="sourceLine" id="cb16-63" data-line-number="63">    <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(</a>
<a class="sourceLine" id="cb16-64" data-line-number="64">      <span class="dt">id =</span> <span class="st">"load BigQuery"</span>,</a>
<a class="sourceLine" id="cb16-65" data-line-number="65">      <span class="dt">name =</span> <span class="st">"gcr.io/cloud-builders/gcloud"</span>,</a>
<a class="sourceLine" id="cb16-66" data-line-number="66">      <span class="dt">entrypoint =</span> <span class="st">"bq"</span>,</a>
<a class="sourceLine" id="cb16-67" data-line-number="67">      <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"--location=EU"</span>,</a>
<a class="sourceLine" id="cb16-68" data-line-number="68">               <span class="st">"load"</span>,</a>
<a class="sourceLine" id="cb16-69" data-line-number="69">               <span class="st">"--autodetect"</span>,</a>
<a class="sourceLine" id="cb16-70" data-line-number="70">               <span class="st">"--source_format=CSV"</span>,</a>
<a class="sourceLine" id="cb16-71" data-line-number="71">               <span class="st">"test_EU.polygot"</span>,</a>
<a class="sourceLine" id="cb16-72" data-line-number="72">               <span class="st">"google_analytics.csv"</span></a>
<a class="sourceLine" id="cb16-73" data-line-number="73">               ),</a>
<a class="sourceLine" id="cb16-74" data-line-number="74">      <span class="dt">dir =</span> <span class="st">"build"</span></a>
<a class="sourceLine" id="cb16-75" data-line-number="75">    )</a>
<a class="sourceLine" id="cb16-76" data-line-number="76">  )</a>
<a class="sourceLine" id="cb16-77" data-line-number="77">)</a>
<a class="sourceLine" id="cb16-78" data-line-number="78"></a>
<a class="sourceLine" id="cb16-79" data-line-number="79"><span class="co"># build the polygot cloud build steps</span></a>
<a class="sourceLine" id="cb16-80" data-line-number="80">build &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build.html">cr_build</a></span>(polygot)</a>
<a class="sourceLine" id="cb16-81" data-line-number="81">built &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(build)</a></code></pre></div>
<p>An example of the demo output is on this Cloud Run instance URL: <code>https://polygot-demo-ewjogewawq-ew.a.run.app/polygot.html</code></p>
<p><img src="polygot-html.png"></p>
<p>It also uploads the data to a BigQuery table:</p>
<p><img src="polygot-bq-load.png"></p>
<p>This constructed cloud build can also be used outside of R, by writing out the Cloud Build file via <code><a href="../reference/cr_build_write.html">cr_build_write()</a></code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># write out to cloudbuild.yaml for other languages</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw"><a href="../reference/cr_build_write.html">cr_build_write</a></span>(polygot)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co"># 2019-12-28 19:15:50&gt; Writing to cloudbuild.yaml</span></a></code></pre></div>
<p>This can then be scheduled as described in Cloud Scheduler section on <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudscheduler.html">scheduled cloud builds</a>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">schedule_me &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(built)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"polygot-example"</span>, <span class="st">"15 8 * * *"</span>, <span class="dt">httpTarget =</span> schedule_me)</a></code></pre></div>
<p>An example of the cloudbuild.yaml is on GitHub <a href="https://raw.githubusercontent.com/MarkEdmondson1234/googleCloudRunner/master/inst/polygot/cloudbuild.yaml">here</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#deploy-a-pkgdown-website-for-your-r-package">Deploy a pkgdown website for your R package</a></li>
      <li><a href="#run-package-tests-and-code-coverage">Run package tests and code coverage</a></li>
      <li><a href="#create-docker-image-of-a-package-each-commit">Create Docker image of a package each commit</a></li>
      <li><a href="#migrate-an-existing-scheduled-docker-container">Migrate an existing scheduled Docker container</a></li>
      <li><a href="#trigger-an-r-function-from-pubsub">Trigger an R function from pubsub</a></li>
      <li><a href="#build-an-rmd-each-git-commit-and-host-its-html-on-cloud-storage">Build an Rmd each git commit and host its HTML on Cloud Storage</a></li>
      <li><a href="#build-and-deploy-rmd-files-to-cloud-run-on-a-schedule">Build and deploy Rmd files to Cloud Run on a schedule</a></li>
      <li><a href="#polygot-cloud-builds---integrating-r-code-with-other-languages">Polygot Cloud Builds - integrating R code with other languages</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
