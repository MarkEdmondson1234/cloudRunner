<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Setup • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Setup">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Setup</h1>
            
            <h4 class="date">2020-03-28</h4>
      
      
      <div class="hidden name"><code>setup.Rmd</code></div>

    </div>

    
    
<div id="r-settings" class="section level2">
<h2 class="hasAnchor">
<a href="#r-settings" class="anchor"></a>R Settings</h2>
<ul>
<li>Reuses environment argument <code>GCE_AUTH_FILE</code> from <a href="https://cloudyr.github.io/googleComputeEngineR">googleComputeEngineR</a> which holds location of your service auth JSON</li>
<li>Reuses environment argument <code>GCE_DEFAULT_PROJECT_ID</code> from googleComputeEngineR</li>
<li>Reuses environment argument <code>GCS_DEFAULT_BUCKET</code> from <a href="http://code.markedmondson.me/googleCloudStorageR/">googleCloudStorageR</a>
</li>
<li>New environment argument <code>CR_REGION</code> can be one of</li>
</ul>
<pre><code>"us-central1",
"asia-northeast1",
"europe-west1",
"us-east1"</code></pre>
<ul>
<li>New environment argument <code>CR_BUILD_EMAIL</code> that is a Google service email (see GCP setup)</li>
</ul>
<p>e.g. your <code>.Renviron</code> should look like:</p>
<pre><code>GCE_AUTH_FILE="/Users/me/auth/auth.json"
GCE_DEFAULT_PROJECT_ID="my-project"
GCS_DEFAULT_BUCKET="my-bucket"
CR_REGION="europe-west1"
CR_BUILD_EMAIL=googlecloudrunner@your-project.iam.gserviceaccount.com</code></pre>
<p>This <code>.Renviron</code> file can be placed in the root of your project or as per what is described in <code><a href="https://rdrr.io/r/base/Startup.html">?Startup</a></code>.</p>
<p>You can also set the above in the R scripts via:</p>
<ul>
<li><code><a href="../reference/cr_region_set.html">cr_region_set()</a></code></li>
<li><code><a href="../reference/cr_project_set.html">cr_project_set()</a></code></li>
<li><code><a href="../reference/cr_bucket_set.html">cr_bucket_set()</a></code></li>
<li><code><a href="../reference/cr_email_set.html">cr_email_set()</a></code></li>
</ul>
<p>Or auth via</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">googleAuthR<span class="op">::</span><span class="kw">gar_service_auth</span>(<span class="st">"my_auth_json.com"</span>)</a></code></pre></div>
</div>
<div id="gcp-settings" class="section level2">
<h2 class="hasAnchor">
<a href="#gcp-settings" class="anchor"></a>GCP settings</h2>
<div id="authentication-background" class="section level3">
<h3 class="hasAnchor">
<a href="#authentication-background" class="anchor"></a>Authentication background</h3>
<p>The package uses several interacting Google Cloud services so setup needs to cover authentication both for yourself and the services interacting on your behalf.</p>
<p>There are three types of authentication to keep track of:</p>
<ol style="list-style-type: decimal">
<li>Authenticating your local R session so it can submit jobs</li>
<li>Authenticating Cloud Build so it can do the script you have submitted</li>
<li>Authenticating services such as Cloud Scheduler so they can trigger builds on your behalf.</li>
</ol>
<p>Its simplest if you use the same authentication key for 1 and 3, and the default Cloud Build service email for 2.</p>
<p>Confusion can occur if you use the Cloud Build service email from 2 for 1 or 3.</p>
</div>
<div id="suggested-setup" class="section level3">
<h3 class="hasAnchor">
<a href="#suggested-setup" class="anchor"></a>Suggested setup</h3>
<p>The suggested setup is only required once per GCP project. Following the below instructions will mean:</p>
<ol style="list-style-type: decimal">
<li>You can use all R functions in the package to trigger builds locally with a dedicated service key</li>
<li>You can reuse the Cloud Build service email to authenticate build services (such as gcloud and BigQuery)</li>
<li>Scheduled builds will reuse the key you use locally</li>
</ol>
<p>Follow these steps:</p>
<div id="local-auth-email" class="section level4">
<h4 class="hasAnchor">
<a href="#local-auth-email" class="anchor"></a>Local auth email</h4>
<ol style="list-style-type: decimal">
<li>Log in to your Google Cloud Project with billing enabled</li>
<li>Go to <code>IAM &amp; Admin &gt; Service accounts</code>
</li>
<li>Click “Create Service Account”</li>
<li>Create a service account ID - see suggested example here:</li>
</ol>
<p><img src="cr_service_email.png"></p>
<ol start="5" style="list-style-type: decimal">
<li>Set the roles of the service account on the next screen to these:</li>
</ol>
<p><img src="service-roles.png"></p>
<ul>
<li>Cloud Build Service Account</li>
<li>Cloud Scheduler Admin</li>
<li>Service Account User</li>
<li>Cloud Run Admin</li>
<li>Storage Object Admin (or Storage Admin to setup pub/sub)</li>
</ul>
<ol start="6" style="list-style-type: decimal">
<li>Give yourself access as a user to the service account, then click “Create key” and select “JSON”</li>
<li>Download the auth json key and put it in a folder separate from all R projects or git commits. <strong>This file should be guarded as it grants access to sensitive operations</strong>
</li>
<li>Set your <code>.Renviron</code> file to point at the JSON file you just downloaded, and use its service email for scheduled builds e.g.:</li>
</ol>
<pre><code>GCE_AUTH_FILE="/Users/me/auth/auth.json"
CR_BUILD_EMAIL=googlecloudrunner@your-project.iam.gserviceaccount.com</code></pre>
<ol start="9" style="list-style-type: decimal">
<li>Ensure you have the Cloud Build, Cloud Run, Cloud Storage and Cloud Scheduler APIs turned on in your GCP project via the <code>GCP console &gt; APIs &amp; Services</code>
</li>
</ol>
</div>
<div id="the-cloud-build-service-account" class="section level4">
<h4 class="hasAnchor">
<a href="#the-cloud-build-service-account" class="anchor"></a>The Cloud Build service account</h4>
<p>This is the service account for Cloud Build when it is running on your project. It is created automatically, and should look like <code>{project-number}@cloudbuild.gserviceaccount.com</code> when you examine your IAM console.</p>
<ul>
<li>The Cloud Build service account needs permissions if you want it to deploy to Cloud Run: This can be set <a href="https://console.cloud.google.com/cloud-build/settings">here</a> where you enable <code>Cloud Run Admin</code> and <code>Service Account User</code> roles. More details found at this <a href="https://cloud.google.com/cloud-build/docs/deploying-builds/deploy-cloud-run">Google reference article</a>.</li>
<li>Ensure you also have a service email in your IAM section called <code>service-{project-number}@gcp-sa-cloudscheduler.iam.gserviceaccount.com</code> with Cloud Scheduler Service Agent role. This is only needed if you created the project before March 2019. This only needs to exist in the GCP project, it is not used in deployment. See <a href="https://cloud.google.com/scheduler/docs/http-target-auth#add">here</a>
</li>
<li>If you want to use the decryption service such as from <code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code> then your Cloud Build service account (<code>{project-number}@cloudbuild.gserviceaccount.com</code>) needs to have at least Cloud KMS CryptoKey Decrypter role. See <a href="https://cloud.google.com/cloud-build/docs/securing-builds/use-encrypted-secrets-credentials#grant_the_product_name_short_service_account_access_to_the_cryptokey">granting access to CryptoKey</a> article.</li>
<li>Likewise with other GCP services the Cloud Build will use - i.e. if you want to use BigQuery services in your builds, give your build email BigQuery IAM access</li>
</ul>
</div>
<div id="misc" class="section level4">
<h4 class="hasAnchor">
<a href="#misc" class="anchor"></a>Misc</h4>
<ul>
<li>If you want to use GitHub or BitBucket repos, you need to setup mirroring them via Cloud Source Repositories <a href="https://source.cloud.google.com/" class="uri">https://source.cloud.google.com/</a>
</li>
<li>To use Cloud Scheduler you may need to initiate an App Engine application <a href="https://console.developers.google.com/appengine" class="uri">https://console.developers.google.com/appengine</a> - you only need to set the region (one allowed per GCP project) and you don’t need to create an app</li>
</ul>
</div>
<div id="customise" class="section level4">
<h4 class="hasAnchor">
<a href="#customise" class="anchor"></a>Customise?</h4>
<p>The above should give you the minimal access required for <code>googleCloudRunner</code>. It could be modified to increase the amount of services the local auth file has access to such as Compute Engine VMs etc. (if say you wanted to reuse it for <code>googleComputeEngineR</code>)</p>
<p>You could also change the build email set in <code>CR_BUILD_EMAIL</code> to be yet another service account, perhaps one with less permissions (such as Cloud Run Invoker, not Cloud Run Admin)</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#r-settings">R Settings</a></li>
      <li><a href="#gcp-settings">GCP settings</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
