<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serverless batched R scripts via Cloud Build • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Serverless batched R scripts via Cloud Build">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Serverless batched R scripts via Cloud Build</h1>
            
            <h4 class="date">2020-04-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/master/vignettes/cloudbuild.Rmd"><code>vignettes/cloudbuild.Rmd</code></a></small>
      <div class="hidden name"><code>cloudbuild.Rmd</code></div>

    </div>

    
    
<p>Cloud Build uses <a href="https://www.docker.com/resources/what-container">Docker containers</a> to run everything. This means it can run almost any language/program or application including R. Having an easy way to create and trigger these builds from R means R can serve as a UI or gateway to any other program e.g. R can trigger a Cloud Build using <code>gcloud</code> to deploy Cloud Run applications.</p>
<p>The first 120 mins per day are free. <a href="https://cloud.google.com/cloud-build/pricing">See here for more priceinfo.</a></p>
<p>If you want to run scripts that can be triggered one time, batch style, and set them up to trigger on GitHub events or pub/sub, or schedule them using Cloud Scheduler then Cloud Build is suited to your use case.</p>
<p>If you would also like to have your R code react in realtime to events such as HTTP or sub/sub events, such as a website or API endpoint, consider <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudrun.html">Cloud Run</a>.</p>
<div id="cloudbuild-yaml" class="section level2">
<h2 class="hasAnchor">
<a href="#cloudbuild-yaml" class="anchor"></a>cloudbuild.yaml</h2>
<p>Cloud Build is centered around the <a href="https://cloud.google.com/cloud-build/docs/build-config">cloudbuild.yaml format</a> - you can use existing cloudbuild.yaml files or create your own in R using the cloudbuild.yaml helper functions.</p>
<p>An example cloudbuild.yaml is shown below - this outputs the versions of docker and echos “Hello Cloud Build” and calls an R function:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">steps:</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> </span><span class="st">'gcr.io/cloud-builders/docker'</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="fu">id:</span><span class="at"> Docker Version</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="fu">args:</span><span class="at"> </span><span class="kw">[</span><span class="st">"version"</span><span class="kw">]</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> </span><span class="st">'alpine'</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="fu">id:</span><span class="at">  Hello Cloud Build</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  <span class="fu">args:</span><span class="at"> </span><span class="kw">[</span><span class="st">"echo"</span><span class="kw">,</span> <span class="st">"Hello Cloud Build"</span><span class="kw">]</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> </span><span class="st">'rocker/r-base'</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  <span class="fu">id:</span><span class="at"> Hello R</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  <span class="fu">args:</span><span class="at"> </span><span class="kw">[</span><span class="st">"R"</span><span class="kw">,</span> <span class="st">"-e"</span><span class="kw">,</span> <span class="st">"paste0('1 + 1 = ', 1+1)"</span><span class="kw">]</span></a></code></pre></div>
<p>This cloudbuild.yaml file can be built directly via the <code><a href="../reference/cr_build.html">cr_build()</a></code> function. The build will by default trigger a website URL to open with the build logs.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">b1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="st">"cloudbuild.yaml"</span>)</pre></body></html></div>
<p>Or you can choose to wait in R for the build to finish, like below:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">b2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="st">"cloudbuild.yaml"</span>, <span class="kw">launch_browser</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">b3</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(<span class="no">b2</span>)
<span class="co"># Waiting for build to finish:</span>
<span class="co">#  |===||</span>
<span class="co"># Build finished</span>
<span class="co"># ==CloudBuildObject==</span>
<span class="co"># buildId:  c673143a-794d-4c69-8ad4-e777d068c066 </span>
<span class="co"># status:  SUCCESS </span>
<span class="co"># logUrl:  https://console.cloud.google.com/gcr/builds/c673143a-794d-4c69-8ad4-e777d068c066?project=1080525199262 </span>
<span class="co"># ...</span></pre></body></html></div>
<p>You can export an existing build into a cloudbuild.yaml file, for instance to run in another project not using R.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_build_write.html">cr_build_write</a></span>(<span class="no">b3</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="st">"cloudbuild.yml"</span>)</pre></body></html></div>
<p>You can also reuse Cloud Build objects to re-run a new build with the same settings. This is helpful when you test a build works locally, then pass the result of a successful run to <code><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http()</a></code> to schedule it.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># a cloud build you would like to schedule</span>
<span class="no">itworks</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="st">"cloudbuild.yaml"</span>, <span class="kw">launch_browser</span> <span class="kw">=</span> <span class="fl">FALSE</span>)

<span class="co"># once working, pass in the build to the scheduler</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"15 5 * * *"</span>, <span class="kw">name</span><span class="kw">=</span><span class="st">"itworks-schedule"</span>,
            <span class="kw">httpTarget</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(<span class="no">itworks</span>))</pre></body></html></div>
<p>Any utility that has a Docker image can be used within Cloud Build steps. Some <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community">community contributed Cloud Build images are listed here</a>, including <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/hugo">hugo</a>, <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/make">make</a>, and <a href="https://github.com/GoogleCloudPlatform/cloud-builders-community/tree/master/tar">tar</a>, or you can configure your own Dockerfile and build what image you need yourself, perhaps by using a previous Cloud Build and <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code></p>
</div>
<div id="cloud-build-source" class="section level2">
<h2 class="hasAnchor">
<a href="#cloud-build-source" class="anchor"></a>Cloud Build source</h2>
<p>Cloud Builds sometimes need code or data to work on to be useful.</p>
<p>All cloudbuilds are launched in a serverless environment with a default directory <code>/workspace/</code>. The Source is copied into this workspace before the build steps execute, so steps can share state and files.</p>
<p>Cloud Build sources are specified by the <code>source</code> argument.</p>
<p>A source can be a <a href="https://cloud.google.com/source-repositories/">Cloud Source Repository</a> (perhaps mirrored from GitHub) or a <a href="https://cloud.google.com/storage/">Cloud Storage</a> bucket containing the code/data you want to operate on. An example of specifying both is below:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">gcs_source</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span>(
  <span class="fu"><a href="../reference/StorageSource.html">StorageSource</a></span>(<span class="st">"gs://my-bucket"</span>, <span class="st">"my_code.tar.gz"</span>))

<span class="no">repo_source</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span>(
  <span class="fu"><a href="../reference/RepoSource.html">RepoSource</a></span>(<span class="st">"github_markedmondson1234_googlecloudrunner"</span>,
             <span class="kw">branchName</span><span class="kw">=</span><span class="st">"master"</span>))

<span class="no">build1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="st">"cloudbuild.yaml"</span>, <span class="kw">source</span> <span class="kw">=</span> <span class="no">gcs_source</span>)
<span class="no">build2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="st">"cloudbuild.yaml"</span>, <span class="kw">source</span> <span class="kw">=</span> <span class="no">repo_source</span>)</pre></body></html></div>
<p><code><a href="../reference/cr_build_upload_gcs.html">cr_build_upload_gcs()</a></code> is a helper function for automating creation of a Google Cloud Storage source - this uses <a href="http://code.markedmondson.me/googleCloudStorageR/"><code>googleCloudStorageR</code></a> to tar and upload your source code locally to your bucket, making it available to your build.</p>
<p>This returns a <code>Source</code> object that can be used in build functions:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">storage</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_upload_gcs.html">cr_build_upload_gcs</a></span>(<span class="st">"my_folder"</span>)
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="no">my_yaml</span>, <span class="kw">source</span> <span class="kw">=</span> <span class="no">storage</span>)</pre></body></html></div>
</div>
<div id="cloud-build-macros" class="section level2">
<h2 class="hasAnchor">
<a href="#cloud-build-macros" class="anchor"></a>Cloud Build macros</h2>
<p>Cloud Builds can use reserved macros and variables to help with deployments in a continuous development situation. For instance, files can be named according to the Git branch they are committed from. These are listed in <code><a href="../reference/Build.html">?Build</a></code> and reproduced below:</p>
<ul>
<li>$PROJECT_ID: the project ID of the build.</li>
<li>$BUILD_ID: the autogenerated ID of the build.</li>
<li>$REPO_NAME: the source repository name specified by RepoSource.</li>
<li>$BRANCH_NAME: the branch name specified by RepoSource.</li>
<li>$TAG_NAME: the tag name specified by RepoSource.</li>
<li>$REVISION_ID or $COMMIT_SHA: the commit SHA specified by RepoSource or resolved from the specified branch or tag.</li>
<li>$SHORT_SHA: first 7 characters of $REVISION_ID or $COMMIT_SHA.</li>
</ul>
<p>Custom macros can also be configured, starting with _$ e.g. $_MY_CUSTOM_MACRO</p>
</div>
<div id="creating-cloudbuild-yml-build-steps" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-cloudbuild-yml-build-steps" class="anchor"></a>Creating cloudbuild.yml build steps</h2>
<p>Instead of using separate <code>cloudbuild.yml</code> files, you can also choose to make your own cloudbuild.yaml files in R via <code><a href="../reference/cr_build_yaml.html">cr_build_yaml()</a></code> and <code><a href="../reference/cr_buildstep.html">cr_buildstep()</a></code></p>
<p>Lets say you don’t want to write a cloudbuild.yaml file - instead you can create all the features of the yaml files in R. Refer to the <a href="https://cloud.google.com/cloud-build/docs/build-config">cloudbuild.yml config spec</a> on what it expected in the files or functions.</p>
<p>An example below recreates a simple cloudbuild.yml file. If you print it to console it will output what the build would look like if it was in a yaml file:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(<span class="kw">steps</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>( <span class="st">"gcloud"</span>,<span class="st">"version"</span>))
<span class="co">#==cloudRunnerYaml==</span>
<span class="co">#steps:</span>
<span class="co">#- name: gcr.io/cloud-builders/gcloud</span>
<span class="co">#  args: version</span></pre></body></html></div>
<p>You can write back out into your own cloudbuild.yml</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">my_yaml</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(<span class="kw">steps</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>( <span class="st">"gcloud"</span>,<span class="st">"version"</span>))
<span class="fu"><a href="../reference/cr_build_write.html">cr_build_write</a></span>(<span class="no">my_yaml</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="st">"cloudbuild.yaml"</span>)</pre></body></html></div>
<p>And also edit or extract steps from existing cloudbuild.yml files via <code><a href="../reference/cr_buildstep_edit.html">cr_buildstep_edit()</a></code> and <code><a href="../reference/cr_buildstep_extract.html">cr_buildstep_extract()</a></code>.</p>
<p>This allows you to programmatically create cloudbuild yaml files for other languages and triggers. See more at this article on <a href="https://cloud.google.com/cloud-build/docs/create-custom-build-steps">creating custom build steps with your own Docker images</a>.</p>
</div>
<div id="pre-made-build-step-templates" class="section level2">
<h2 class="hasAnchor">
<a href="#pre-made-build-step-templates" class="anchor"></a>Pre-made Build Step templates</h2>
<p>Using the above build step editing functions, some helpful build steps you can use in your own cloudbuild steps have been included in the package.</p>
<ul>
<li>
<code><a href="../reference/cr_buildstep_bash.html">cr_buildstep_bash()</a></code> - for including bash scripts</li>
<li>
<code><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker()</a></code> - for building and pushing Docker images</li>
<li>
<code><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret()</a></code> - storing secrets in the cloud and decrypting them</li>
<li>
<code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code> - for using Google Key management store to decrypt auth files</li>
<li>
<code><a href="../reference/cr_buildstep_git.html">cr_buildstep_git()</a></code> - for setting up and running git commands</li>
<li>
<code><a href="../reference/cr_buildstep_mailgun.html">cr_buildstep_mailgun()</a></code> - send an email with Mailgun.org</li>
<li>
<code><a href="../reference/cr_buildstep_nginx_setup.html">cr_buildstep_nginx_setup()</a></code> - setup hosting HTML files with nginx on Cloud Run</li>
<li>
<code><a href="../reference/cr_buildstep_pkgdown.html">cr_buildstep_pkgdown()</a></code> - for setting up pkgdown documentation of an R package</li>
<li>
<code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code> - for running R code</li>
<li>
<code><a href="../reference/cr_buildstep_slack.html">cr_buildstep_slack()</a></code> - send a Slack webhook message</li>
</ul>
<p>If you have any requests for others, please <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/issues">raise an issue on GitHub</a>.</p>
<p>Combine buildsteps with <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> e.g.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(
      <span class="kw">steps</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
        <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"gcloud"</span>,<span class="st">"version"</span>),
        <span class="fu"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(<span class="st">"my-image"</span>, <span class="kw">tag</span><span class="kw">=</span><span class="st">"dev"</span>),
        <span class="fu"><a href="../reference/cr_buildstep_secret.html">cr_buildstep_secret</a></span>(<span class="st">"my_secret"</span>,<span class="st">"auth.json"</span>),
        <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="st">"sessionInfo()"</span>)),
      <span class="kw">images</span> <span class="kw">=</span> <span class="st">"gcr.io/my-project/my-image"</span>)</pre></body></html></div>
</div>
<div id="build-artifacts" class="section level2">
<h2 class="hasAnchor">
<a href="#build-artifacts" class="anchor"></a>Build Artifacts</h2>
<p>You may have some useful files or data after your buildsteps that you want to use later. You can specify these files as <strong>artifacts</strong> that will be uploaded to a Google Cloud Storage bucket after the build finishes. A helper function <code><a href="../reference/cr_build_artifacts.html">cr_build_artifacts()</a></code> will take your build object and download the files to your local directory via <code>googleCloudStorageR</code></p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">r</span> <span class="kw">&lt;-</span> <span class="st">"write.csv(mtcars,file = 'artifact.csv')"</span>
<span class="no">ba</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(
     <span class="kw">steps</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="no">r</span>),
     <span class="kw">artifacts</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_build_yaml_artifact.html">cr_build_yaml_artifact</a></span>(<span class="st">'artifact.csv'</span>)
     )

<span class="no">build</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="no">ba</span>)
<span class="no">built</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_wait.html">cr_build_wait</a></span>(<span class="no">build</span>)

<span class="fu"><a href="../reference/cr_build_artifacts.html">cr_build_artifacts</a></span>(<span class="no">built</span>)
<span class="co"># 2019-12-22 12:36:10 -- Saved artifact.csv to artifact.csv (1.7 Kb)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="st">"artifact.csv"</span>)
<span class="co">#                     X  mpg cyl  disp  hp drat    wt  qsec vs am gear carb</span>
<span class="co">#1            Mazda RX4 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4</span>
<span class="co">#2        Mazda RX4 Wag 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4</span>
<span class="co">#3           Datsun 710 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1</span>
<span class="co">#4       Hornet 4 Drive 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1</span>
<span class="co"># ... etc ...</span></pre></body></html></div>
<div id="rstudio-gadget---build-docker" class="section level3">
<h3 class="hasAnchor">
<a href="#rstudio-gadget---build-docker" class="anchor"></a>RStudio Gadget - build Docker</h3>
<p>If you are using RStudio, installing the library will enable an <a href="https://rstudio.github.io/rstudioaddins/">RStudio Addin</a> that can be called after you have setup the library as per the setup page.</p>
<p>It includes a Shiny gadget that you can call via the Addin menu in RStudio, via <code><a href="../reference/cr_deploy_gadget.html">googleCloudRunner::cr_deploy_gadget()</a></code> or assigned to a hotkey (I use CTRL+SHIFT+D).</p>
<p>This sets up a Shiny UI to help smooth out deployments as pictured:</p>
<p><img src="gadget_docker.png"></p>
</div>
</div>
<div id="r-buildsteps" class="section level2">
<h2 class="hasAnchor">
<a href="#r-buildsteps" class="anchor"></a>R buildsteps</h2>
<p>Focusing on one buildstep in particular, since this is an R package - you can send in R code into a build trigger using <code><a href="../reference/cr_buildstep_r.html">cr_buildstep_r()</a></code>.</p>
<p>It accepts both inline R code or a file location. This R code is executed in the R environment as specified in argument <code>name</code> - they default to the R images provided by Rocker <a href="https://www.rocker-project.org/">rocker-project.org</a>.</p>
<p>Or if you want to build your own images (in perhaps another Cloud Build using <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code>) you can use your own R images with custom R packages and resources.</p>
<p>Some useful R images have been made you could use or refer to their Dockerfiles for:</p>
<ul>
<li>
<code>gcr.io/gcer-public/packagetools</code> - installs: devtools covr rhub pkgdown goodpractice httr plumber rmarkdown</li>
<li>
<code>gcr.io/gcer-public/render_rmd</code> - installs: pkgdown rmarkdown flexdashboard blogdown bookdown</li>
<li>
<code>gcr.io/gcer-public/googlecloudrunner</code> - installs: containerit, googleCloudStorageR, plumber, googleCloudRunner</li>
</ul>
<p>The R code can be created within the Build at build time, or you can refer to an existing R script within the Source.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="co"># create an R buildstep inline</span>
<span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"paste('1+1=', 1+1)"</span>, <span class="st">"sessionInfo()"</span>))

<span class="co"># create an R buildstep from a local file</span>
<span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="st">"my-r-file.R"</span>)

<span class="co"># create an R buildstep from a file within the source of the Build</span>
<span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="st">"inst/schedule/schedule.R"</span>, <span class="kw">r_source</span> <span class="kw">=</span> <span class="st">"runtime"</span>)

<span class="co"># use a different Rocker image e.g. rocker/verse</span>
<span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"library(dplyr)"</span>, <span class="st">"mtcars %&gt;% select(mpg)"</span>, <span class="st">"sessionInfo"</span>),
                <span class="kw">name</span> <span class="kw">=</span> <span class="st">"verse"</span>)

<span class="co"># use your own R image with custom R</span>
<span class="no">my_r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"devtools::install()"</span>, <span class="st">"pkgdown::build_site()"</span>)
<span class="no">br</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="../reference/cr_buildstep_r.html">cr_buildstep_r</a></span>(<span class="no">my_r</span>, <span class="kw">name</span><span class="kw">=</span> <span class="st">"gcr.io/gcer-public/packagetools:master"</span>)

<span class="co"># send it for building</span>
<span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(<span class="kw">steps</span><span class="kw">=</span><span class="no">br</span>))</pre></body></html></div>
</div>
<div id="build-triggers" class="section level2">
<h2 class="hasAnchor">
<a href="#build-triggers" class="anchor"></a>Build Triggers</h2>
<p>Once you have build steps and possibly a source created, you can either set these up to run on a schedule via <code><a href="../reference/cr_schedule.html">cr_schedule()</a></code> or you can use triggers that will run upon certain events.</p>
<div id="setting-up-build-triggers-in-the-web-ui" class="section level3">
<h3 class="hasAnchor">
<a href="#setting-up-build-triggers-in-the-web-ui" class="anchor"></a>Setting up Build Triggers in the Web UI</h3>
<p>The quickest way to get going is to use the web UI for Build Triggers (<code>https://console.cloud.google.com/cloud-build/triggers</code>)</p>
<ol style="list-style-type: decimal">
<li>Link your repo (GitHub, Bitbucket or Cloud Repositories) to Google</li>
<li>Create your Cloud Build using <code><a href="../reference/cr_build_yaml.html">cr_build_yaml()</a></code> etc.</li>
<li>Write out to a <code>cloudbuild.yml</code> file in your repository (by default the root directory is checked)</li>
<li>Setup the Build Trigger in the Web UI (<code>https://console.cloud.google.com/cloud-build/triggers</code>)</li>
<li>Make a git commit and check the Cloud Build has run in the history (<code>https://console.cloud.google.com/cloud-build/builds</code>)</li>
<li>Modify the <code>cloudbuild.yml</code> file as you need, recommit to trigger a new build.</li>
</ol>
<p>Learn how to set them up at this Google article on <a href="https://cloud.google.com/cloud-build/docs/running-builds/create-manage-triggers">creating and managing build triggers</a>.</p>
<p>From there you get the option of connecting a repository either by mirroring it from GitHub/Bitbucket or using Cloud Source Repositories.</p>
<p>You can setup either Docker builds by just providing the location of the <code>Dockerfile</code>, or have more control by providing a <code>cloudbuild.yml</code> - by default these are looked for in the root directory.</p>
<p>Here are some example for this package’s GitHub repo:</p>
<p><img src="buildtrigger_screen.png"></p>
<ul>
<li>The “do package checks” performs authenticated tests against the package</li>
<li>The “git auth and push pkgdown website” rebuilds the website each commit to master branch.</li>
<li>“Build a dockerfile for package builds” builds the <code>gcr.io/gcer-public/packagetools</code> image</li>
<li>“pushGoogleCloudRunnerToGcerPublic” builds the <code>gcr.io/gcer-public/googlecloudrunner</code> image</li>
</ul>
<p><img src="buildtrigger_example.png"></p>
</div>
<div id="build-triggers-via-code-experimental" class="section level3">
<h3 class="hasAnchor">
<a href="#build-triggers-via-code-experimental" class="anchor"></a>Build Triggers via code (Experimental)</h3>
<blockquote>
<p>This API is experimental, so may not be reliable for production</p>
</blockquote>
<p>Build Triggers can be made via R code using the <code><a href="../reference/cr_buildtrigger.html">cr_buildtrigger()</a></code> function.</p>
<p>Build Triggers include GitHub commits and pull requests.</p>
<p>The example below shows how to set up some of the builds above:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">cloudbuild</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"cloudbuild/cloudbuild.yaml"</span>,
                            <span class="kw">package</span> <span class="kw">=</span> <span class="st">"googleCloudRunner"</span>)
<span class="no">bb</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(<span class="no">cloudbuild</span>, <span class="kw">projectId</span> <span class="kw">=</span> <span class="st">"test-project"</span>)
<span class="no">github</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/GitHubEventsConfig.html">GitHubEventsConfig</a></span>(<span class="st">"MarkEdmondson1234/googleCloudRunner"</span>, <span class="kw">branch</span> <span class="kw">=</span> <span class="st">"master"</span>)

<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span>(<span class="st">"trig1"</span>, <span class="kw">trigger</span> <span class="kw">=</span> <span class="no">github</span>, <span class="kw">build</span> <span class="kw">=</span> <span class="no">bb</span>)</pre></body></html></div>
<p>The Build macros can also be configured by passing in a named list:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co"># creates a trigger with named substitutions</span>
<span class="no">ss</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">`$_MYVAR`</span> <span class="kw">=</span> <span class="st">"TEST1"</span>, <span class="kw">`$_GITHUB`</span> <span class="kw">=</span> <span class="st">"MarkEdmondson1234/googleCloudRunner"</span>)
<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span>(<span class="st">"trig2"</span>, <span class="kw">trigger</span> <span class="kw">=</span> <span class="no">github</span>, <span class="kw">build</span> <span class="kw">=</span> <span class="no">bb</span>, <span class="kw">substitutions</span> <span class="kw">=</span> <span class="no">ss</span>)</pre></body></html></div>
<p>The above examples will create the build step inline within the trigger, but you can also use existing cloudbuild.yaml files by specifying where in the repository the build file will be:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co"># create a trigger that will build from the file in the repo</span>
<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span>(<span class="st">"trig3"</span>, <span class="kw">trigger</span> <span class="kw">=</span> <span class="no">github</span>, <span class="kw">build</span> <span class="kw">=</span> <span class="st">"cloudbuild.yaml"</span>)</pre></body></html></div>
<p>This way you can commit changes to the cloudbuild.yaml file, and they will be reflected in the Build Trigger.</p>
</div>
<div id="connecting-to-github" class="section level3">
<h3 class="hasAnchor">
<a href="#connecting-to-github" class="anchor"></a>Connecting to GitHub</h3>
<p>You can connect via the <a href="https://cloud.google.com/source-repositories/docs/mirroring-a-github-repository">Source Repository mirroring service</a> or via the <a href="https://github.com/marketplace/google-cloud-build">Google Cloud Build GitHub app</a>.</p>
<div id="mirroring-github" class="section level4">
<h4 class="hasAnchor">
<a href="#mirroring-github" class="anchor"></a>Mirroring GitHub</h4>
<p>Mirroring the GitHub repo is necessary if using it for sources of builds.</p>
<p>Once your repo is mirrored it gives you a Cloud Repository name which is of the form <code>github_username_repo</code> - this you can add to a <code><a href="../reference/RepoSource.html">RepoSource()</a></code>:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="co"># this repo mirrored on Google Source repos</span>
<span class="no">my_repo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span>(
  <span class="fu"><a href="../reference/RepoSource.html">RepoSource</a></span>(<span class="st">"github_markedmondson1234_googlecloudrunner"</span>,
             <span class="kw">branchName</span><span class="kw">=</span><span class="st">"master"</span>))</pre></body></html></div>
</div>
<div id="cloud-build-github-app" class="section level4">
<h4 class="hasAnchor">
<a href="#cloud-build-github-app" class="anchor"></a>Cloud Build GitHub app</h4>
<p>If you want build triggers to trigger on pushes and pulls then the GitHub app is necessary.</p>
<p>You can create a GitHub build trigger using <code><a href="../reference/GitHubEventsConfig.html">GitHubEventsConfig()</a></code> - this will by default trigger builds when you push to any GitHub branch.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">cloudbuild</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"cloudbuild/cloudbuild.yaml"</span>,
                           <span class="kw">package</span> <span class="kw">=</span> <span class="st">"googleCloudRunner"</span>)
<span class="no">bb</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(<span class="no">cloudbuild</span>, <span class="kw">projectId</span> <span class="kw">=</span> <span class="st">"test-project"</span>)

<span class="co"># setting up the trigger event </span>
<span class="no">github</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/GitHubEventsConfig.html">GitHubEventsConfig</a></span>(<span class="st">"MarkEdmondson1234/googleCloudRunner"</span>,
                             <span class="kw">branch</span> <span class="kw">=</span> <span class="st">"master"</span>)

<span class="fu"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span>(<span class="st">"trig1"</span>, <span class="kw">trigger</span> <span class="kw">=</span> <span class="no">github</span>, <span class="kw">build</span> <span class="kw">=</span> <span class="no">bb</span>)</pre></body></html></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
