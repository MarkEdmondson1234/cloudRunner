<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deploy a Shiny app to Google Kubernetes Engine â€¢ googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Deploy a Shiny app to Google Kubernetes Engine">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/setup.html">R Setup</a>
    </li>
    <li>
      <a href="../articles/setup-gcp.html">GCP Setup</a>
    </li>
    <li>
      <a href="../articles/git.html">Git Setup</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/usecase-r-api-microservices.html">R API Microservices</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-cloudrun.html">Deploy Shiny on Cloud Run</a>
    </li>
    <li>
      <a href="../articles/usecase-shiny-kubernetes.html">Deploy Shiny on Kubernetes</a>
    </li>
    <li>
      <a href="../articles/usecase-package-docker-build.html">R Package Tools: Auto Docker images</a>
    </li>
    <li>
      <a href="../articles/usecase-testthat-coverage.html">R Package Tools: Testthat coverage</a>
    </li>
    <li>
      <a href="../articles/usecase-deploy-pkgdown-website.html">R Package Tools: Pkgdown websites</a>
    </li>
    <li>
      <a href="../articles/usecase-scheduled-r-builds.html">Scheduled R scripts in the Cloud</a>
    </li>
    <li>
      <a href="../articles/usecase-r-results-github.html">Save R output to GitHub</a>
    </li>
    <li>
      <a href="../articles/usecase-polygot-ga-imports-to-bigquery.html">Integrating R with other languages</a>
    </li>
    <li>
      <a href="../articles/usecase-r-event-driven-pubsub.html">Event-triggered R scripts with pub/sub</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Deploy a Shiny app to Google Kubernetes Engine</h1>
            
            <h4 class="date">2021-03-18</h4>
      
      
      <div class="hidden name"><code>usecase-shiny-kubernetes.Rmd</code></div>

    </div>

    
    
<p>If you have a Shiny app and a Google Kubernetes Engine (GKE) instance you can automate deployment of that app upon each git commit.</p>
<p>Each commit the buildsteps need to re-build the Docker container with the Shiny app code and environment, then deploy it to the GKE instance.</p>
<div id="dockerfile" class="section level3">
<h3 class="hasAnchor">
<a href="#dockerfile" class="anchor"></a>Dockerfile</h3>
<p>Assuming you have a shiny app in <code>./shiny/</code> relative to the Dockerfile, then a Dockerfile could look like:</p>
<pre><code>FROM rocker/shiny

# install R package dependencies
RUN apt-get update &amp;&amp; apt-get install -y \
    libssl-dev \
    ## clean up
    &amp;&amp; apt-get clean \
    &amp;&amp; rm -rf /var/lib/apt/lists/ \
    &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rds

## Install packages from CRAN
RUN install2.r --error \
    -r 'http://cran.rstudio.com' \
        remotes \
        shinyjs \
    ## install Github packages
    &amp;&amp; installGithub.r MarkEdmondson1234/googleCloudRunner \
    ## clean up
    &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rds

## assume shiny app is in build folder /shiny
COPY ./shiny/ /srv/shiny-server/my-app/</code></pre>
<p>Depending on how your ingress is setup, this would appear on your Kubernetes cluster at <code>/my-app/</code> - see this blog post on details for <a href="https://code.markedmondson.me/r-on-kubernetes-serverless-shiny-r-apis-and-scheduled-scripts/">setting up R on Kubernetes</a></p>
</div>
<div id="kubernetes-deployment-file" class="section level3">
<h3 class="hasAnchor">
<a href="#kubernetes-deployment-file" class="anchor"></a>Kubernetes deployment file</h3>
<p>You can then also have a deployment file for Kubernetes that will govern its configuration after the new docker image is built. An example deployment file is below:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">apiVersion:</span><span class="at"> extensions/v1beta1</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="fu">kind:</span><span class="at"> Deployment</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="fu">metadata:</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="fu">name:</span><span class="at"> shiny-your-app</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="fu">spec:</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="fu">replicas:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="fu">selector:</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">    <span class="fu">matchLabels:</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">      <span class="fu">run:</span><span class="at"> shiny-your-app</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  <span class="fu">strategy:</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    <span class="fu">rollingUpdate:</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">      <span class="fu">maxSurge:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">      <span class="fu">maxUnavailable:</span><span class="at"> 1</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    <span class="fu">type:</span><span class="at"> RollingUpdate</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  <span class="fu">template:</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">    <span class="fu">metadata:</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">      <span class="fu">labels:</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">        <span class="fu">run:</span><span class="at"> shiny-your-app</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    <span class="fu">spec:</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">      <span class="fu">nodeSelector:</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">        <span class="fu">cloud.google.com/gke-nodepool:</span><span class="at"> generic-compute-pool</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">      <span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">      <span class="kw"><a href="https://rdrr.io/r/base/Arithmetic.html">-</a></span> <span class="fu">name:</span><span class="at"> varlog</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">        <span class="fu">emptyDir:</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25">      <span class="fu">containers:</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">      <span class="kw"><a href="https://rdrr.io/r/base/Arithmetic.html">-</a></span> <span class="fu">name:</span><span class="at"> shiny-your-app</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27">        <span class="fu">image:</span><span class="at"> gcr.io/your-project/shiny-your-app:latest</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">        <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">        <span class="kw"><a href="https://rdrr.io/r/base/Arithmetic.html">-</a></span> <span class="fu">containerPort:</span><span class="at"> 3838</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">        <span class="fu">volumeMounts:</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31">        <span class="kw"><a href="https://rdrr.io/r/base/Arithmetic.html">-</a></span> <span class="fu">name:</span><span class="at"> varlog</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">          <span class="fu">mountPath:</span><span class="at"> /var/log/shiny-server/</span></a></code></pre></div>
</div>
<div id="cloud-build" class="section level3">
<h3 class="hasAnchor">
<a href="#cloud-build" class="anchor"></a>Cloud Build</h3>
<p>Your cloudbuild steps will then build the Dockerfile, then use <code>gcr.io/cloud-builders/gke-deploy</code> to deploy it to the cluster - see this <a href="https://cloud.google.com/cloud-build/docs/deploying-builds/deploy-gke">Google guide on deployment to GKE via Cloud Build</a> for details</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleCloudRunner)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">bs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="kw"><a href="../reference/cr_buildstep_docker.html">cr_buildstep_docker</a></span>(<span class="st">"shiny-your-app"</span>,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">                      <span class="dt">tag =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"latest"</span>,<span class="st">"$SHORT_SHA"</span>),</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">                      <span class="dt">kaniko_cache =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">  <span class="kw"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"gke-deploy"</span>,</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">               <span class="dt">args =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"run"</span>,</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">                        <span class="st">"--filename=deployment-k8s.yml"</span>,</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">                        <span class="st">"--image=gcr.io/$PROJECT_ID/shiny-your-app:$SHORT_SHA"</span>,</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">                        <span class="st">"--location=europe-west1-b"</span>,</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">                        <span class="st">"--cluster=your-k8s-cluster"</span>))</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">yaml &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(<span class="dt">steps =</span> bs)</a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="kw"><a href="../reference/cr_build_write.html">cr_build_write</a></span>(yaml, <span class="st">"build/cloudbuild.yml"</span>)</a></code></pre></div>
<p>In this example we write the cloudbuild.yml to a build folder rather than making an inline build trigger deployment. This is setup in a Build Trigger upon GitHub commit with the code below:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">repo &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_buildtrigger_repo.html">cr_buildtrigger_repo</a></span>(<span class="st">"your-name/your-repo-with-shiny"</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co"># test build by pushing to git after this trigger made</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw"><a href="../reference/cr_buildtrigger.html">cr_buildtrigger</a></span>(<span class="st">"build/cloudbuild.yml"</span>,</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">                <span class="dt">name =</span> <span class="st">"deploy-my-shiny-app"</span>,</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">                <span class="dt">trigger =</span> repo)</a></code></pre></div>
<p>All together the git repo folder looks like:</p>
<pre><code>|
|- build/
   | - cloudbuild.yml
|- deployment-k8s.yml
|- Dockerfile
|- shiny/
   | - app.R</code></pre>
<p>As you update the code in <code>app.R</code> and push to GitHub, the build trigger builds the Docker image and publishes it to the kubernetes cluster. The docker is built using kaniko cache, which speeds up repeat builds and deployments.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
