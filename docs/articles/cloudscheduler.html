<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scheduled R scripts in the cloud via Cloud Scheduler • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Scheduled R scripts in the cloud via Cloud Scheduler">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.9003</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Scheduled R scripts in the cloud via Cloud Scheduler</h1>
            
      
      
      <div class="hidden name"><code>cloudscheduler.Rmd</code></div>

    </div>

    
    
<p>Cloud Scheduler is a scheduler service in the Google Cloud that uses cron like syntax to schedule tasks. It can trigger HTTP or Pub/Sub jobs via <code><a href="../reference/cr_schedule.html">cr_schedule()</a></code></p>
<p>googleCloudRunner uses Cloud Scheduler to help schedule Cloud Builds.</p>
<p>Cloud Scheduler can schedule HTTP requests to any endpoint:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">cr_scheduler</span>(<span class="dt">name =</span> <span class="st">"my-webhook"</span>, <span class="st">"14 5 * * *"</span>, </a>
<a class="sourceLine" id="cb1-2" data-line-number="2">             <span class="dt">httpTarget =</span> <span class="kw"><a href="../reference/HttpTarget.html">HttpTarget</a></span>(<span class="dt">httpMethod=</span><span class="st">"GET"</span>, <span class="dt">uri =</span> <span class="st">"https://mywebhook.com"</span>))</a></code></pre></div>
<div id="schedule-cloud-build" class="section level2">
<h2 class="hasAnchor">
<a href="#schedule-cloud-build" class="anchor"></a>Schedule Cloud Build</h2>
<p>As Cloud Build can run any code in a container, it becomes a powerful way to setup data flows. These can be scheduled via Cloud Scheduler.</p>
<p>A demo below shows how to set up a Cloud Build on a schedule from R:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">build1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(<span class="st">"cloudbuild.yaml"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"15 5 * * *"</span>, <span class="dt">name=</span><span class="st">"cloud-build-test1"</span>,</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">             <span class="dt">httpTarget =</span> <span class="kw"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(build1))</a></code></pre></div>
<p>We use <code><a href="../reference/cr_build_make.html">cr_build_make()</a></code> and <code><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http()</a></code> to create the Cloud Build API request, and then send that to the Cloud Scheduler API via its <code>httpTarget</code> parameter.</p>
<p>Update a schedule by specifying the same name and the <code>overwrite=TRUE</code> flag. You need then need to supply what you want to change, everything else will remain as previously configured.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"my-webhook"</span>, <span class="st">"12 6 * * *"</span>, <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="schedule-an-r-script" class="section level2">
<h2 class="hasAnchor">
<a href="#schedule-an-r-script" class="anchor"></a>Schedule an R script</h2>
<p>A common use case is scheduling an R script. This is provided by <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># this can be an R filepath or lines of R read in from a script</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">r_lines &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"list.files()"</span>,</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">              <span class="st">"library(dplyr)"</span>,</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">              <span class="st">"mtcars %&gt;% select(mpg)"</span>,</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">              <span class="st">"sessionInfo()"</span>)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co"># example code runs against a source that is a mirrored GitHub repo</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">source &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_build_source.html">cr_build_source</a></span>(<span class="kw"><a href="../reference/RepoSource.html">RepoSource</a></span>(<span class="st">"googleCloudStorageR"</span>,</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">                                      <span class="dt">branchName =</span> <span class="st">"master"</span>))</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co"># check the script runs ok</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span>(r_lines, <span class="dt">source =</span> source)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co"># schedule the script once its working</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="kw"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span>(r_lines, <span class="dt">schedule =</span> <span class="st">"15 21 * * *"</span>, <span class="dt">source =</span> source)</a></code></pre></div>
<p>You may want to customise the R docker image you run code from - in this case build your docker image first with your R libraries installed, then specify that image in your R deployment:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span>(<span class="st">"my_folder_with_dockerfile"</span>, </a>
<a class="sourceLine" id="cb5-2" data-line-number="2">                 <span class="dt">image_name =</span> <span class="st">"gcr.io/my-project/my-image"</span>,</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">                 <span class="dt">tag =</span> <span class="st">"dev"</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span>(r_lines, </a>
<a class="sourceLine" id="cb5-6" data-line-number="6">            <span class="dt">schedule =</span> <span class="st">"15 21 * * *"</span>, </a>
<a class="sourceLine" id="cb5-7" data-line-number="7">            <span class="dt">source =</span> source,</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">            <span class="dt">r_image =</span> <span class="st">"gcr.io/my-project/my-image:dev"</span>)</a></code></pre></div>
</div>
<div id="build-and-schedule-an-r-script-custom" class="section level2">
<h2 class="hasAnchor">
<a href="#build-and-schedule-an-r-script-custom" class="anchor"></a>Build and schedule an R script (custom)</h2>
<p>If you want to customise deployments, then the steps covered by <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> are covered below.</p>
<p>To schedue an R script the steps are:</p>
<ol style="list-style-type: decimal">
<li>Create your R script</li>
<li>Select or build an R enabled Dockerfile to run the R code</li>
<li>Build the Docker image on Cloud Build and push to “gcr.io/your-project/your-name”</li>
<li>Schedule calling the Docker image using Cloud Scheduler</li>
</ol>
<div id="create-your-r-script" class="section level3">
<h3 class="hasAnchor">
<a href="#create-your-r-script" class="anchor"></a>1. Create your R script</h3>
<p>The R script can hold anything, but make sure its is self contained with auth files, data files etc. All paths should be relative to the script. Uploading auth files within Dockerfiles is not recommended security wise. The recommend way to download auth files is to use the GKE encryption service, which is available as a build step macro via <code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code></p>
</div>
<div id="bundle-the-r-script-with-a-dockerfile" class="section level3">
<h3 class="hasAnchor">
<a href="#bundle-the-r-script-with-a-dockerfile" class="anchor"></a>2. Bundle the R script with a Dockerfile</h3>
<p>You can create your own Dockerfile or you can attempt auto-creating your Dockerfile via <a href="https://github.com/o2r-project/containerit"><code>containerit</code></a> - point it at the folder with your script:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># should produce a Dockerfile you can then use for deployment</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw"><a href="../reference/cr_dockerfile.html">cr_dockerfile</a></span>(<span class="st">"my-scripts/deploy_me/"</span>)</a></code></pre></div>
<p>The <code>cr_deploy_*</code> functions call <code><a href="../reference/cr_dockerfile.html">cr_dockerfile()</a></code> if no Dockerfile is supplied in an attempt to create one automatically themselves.</p>
</div>
<div id="build-the-docker-image-on-cloud-build" class="section level3">
<h3 class="hasAnchor">
<a href="#build-the-docker-image-on-cloud-build" class="anchor"></a>3. Build the Docker image on Cloud Build</h3>
<p>Once you have your R script and Dockerfile in the same folder, you need to build the image.</p>
<p>For this example we first build the Docker image that will be used day to day in the schedule.</p>
<p>This can be automated via the <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> function supplying the folder containing the Dockerfile - or if no Dockerfile is present it will attempt to create one via <code><a href="../reference/cr_dockerfile.html">cr_dockerfile()</a></code></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span>(<span class="st">"my-scripts/"</span>, <span class="st">"gcr.io/your-project/your-name"</span>)</a></code></pre></div>
</div>
<div id="schedule-calling-the-docker-image-using-cloud-scheduler" class="section level3">
<h3 class="hasAnchor">
<a href="#schedule-calling-the-docker-image-using-cloud-scheduler" class="anchor"></a>4. Schedule calling the Docker image using Cloud Scheduler</h3>
<p>Once the image is build successfully, you do not need to build it again for the scheduled calls. For that, you will only need the image you build <code>gcr.io/your-project/your-name</code> and call it via the arguments set up in the Dockerfile i.e. <code>R -e my_r_script.R</code></p>
<pre><code>schedule_me &lt;- Yaml(
  steps = cr_build_step("your-name", "R -e my_r_script.R",
                         prefix="gcr.io/your-project")
                         )
# test your build works
schedule_build &lt;- cr_build(schedule_me)

# you can feed the Build result back to the scheduler
cloud_build_target &lt;- cr_build_schedule_http(schedule_build)

# schedule it
cr_schedule("15 5 * * *", name="scheduled_r",
             httpTarget = cloud_build_target)
</code></pre>
<p>Your R script should now be scheduled and running in its own environment.</p>
<p>You can automate updates to the script and/or Docker container or schedule separately, by redoing any of the steps above.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#schedule-cloud-build">Schedule Cloud Build</a></li>
      <li><a href="#schedule-an-r-script">Schedule an R script</a></li>
      <li><a href="#build-and-schedule-an-r-script-custom">Build and schedule an R script (custom)</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
