<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scheduled R scripts via Cloud Scheduler • googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Scheduled R scripts via Cloud Scheduler">
<meta property="og:description" content="googleCloudRunner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Scheduled R scripts via Cloud Scheduler</h1>
            
            <h4 class="date">2020-04-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MarkEdmondson1234/googleCloudRunner/blob/master/vignettes/cloudscheduler.Rmd"><code>vignettes/cloudscheduler.Rmd</code></a></small>
      <div class="hidden name"><code>cloudscheduler.Rmd</code></div>

    </div>

    
    
<p><a href="https://cloud.google.com/scheduler/">Cloud Scheduler</a> is a scheduler service in the Google Cloud that uses cron like syntax to schedule tasks. It can trigger HTTP or Pub/Sub jobs via <code><a href="../reference/cr_schedule.html">cr_schedule()</a></code></p>
<p><code>googleCloudRunner</code> uses Cloud Scheduler to help schedule Cloud Builds but Cloud Scheduler can schedule HTTP requests to any endpoint:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu">cr_scheduler</span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"my-webhook"</span>, <span class="st">"14 5 * * *"</span>,
             <span class="kw">httpTarget</span> <span class="kw">=</span> <span class="fu"><a href="../reference/HttpTarget.html">HttpTarget</a></span>(<span class="kw">httpMethod</span><span class="kw">=</span><span class="st">"GET"</span>, <span class="kw">uri</span> <span class="kw">=</span> <span class="st">"https://mywebhook.com"</span>))</pre></body></html></div>
<div id="schedule-cloud-build" class="section level2">
<h2 class="hasAnchor">
<a href="#schedule-cloud-build" class="anchor"></a>Schedule Cloud Build</h2>
<p>Since Cloud Build can run any code in a container, scheduling them becomes a powerful way to setup batched data flows.</p>
<p>A demo below shows how to set up a Cloud Build on a schedule from R:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">build1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(<span class="st">"cloudbuild.yaml"</span>)

<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"15 5 * * *"</span>, <span class="kw">name</span><span class="kw">=</span><span class="st">"cloud-build-test1"</span>,
             <span class="kw">httpTarget</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(<span class="no">build1</span>))</pre></body></html></div>
<p>We use <code><a href="../reference/cr_build_make.html">cr_build_make()</a></code> and <code><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http()</a></code> to create the Cloud Build API request, and then send that to the Cloud Scheduler API via its <code>httpTarget</code> parameter.</p>
<p>Update a schedule by specifying the same name and the <code>overwrite=TRUE</code> flag. You need then need to supply what you want to change, everything else will remain as previously configured.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"my-webhook"</span>, <span class="st">"12 6 * * *"</span>, <span class="kw">overwrite</span><span class="kw">=</span><span class="fl">TRUE</span>)</pre></body></html></div>
</div>
<div id="schedule-an-r-script" class="section level2">
<h2 class="hasAnchor">
<a href="#schedule-an-r-script" class="anchor"></a>Schedule an R script</h2>
<p>A common use case is scheduling an R script. This is provided by <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code></p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># this can be an R filepath or lines of R read in from a script</span>
<span class="no">r_lines</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"list.files()"</span>,
              <span class="st">"library(dplyr)"</span>,
              <span class="st">"mtcars %&gt;% select(mpg)"</span>,
              <span class="st">"sessionInfo()"</span>)

<span class="co"># example code runs against a source that is a mirrored GitHub repo</span>
<span class="no">source</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span>(<span class="fu"><a href="../reference/RepoSource.html">RepoSource</a></span>(<span class="st">"googleCloudStorageR"</span>,
                                      <span class="kw">branchName</span> <span class="kw">=</span> <span class="st">"master"</span>))

<span class="co"># check the script runs ok</span>
<span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span>(<span class="no">r_lines</span>, <span class="kw">source</span> <span class="kw">=</span> <span class="no">source</span>)

<span class="co"># schedule the script once its working</span>
<span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span>(<span class="no">r_lines</span>, <span class="kw">schedule</span> <span class="kw">=</span> <span class="st">"15 21 * * *"</span>, <span class="kw">source</span> <span class="kw">=</span> <span class="no">source</span>)</pre></body></html></div>
<p>You may want to customise the R docker image you run code from - in this case build your docker image first with your R libraries installed, then specify that image in your R deployment:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span>(<span class="st">"my_folder_with_dockerfile"</span>,
                 <span class="kw">image_name</span> <span class="kw">=</span> <span class="st">"gcr.io/my-project/my-image"</span>,
                 <span class="kw">tag</span> <span class="kw">=</span> <span class="st">"dev"</span>)

<span class="fu"><a href="../reference/cr_deploy_r.html">cr_deploy_r</a></span>(<span class="no">r_lines</span>,
            <span class="kw">schedule</span> <span class="kw">=</span> <span class="st">"15 21 * * *"</span>,
            <span class="kw">source</span> <span class="kw">=</span> <span class="no">source</span>,
            <span class="kw">r_image</span> <span class="kw">=</span> <span class="st">"gcr.io/my-project/my-image:dev"</span>)</pre></body></html></div>
<p>The logs of the scheduled scripts are in the history section of Cloud Build - each scheduled run is creating a new Cloud Build.</p>
<div id="rstudio-gadget---schedule-r-scripts" class="section level3">
<h3 class="hasAnchor">
<a href="#rstudio-gadget---schedule-r-scripts" class="anchor"></a>RStudio Gadget - schedule R scripts</h3>
<p>If you are using RStudio, installing the library will enable an <a href="https://rstudio.github.io/rstudioaddins/">RStudio Addin</a> that can be called after you have setup the library as per the setup page.</p>
<p>It includes a Shiny gadget that you can call via the Addin menu in RStudio, via <code><a href="../reference/cr_deploy_gadget.html">googleCloudRunner::cr_deploy_gadget()</a></code> or assigned to a hotkey (I use CTRL+SHIFT+D).</p>
<p>This sets up a Shiny UI to help smooth out deployments as pictured:</p>
<p><img src="gadget_r.png"></p>
</div>
</div>
<div id="build-and-schedule-an-r-script-custom" class="section level2">
<h2 class="hasAnchor">
<a href="#build-and-schedule-an-r-script-custom" class="anchor"></a>Build and schedule an R script (custom)</h2>
<p>If you want to customise deployments, then the steps covered by <code><a href="../reference/cr_deploy_r.html">cr_deploy_r()</a></code> are covered below.</p>
<p>To schedule an R script the steps are:</p>
<ol style="list-style-type: decimal">
<li>Create your R script</li>
<li>Select or build an R enabled Dockerfile to run the R code</li>
<li>[optional] Build the R image</li>
<li>Select a source location that the R code will run upon</li>
<li>Schedule calling the Docker image using Cloud Scheduler</li>
</ol>
<div id="create-your-r-script" class="section level3">
<h3 class="hasAnchor">
<a href="#create-your-r-script" class="anchor"></a>1. Create your R script</h3>
<p>The R script can hold anything, but make sure its is self contained with auth files, data files etc. All paths should be relative to the script and available in the source you choose to build with (e.g. GCS or git repo) or within the Docker image executing R.</p>
<p>Uploading auth files within Dockerfiles is not recommended security wise. The recommend way to download auth files is to use the GKE encryption service, which is available as a build step macro via <code><a href="../reference/cr_buildstep_decrypt.html">cr_buildstep_decrypt()</a></code></p>
</div>
<div id="bundle-the-r-script-with-a-dockerfile" class="section level3">
<h3 class="hasAnchor">
<a href="#bundle-the-r-script-with-a-dockerfile" class="anchor"></a>2. Bundle the R script with a Dockerfile</h3>
<p>You may only need vanilla r or tidyverse, in which case select the presets “rocker/r-ver” or “rocker/verse”.</p>
<p>You can also create your own Docker image - point it at the folder with your script and a Dockerfile (perhaps created with <code>cr_dockerfile()</code>)</p>
</div>
<div id="build-the-docker-image-on-cloud-build" class="section level3">
<h3 class="hasAnchor">
<a href="#build-the-docker-image-on-cloud-build" class="anchor"></a>3. Build the Docker image on Cloud Build</h3>
<p>Once you have your R script and Dockerfile in the same folder, you need to build the image.</p>
<p>This can be automated via the <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code> function supplying the folder containing the Dockerfile:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span>(<span class="st">"my-scripts/"</span>, <span class="st">"gcr.io/your-project/your-name"</span>)</pre></body></html></div>
<p>Once the image is built successfully, you do not need to build it again for the scheduled calls - you could setup doing that only if the R code changes.</p>
</div>
<div id="make-the-build-and-optional-source" class="section level3">
<h3 class="hasAnchor">
<a href="#make-the-build-and-optional-source" class="anchor"></a>4. Make the build and optional source</h3>
<p>You may want your R code to operate on data in Google Cloud Storage or a git repo. Specify that source in your build, then make the build object:</p>
<div id="repo-source" class="section level4">
<h4 class="hasAnchor">
<a href="#repo-source" class="anchor"></a>Repo Source</h4>
<p>This is if you have your code files within a repo like GitHub and mirrored to Cloud Source repositories.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">schedule_me</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(
  <span class="kw">steps</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"your-r-image"</span>,
                       <span class="st">"R -e my_r_script.R"</span>,
                       <span class="kw">prefix</span><span class="kw">=</span><span class="st">"gcr.io/your-project"</span>)
                      )

<span class="co"># maybe you want a repo source</span>
<span class="no">repo_source</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_source.html">cr_build_source</a></span>(
  <span class="fu"><a href="../reference/RepoSource.html">RepoSource</a></span>(<span class="st">"MarkEdmondson1234/googleCloudRunner"</span>,
             <span class="kw">branchName</span><span class="kw">=</span><span class="st">"master"</span>))

<span class="no">my_build</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(<span class="no">schedule_me</span>, <span class="kw">source</span> <span class="kw">=</span> <span class="no">repo_source</span>)</pre></body></html></div>
</div>
<div id="cloud-storage-source" class="section level4">
<h4 class="hasAnchor">
<a href="#cloud-storage-source" class="anchor"></a>Cloud Storage Source</h4>
<p>This keeps your R code source in a Cloud Storage bucket.</p>
<p>The first method uses a tar.gz that has zipped files in a folder that you upload:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">schedule_me</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(
  <span class="kw">steps</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"your-r-image"</span>,
                       <span class="st">"R -e my_r_script.R"</span>,
                        <span class="kw">prefix</span><span class="kw">=</span><span class="st">"gcr.io/your-project"</span>)
  )

<span class="co"># upload a tar.gz of the files to use as a source:</span>
<span class="no">gcs_source</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_upload_gcs.html">cr_build_upload_gcs</a></span>(<span class="st">"local_folder_with_r_script"</span>)
<span class="no">my_build</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(<span class="no">schedule_me</span>, <span class="kw">source</span> <span class="kw">=</span> <span class="no">gcs_source</span>)</pre></body></html></div>
<p>When only a few files, it may be easiest to include downloading the R file from your bucket first into the /workspace/ via a buildstep using <a href="https://cloud.google.com/storage/docs/gsutil">gsutil</a>, not using source at all:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">schedule_me</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_yaml.html">cr_build_yaml</a></span>(
  <span class="kw">steps</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(
      <span class="kw">id</span> <span class="kw">=</span> <span class="st">"download R file"</span>,
      <span class="kw">name</span> <span class="kw">=</span> <span class="st">"gsutil"</span>,
      <span class="kw">args</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cp"</span>,
               <span class="st">"gs://mark-edmondson-public-read/my_r_script.R"</span>,
               <span class="st">"/workspace/my_r_script.R"</span>)
    ),
    <span class="fu"><a href="../reference/cr_buildstep.html">cr_buildstep</a></span>(<span class="st">"your-r-image"</span>,
                 <span class="st">"R -e /workspace/my_r_script.R"</span>,
                 <span class="kw">prefix</span><span class="kw">=</span><span class="st">"gcr.io/your-project"</span>)
            )
    )

<span class="no">my_build</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_make.html">cr_build_make</a></span>(<span class="no">schedule_me</span>)</pre></body></html></div>
</div>
</div>
<div id="testing" class="section level3">
<h3 class="hasAnchor">
<a href="#testing" class="anchor"></a>Testing</h3>
<p>You may want to test the build works with a one off build first:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co"># test your build works</span>
<span class="no">schedule_build</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build.html">cr_build</a></span>(<span class="no">my_build</span>)</pre></body></html></div>
</div>
<div id="schedule-calling-the-docker-image-using-cloud-scheduler" class="section level3">
<h3 class="hasAnchor">
<a href="#schedule-calling-the-docker-image-using-cloud-scheduler" class="anchor"></a>5. Schedule calling the Docker image using Cloud Scheduler</h3>
<p>Once you have a working build, schedule that build object by passing it to the <code><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http()</a></code> function, which constructs the Cloud Build API call for Cloud Scheduler to call at its scheduled times.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co"># you can feed the Build result back to the scheduler</span>
<span class="no">cloud_build_target</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/cr_build_schedule_http.html">cr_build_schedule_http</a></span>(<span class="no">schedule_build</span>)

<span class="co"># schedule it</span>
<span class="fu"><a href="../reference/cr_schedule.html">cr_schedule</a></span>(<span class="st">"15 5 * * *"</span>, <span class="kw">name</span><span class="kw">=</span><span class="st">"scheduled_r"</span>,
             <span class="kw">httpTarget</span> <span class="kw">=</span> <span class="no">cloud_build_target</span>)</pre></body></html></div>
<p>Your R script should now be scheduled and running in its own environment.</p>
<p>You can automate updates to the script and/or Docker container or schedule separately, by redoing the relevant step above, perhaps adding a <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudbuild.html#build-triggers">build trigger</a> to do so.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
