<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R on Cloud Run â€¢ googleCloudRunner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R on Cloud Run">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-47480439-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-47480439-2');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">googleCloudRunner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.9003</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/setup.html">
    <span class="fa fa-wrench"></span>
     
    Setup
  </a>
</li>
<li>
  <a href="../articles/cloudrun.html">
    <span class="fa fa-running"></span>
     
    Cloud Run
  </a>
</li>
<li>
  <a href="../articles/cloudbuild.html">
    <span class="fa fa-shapes"></span>
     
    Cloud Build
  </a>
</li>
<li>
  <a href="../articles/cloudscheduler.html">
    <span class="fa fa-clock"></span>
     
    Cloud Scheduler
  </a>
</li>
<li>
  <a href="../articles/usecases.html">
    <span class="fa fa-hands-helping"></span>
     
    Use Cases
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-question"></span>
     
    Functions
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>R on Cloud Run</h1>
            
      
      
      <div class="hidden name"><code>cloudrun.Rmd</code></div>

    </div>

    
    
<p><a href="https://cloud.run">Cloud Run</a> is a service that lets you deploy container images without worrying about the underlying servers or infrastructure. It is called with <code><a href="../reference/cr_run.html">cr_run()</a></code>, or you can automate a deployment via <code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code>.</p>
<p>If you would like to have your R code react in realtime to events such as HTTP or sub/sub events, such as a website or API endpoint, Cloud Run is a good fit.</p>
<p>If you want to run scripts that can be triggered one time, setup to trigger on GitHub events or pub/sub, or scheduled using Cloud Scheduler then <a href="https://code.markedmondson.me/googleCloudRunner/articles/cloudbuild.html">Cloud Build</a> is suited to your use case.</p>
<div id="quickstart---plumber-api" class="section level2">
<h2 class="hasAnchor">
<a href="#quickstart---plumber-api" class="anchor"></a>Quickstart - plumber API</h2>
<ol style="list-style-type: decimal">
<li>Make an R API via <a href="https://www.rplumber.io/">plumber</a> that contains entry file api.R. You can use the demo example in <code><a href="https://rdrr.io/r/base/system.file.html">system.file("example", package="cloudRunner")</a></code> if you like.</li>
<li>Deploy via the <code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code> function:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(googleCloudRunner)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">cr &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cr_deploy_run.html">cr_deploy_run</a></span>(<span class="st">"api.R"</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#2019-11-12 10:34:29 -- File size detected as 903 bytes</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#2019-11-12 10:34:31&gt; Cloud Build started - logs: </span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#https://console.cloud.google.com/gcr/builds/40343fd4-6981-41c3-98c8-f5973c3de386?project=1080525199262</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#Waiting for build to finish:</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co"># |===============||</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co">#Build finished</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co">#2019-11-12 10:35:43&gt; Deployed to Cloud Run at: </span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co">#https://cloudrunnertest2-ewjogewawq-ew.a.run.app</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co">#==CloudRunService==</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co">#name:  cloudrunnertest2 </span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co">#location:  europe-west1 </span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co">#lastModifier:  1080525199262@cloudbuild.gserviceaccount.com </span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co">#containers:  gcr.io/mark-edmondson-gde/cloudrunnertest2 </span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co">#creationTimestamp:  2019-11-12T10:35:19.993128Z </span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="co">#observedGeneration:  1 </span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="co">#url:  https://cloudrunnertest2-ewjogewawq-ew.a.run.app </span></a></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Enjoy your API</li>
</ol>
<div id="what-did-it-do" class="section level3">
<h3 class="hasAnchor">
<a href="#what-did-it-do" class="anchor"></a>What did it do?</h3>
<p>Deployment via <code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code> automated these steps:</p>
<ol style="list-style-type: decimal">
<li>Creates a Dockerfile for your R script if necessary using <a href="https://o2r.info/containerit/index.html"><code>containerit</code></a>
</li>
<li>Uploads the Dockerfile and your api.R file to your Google Cloud Storage bucket</li>
<li>Creates a Cloud Build job for building the files uploaded to the GCS bucket, and pushes the Docker images to Google Container Registry</li>
<li>Deploys that container to Cloud Run</li>
</ol>
<p>It will launch a browser showing the build on Cloud Build, or you can wait for progress in your local R sesion. Upon successfully deployment it gives you a <code>CloudRunService</code> object with details of the deployment.</p>
<p>All the above stages can be customised for your own purposes, using the functions explained below.</p>
</div>
</div>
<div id="customising-cloud-run-deployments" class="section level2">
<h2 class="hasAnchor">
<a href="#customising-cloud-run-deployments" class="anchor"></a>Customising Cloud Run deployments</h2>
<p>The Cloud Run API is not called directly when deploying - instead a Cloud Build is created for deployment. <code>cr_run</code> creates a cloudbuild.yaml similar to the below:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># use cloud build to deploy</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">image &lt;- <span class="st">"gcr.io/my-project/my-image"</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">cr_build_yaml(</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    steps = list(</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">      cr_buildstep_docker(<span class="st">"my-image"</span>),</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">      cr_buildstep(<span class="st">"gcloud"</span>, c(<span class="st">"beta"</span>,<span class="st">"run"</span>,<span class="st">"deploy"</span>, <span class="st">"my-name"</span>,</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">           <span class="st">"--image"</span>, image,</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">           <span class="st">"--region"</span>, <span class="st">"europe-west1"</span>,</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">           <span class="st">"--platform"</span>, <span class="st">"managed"</span>,</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">           <span class="st">"--concurrency"</span>, 1,</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">           <span class="st">"--allow-unauthenticated"</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">         ))</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">    ),</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    images = image</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  )</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co"># ==cloudRunnerYaml==</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co"># steps:</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co"># - name: gcr.io/cloud-builders/docker</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#   args:</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#   - build</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co">#   - -t</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co">#   - gcr.io/my-project/my-image</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co">#   - '.'</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co">#   dir: deploy</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="co"># - name: gcr.io/cloud-builders/docker</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26"><span class="co">#   args:</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="co">#   - push</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"><span class="co">#   - gcr.io/my-project/my-image</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="co">#   dir: deploy</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30"><span class="co"># - name: gcr.io/cloud-builders/gcloud</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"><span class="co">#   args:</span></a>
<a class="sourceLine" id="cb2-32" data-line-number="32"><span class="co">#   - beta</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33"><span class="co">#   - run</span></a>
<a class="sourceLine" id="cb2-34" data-line-number="34"><span class="co">#   - deploy</span></a>
<a class="sourceLine" id="cb2-35" data-line-number="35"><span class="co">#   - my-name</span></a>
<a class="sourceLine" id="cb2-36" data-line-number="36"><span class="co">#   - --image</span></a>
<a class="sourceLine" id="cb2-37" data-line-number="37"><span class="co">#   - gcr.io/my-project/my-image</span></a>
<a class="sourceLine" id="cb2-38" data-line-number="38"><span class="co">#   - --region</span></a>
<a class="sourceLine" id="cb2-39" data-line-number="39"><span class="co">#   - europe-west1</span></a>
<a class="sourceLine" id="cb2-40" data-line-number="40"><span class="co">#   - --platform</span></a>
<a class="sourceLine" id="cb2-41" data-line-number="41"><span class="co">#   - managed</span></a>
<a class="sourceLine" id="cb2-42" data-line-number="42"><span class="co">#   - --concurrency</span></a>
<a class="sourceLine" id="cb2-43" data-line-number="43"><span class="co">#   - '1'</span></a>
<a class="sourceLine" id="cb2-44" data-line-number="44"><span class="co">#   - --allow-unauthenticated</span></a>
<a class="sourceLine" id="cb2-45" data-line-number="45"><span class="co">#   dir: deploy</span></a>
<a class="sourceLine" id="cb2-46" data-line-number="46"><span class="co"># images: gcr.io/my-project/my-image</span></a></code></pre></div>
<p>If you have an existing image you want to deploy on Cloud Run (usually one that serves up HTTP content, such as via <code><a href="https://rdrr.io/r/base/library.html">library(plumber)</a></code>) then you only need to supply that image to deploy:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/cr_run.html">cr_run</a></span>(<span class="st">"gcr.io/my-project/my-image"</span>)</a></code></pre></div>
<p>However, if you want to do the common use case of building the container first as well, you can do so by using the helper <code><a href="../reference/cr_deploy_docker.html">cr_deploy_docker()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/cr_deploy_docker.html">cr_deploy_docker</a></span>(<span class="st">"my-image"</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw"><a href="../reference/cr_run.html">cr_run</a></span>(<span class="st">"gcr.io/my-project/my-image"</span>)</a></code></pre></div>
<p><code><a href="../reference/cr_deploy_run.html">cr_deploy_run()</a></code> wraps the above in functions to check and wait for status etc. and is intended as the main method of Cloud Run deployment, but you may want to tweak the settings more by calling <code><a href="../reference/cr_run.html">cr_run()</a></code> directly.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#quickstart---plumber-api">Quickstart - plumber API</a></li>
      <li><a href="#customising-cloud-run-deployments">Customising Cloud Run deployments</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mark Edmondson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
